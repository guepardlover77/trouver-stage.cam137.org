{"version":3,"mappings":"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","names":["reactive","target","options","subscribers","handler","obj","prop","value","oldValue","result","subscriber","proxy","batchQueue","isBatching","batch","fn","queued","promisifyRequest","request","resolve","reject","createStore","dbName","storeName","dbp","getDB","db","txMode","callback","defaultGetStoreFunc","defaultGetStore","get","key","customStore","store","STORAGE_KEY","STORAGE_VERSION","NOTES_STORE_KEY","persistState","state","data","error","loadPersistedState","stored","migrateState","notes","loadNotesFromIndexedDB","oldData","sessionCache","setSessionCache","ttlMs","getSessionCache","cached","initialFilters","initialSortOptions","initialState","eventListeners","emit","type","payload","listeners","listener","on","setLocations","locations","_","i","l","buildSearchIndex","location","index","searchableText","updateFilters","newFilters","applyFiltersAndSort","filters","sortOptions","searchIndex","favorites","userLocation","searchNormalized","indices","niveau","parseNiveau","refPoint","haversineDistance","id","generateLocationId","a","b","locA","locB","comparison","niveauA","niveauB","distA","distB","match","lat1","lon1","lat2","lon2","dLat","toRad","dLon","deg","toggleFavorite","locationId","persistCurrentState","setTheme","theme","applyTheme","root","prefersDark","updateMapView","center","zoom","initializeStore","persisted","debounce","delay","timeoutId","args","normalizeText","text","formatDateFR","date","generateFileName","prefix","extension","timestamp","generateId","API_BASE_URL","apiToFrontend","apiLoc","frontendToApi","loc","getHeaders","fetchLocations","response","createLocation","updateLocationApi","updates","apiUpdates","deleteLocation","isApiAvailable","useApi","loadData","getAllLocations","addLocation","created","apiCreateLocation","updateLocation","removeLocation","apiDeleteLocation","locationExists","nom","ville","nomNormalized","villeNormalized","findSimilarLocations","results","locNomNormalized","ICONS","LABELS","button","dropdown","isDropdownOpen","createThemeToggle","container","updateButton","wrapper","toggleDropdown","option","selectTheme","closeDropdown","e","currentTheme","isActive","openDropdown","activeOption","metaThemeColor","effectiveTheme","initTheme","toasts","initContainer","show","config","cont","duration","element","escapeHtml","closeBtn","dismiss","actionBtn","timeout","oldestId","toast","div","initToastContainer","showToast","EARTH_RADIUS_KM","toRadians","degrees","c","formatDistance","distanceKm","map","markersLayer","heatmapLayer","markers","MARKER_COLORS","createMarkerIcon","color","isMatching","isFavorite","isSelected","iconColor","createPopupContent","isFav","note","userLoc","distanceInfo","dist","initMap","cluster","count","matchingCount","favoriteCount","types","marker","clusterIndex","idx","_a","m","sizeClass","size","matchRatio","colorClass","favIndicator","cities","topCities","city","n","topTypes","tooltipContent","debouncedMapMove","content","btn","event","lat","lon","name","url","setupStoreListeners","refreshMarkers","fitToMarkers","updateMarkerStyles","focusOnMarker","filteredIndices","filteredSet","icon","selectedLocationIndex","openPopup","latLng","padding","points","bounds","toggleHeatmap","enabled","heatData","invalidateSize","ADMIN_CODE_KEY","SESSION_KEY","DEFAULT_CODE","hashCode","str","hash","char","ensureCodeExists","isAuthenticated","verifyCode","code","storedHash","authenticate","logout","changeCode","oldCode","newCode","createAuthModal","onSuccess","modal","input","toggleBtn","errorEl","cancelBtn","submitBtn","isPassword","validate","requireAuth","createChangeCodeForm","oldInput","newInput","confirmInput","messageEl","confirmCode","BAN_API_URL","NOMINATIM_API_URL","geocodeAddress","adresse","codePostal","cacheKey","banResult","geocodeWithBAN","nominatimResult","geocodeWithNominatim","query","feature","score","importance","autocompleteAddress","createLocationForm","onSave","onCancel","isEdit","t","form","typeSelect","typeAutre","geocodeBtn","geocodeResult","nomInput","villeInput","duplicatesWarning","duplicatesList","adresseInput","autocompleteList","autocompleteSpinner","coordsSection","latInput","lonInput","codePostalInput","currentSuggestions","selectedIndex","showAutocompleteList","hideAutocompleteList","updateAutocompleteList","suggestions","s","selectSuggestion","suggestion","parts","lastPart","cpMatch","updateCoordsWithAnimation","searchAutocomplete","items","item","checkDuplicates","similar","filtered","validateField","field","errorId","validator","telephoneInput","emailInput","valid","v","typeValue","newLocation","createLocationList","onEdit","onDelete","onLocate","render","searchLower","aVal","bVal","cmp","totalPages","startIdx","pageItems","getSortIcon","hasCoords","truncate","searchInput","th","selectAllCheck","check","tr","bulkDeleteBtn","_b","_c","prevBtn","nextBtn","max","COLUMN_PATTERNS","createImportPanel","onImport","parsedData","mapping","createEmptyMapping","importSettings","renderDropZone","setupDropZone","dropzone","fileInput","files","handleFile","file","ext","parseCSV","parseExcel","autoMapColumns","renderPreview","previewRows","totalRows","renderMappingSelects","h","isMapped","getMappedField","row","cell","isValidMapping","setupPreviewEvents","label","required","select","skipDuplicates","autoGeocode","startImport","imported","skipped","errors","progressFill","progressText","progressStatus","percent","rowToLocation","geo","renderResults","getCell","parseCoord","num","colIndex","lines","line","delimiter","parseRow","cells","current","inQuotes","headers","rows","XLSX","__vitePreload","arrayBuffer","workbook","sheetName","sheet","header","normalized","patterns","pattern","NAF_TYPES","DEPARTMENTS","getDepartments","getNafCodesByDomain","domain","restauration","hotellerie","commerce","production","nafToType","nafCode","searchSirene","params","departement","commune","codeNaf","raisonSociale","limit","baseUrl","entreprise","etablissements","etab","activiteCode","activiteFormatee","adresseParts","codePostalIndex","p","createInseeSearchPanel","onAdd","departments","d","deptSelect","domainSelect","cityInput","limitSelect","searchBtn","resultsSection","resultsCount","resultsList","loadingSection","emptySection","addAllBtn","currentResults","addResult","added","currentTab","editingIndex","modalElement","openAdminPanel","createAdminModal","closeAdminPanel","tab","newTab","switchTab","handleKeydown","renderTab","renderAddTab","renderInseeTab","renderImportTab","renderManageTab","renderSettingsTab","locationToEdit","syncStore","changeCodeContainer","json","blob","renderStats","totalLocations","geolocated","uniqueCities","uniqueTypes","initApp","createAppLayout","loadDataAndInitialize","setupGlobalEvents","hideLoadingOverlay","headerRight","themeContainer","mapContainer","updateLoadingState","updateResultsCount","renderResultsList","highlightResult","closeAllModals","isInputFocused","setupLegacyIntegration","adminBtn","exportCSV","exportJSON","exportPDF","exportAsCsv","exportAsJson","exportAsPdf","resetBtn","domaineFilter","niveauFilter","populateDomainFilter","selectedDomain","selectedNiveau","countEl","total","span","listEl","maxResults","displayIndices","html","levelColor","getLevelColor","moreEl","el","level","loadingText","overlay","adminModal","authModal","active"],"ignoreList":[1],"sources":["../../src/store/reactivity.ts","../../node_modules/idb-keyval/dist/index.js","../../src/services/storage.service.ts","../../src/store/index.ts","../../src/utils/helpers.ts","../../src/services/api.service.ts","../../src/services/data.service.ts","../../src/components/UI/ThemeToggle.ts","../../src/components/UI/Toast.ts","../../src/utils/distance.ts","../../src/components/Map/Map.ts","../../src/components/Admin/AdminAuth.ts","../../src/services/geocoding.service.ts","../../src/components/Admin/LocationForm.ts","../../src/components/Admin/LocationList.ts","../../src/components/Admin/ImportPanel.ts","../../src/services/insee.service.ts","../../src/components/Admin/InseeSearchPanel.ts","../../src/components/Admin/AdminPanel.ts","../../src/main.ts"],"sourcesContent":["// ============================================================================\n// Systme de ractivit simple bas sur Proxy\n// ============================================================================\n\ntype Subscriber<T> = (newValue: T, oldValue: T, path: string) => void;\n\ninterface ReactiveOptions {\n  deep?: boolean;\n}\n\n/**\n * Cre un objet ractif qui notifie les subscribers lors des changements\n */\nexport function reactive<T extends object>(\n  target: T,\n  options: ReactiveOptions = { deep: true }\n): T {\n  const subscribers = new Set<Subscriber<any>>();\n\n  const handler: ProxyHandler<T> = {\n    get(obj: T, prop: string | symbol): any {\n      const value = Reflect.get(obj, prop);\n\n      // Rendre rcursivement ractif les objets imbriqus\n      // Exclure Map, Set, WeakMap, WeakSet car leurs mthodes ne fonctionnent pas avec Proxy\n      if (\n        options.deep &&\n        value &&\n        typeof value === 'object' &&\n        !Array.isArray(value) &&\n        !(value instanceof Map) &&\n        !(value instanceof Set) &&\n        !(value instanceof WeakMap) &&\n        !(value instanceof WeakSet)\n      ) {\n        return reactive(value, options);\n      }\n\n      return value;\n    },\n\n    set(obj: T, prop: string | symbol, value: any): boolean {\n      const oldValue = Reflect.get(obj, prop);\n\n      if (oldValue === value) {\n        return true;\n      }\n\n      const result = Reflect.set(obj, prop, value);\n\n      if (result) {\n        // Notifier tous les subscribers\n        subscribers.forEach(subscriber => {\n          subscriber(value, oldValue, String(prop));\n        });\n      }\n\n      return result;\n    },\n\n    deleteProperty(obj: T, prop: string | symbol): boolean {\n      const oldValue = Reflect.get(obj, prop);\n      const result = Reflect.deleteProperty(obj, prop);\n\n      if (result) {\n        subscribers.forEach(subscriber => {\n          subscriber(undefined, oldValue, String(prop));\n        });\n      }\n\n      return result;\n    }\n  };\n\n  const proxy = new Proxy(target, handler);\n\n  // Ajouter des mthodes pour grer les subscriptions\n  (proxy as any).$subscribe = (subscriber: Subscriber<any>) => {\n    subscribers.add(subscriber);\n    return () => subscribers.delete(subscriber);\n  };\n\n  (proxy as any).$subscribers = subscribers;\n\n  return proxy;\n}\n\n/**\n * Cre une valeur ractive simple (ref)\n */\nexport function ref<T>(initialValue: T) {\n  const subscribers = new Set<Subscriber<T>>();\n\n  let _value = initialValue;\n\n  return {\n    get value(): T {\n      return _value;\n    },\n\n    set value(newValue: T) {\n      if (_value === newValue) return;\n      const oldValue = _value;\n      _value = newValue;\n      subscribers.forEach(sub => sub(newValue, oldValue, 'value'));\n    },\n\n    subscribe(subscriber: Subscriber<T>): () => void {\n      subscribers.add(subscriber);\n      return () => subscribers.delete(subscriber);\n    }\n  };\n}\n\n/**\n * Cre une valeur calcule (computed)\n */\nexport function computed<T>(getter: () => T, deps: any[] = []) {\n  const subscribers = new Set<Subscriber<T>>();\n  let cachedValue: T;\n  let isDirty = true;\n\n  // Observer les dpendances\n  deps.forEach(dep => {\n    if (dep && typeof dep === 'object' && '$subscribe' in dep) {\n      (dep as any).$subscribe(() => {\n        isDirty = true;\n        const newValue = getter();\n        if (newValue !== cachedValue) {\n          const oldValue = cachedValue;\n          cachedValue = newValue;\n          subscribers.forEach(sub => sub(newValue, oldValue, 'computed'));\n        }\n      });\n    }\n  });\n\n  return {\n    get value(): T {\n      if (isDirty) {\n        cachedValue = getter();\n        isDirty = false;\n      }\n      return cachedValue;\n    },\n\n    subscribe(subscriber: Subscriber<T>): () => void {\n      subscribers.add(subscriber);\n      return () => subscribers.delete(subscriber);\n    }\n  };\n}\n\n/**\n * Observe les changements sur un objet ractif\n */\nexport function watch<T>(\n  source: { value: T } | (() => T),\n  callback: (newValue: T, oldValue: T) => void,\n  options: { immediate?: boolean } = {}\n) {\n  let oldValue: T;\n\n  const getter = typeof source === 'function' ? source : () => source.value;\n\n  const run = () => {\n    const newValue = getter();\n    if (newValue !== oldValue) {\n      callback(newValue, oldValue);\n      oldValue = newValue;\n    }\n  };\n\n  if (options.immediate) {\n    oldValue = getter();\n    callback(oldValue, undefined as any);\n  }\n\n  // Si c'est un ref ou reactive, s'abonner\n  if (typeof source === 'object' && 'subscribe' in source) {\n    return (source as any).subscribe((newVal: T, oldVal: T) => {\n      callback(newVal, oldVal);\n    });\n  }\n\n  return () => {}; // Cleanup function\n}\n\n/**\n * Batch multiple updates pour viter les re-renders multiples\n */\nlet batchQueue: (() => void)[] = [];\nlet isBatching = false;\n\nexport function batch(fn: () => void) {\n  if (isBatching) {\n    batchQueue.push(fn);\n    return;\n  }\n\n  isBatching = true;\n  fn();\n\n  while (batchQueue.length > 0) {\n    const queued = batchQueue.shift();\n    queued?.();\n  }\n\n  isBatching = false;\n}\n\n/**\n * Cre un effet qui s'excute quand les dpendances changent\n */\nexport function effect(fn: () => void | (() => void)) {\n  let cleanup: (() => void) | void;\n\n  const run = () => {\n    if (cleanup) cleanup();\n    cleanup = fn();\n  };\n\n  run();\n\n  return () => {\n    if (cleanup) cleanup();\n  };\n}\n","function promisifyRequest(request) {\n    return new Promise((resolve, reject) => {\n        // @ts-ignore - file size hacks\n        request.oncomplete = request.onsuccess = () => resolve(request.result);\n        // @ts-ignore - file size hacks\n        request.onabort = request.onerror = () => reject(request.error);\n    });\n}\nfunction createStore(dbName, storeName) {\n    let dbp;\n    const getDB = () => {\n        if (dbp)\n            return dbp;\n        const request = indexedDB.open(dbName);\n        request.onupgradeneeded = () => request.result.createObjectStore(storeName);\n        dbp = promisifyRequest(request);\n        dbp.then((db) => {\n            // It seems like Safari sometimes likes to just close the connection.\n            // It's supposed to fire this event when that happens. Let's hope it does!\n            db.onclose = () => (dbp = undefined);\n        }, () => { });\n        return dbp;\n    };\n    return (txMode, callback) => getDB().then((db) => callback(db.transaction(storeName, txMode).objectStore(storeName)));\n}\nlet defaultGetStoreFunc;\nfunction defaultGetStore() {\n    if (!defaultGetStoreFunc) {\n        defaultGetStoreFunc = createStore('keyval-store', 'keyval');\n    }\n    return defaultGetStoreFunc;\n}\n/**\n * Get a value by its key.\n *\n * @param key\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction get(key, customStore = defaultGetStore()) {\n    return customStore('readonly', (store) => promisifyRequest(store.get(key)));\n}\n/**\n * Set a value with a key.\n *\n * @param key\n * @param value\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction set(key, value, customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => {\n        store.put(value, key);\n        return promisifyRequest(store.transaction);\n    });\n}\n/**\n * Set multiple values at once. This is faster than calling set() multiple times.\n * It's also atomic  if one of the pairs can't be added, none will be added.\n *\n * @param entries Array of entries, where each entry is an array of `[key, value]`.\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction setMany(entries, customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => {\n        entries.forEach((entry) => store.put(entry[1], entry[0]));\n        return promisifyRequest(store.transaction);\n    });\n}\n/**\n * Get multiple values by their keys\n *\n * @param keys\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction getMany(keys, customStore = defaultGetStore()) {\n    return customStore('readonly', (store) => Promise.all(keys.map((key) => promisifyRequest(store.get(key)))));\n}\n/**\n * Update a value. This lets you see the old value and update it as an atomic operation.\n *\n * @param key\n * @param updater A callback that takes the old value and returns a new value.\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction update(key, updater, customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => \n    // Need to create the promise manually.\n    // If I try to chain promises, the transaction closes in browsers\n    // that use a promise polyfill (IE10/11).\n    new Promise((resolve, reject) => {\n        store.get(key).onsuccess = function () {\n            try {\n                store.put(updater(this.result), key);\n                resolve(promisifyRequest(store.transaction));\n            }\n            catch (err) {\n                reject(err);\n            }\n        };\n    }));\n}\n/**\n * Delete a particular key from the store.\n *\n * @param key\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction del(key, customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => {\n        store.delete(key);\n        return promisifyRequest(store.transaction);\n    });\n}\n/**\n * Delete multiple keys at once.\n *\n * @param keys List of keys to delete.\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction delMany(keys, customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => {\n        keys.forEach((key) => store.delete(key));\n        return promisifyRequest(store.transaction);\n    });\n}\n/**\n * Clear all values in the store.\n *\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction clear(customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => {\n        store.clear();\n        return promisifyRequest(store.transaction);\n    });\n}\nfunction eachCursor(store, callback) {\n    store.openCursor().onsuccess = function () {\n        if (!this.result)\n            return;\n        callback(this.result);\n        this.result.continue();\n    };\n    return promisifyRequest(store.transaction);\n}\n/**\n * Get all keys in the store.\n *\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction keys(customStore = defaultGetStore()) {\n    return customStore('readonly', (store) => {\n        // Fast path for modern browsers\n        if (store.getAllKeys) {\n            return promisifyRequest(store.getAllKeys());\n        }\n        const items = [];\n        return eachCursor(store, (cursor) => items.push(cursor.key)).then(() => items);\n    });\n}\n/**\n * Get all values in the store.\n *\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction values(customStore = defaultGetStore()) {\n    return customStore('readonly', (store) => {\n        // Fast path for modern browsers\n        if (store.getAll) {\n            return promisifyRequest(store.getAll());\n        }\n        const items = [];\n        return eachCursor(store, (cursor) => items.push(cursor.value)).then(() => items);\n    });\n}\n/**\n * Get all entries in the store. Each entry is an array of `[key, value]`.\n *\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction entries(customStore = defaultGetStore()) {\n    return customStore('readonly', (store) => {\n        // Fast path for modern browsers\n        // (although, hopefully we'll get a simpler path some day)\n        if (store.getAll && store.getAllKeys) {\n            return Promise.all([\n                promisifyRequest(store.getAllKeys()),\n                promisifyRequest(store.getAll()),\n            ]).then(([keys, values]) => keys.map((key, i) => [key, values[i]]));\n        }\n        const items = [];\n        return customStore('readonly', (store) => eachCursor(store, (cursor) => items.push([cursor.key, cursor.value])).then(() => items));\n    });\n}\n\nexport { clear, createStore, del, delMany, entries, get, getMany, keys, promisifyRequest, set, setMany, update, values };\n","// ============================================================================\n// Service de persistance (localStorage + IndexedDB)\n// ============================================================================\n\nimport { get, set, del, keys } from 'idb-keyval';\nimport type { PersistedState } from '../types';\n\nconst STORAGE_KEY = 'carte-stages-state';\nconst STORAGE_VERSION = 1;\nconst NOTES_STORE_KEY = 'carte-stages-notes';\n\n/**\n * Sauvegarde l'tat dans localStorage\n */\nexport function persistState(state: PersistedState): void {\n  try {\n    const data = {\n      version: STORAGE_VERSION,\n      ...state,\n      timestamp: Date.now()\n    };\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));\n  } catch (error) {\n    console.warn('Erreur lors de la sauvegarde de l\\'tat:', error);\n  }\n}\n\n/**\n * Charge l'tat depuis localStorage\n */\nexport async function loadPersistedState(): Promise<PersistedState | null> {\n  try {\n    // Charger depuis localStorage\n    const stored = localStorage.getItem(STORAGE_KEY);\n    if (!stored) return null;\n\n    const data = JSON.parse(stored);\n\n    // Vrifier la version\n    if (data.version !== STORAGE_VERSION) {\n      console.log('Version de stockage diffrente, migration...');\n      return migrateState(data);\n    }\n\n    // Charger les notes depuis IndexedDB (plus de capacit)\n    const notes = await loadNotesFromIndexedDB();\n\n    return {\n      theme: data.theme || 'auto',\n      favorites: data.favorites || [],\n      personalNotes: notes || data.personalNotes || {},\n      sidebarCollapsed: data.sidebarCollapsed || false,\n      mapCenter: data.mapCenter || { lat: 46.5, lon: -0.3 },\n      mapZoom: data.mapZoom || 9,\n      lastFilters: data.lastFilters || {}\n    };\n  } catch (error) {\n    console.warn('Erreur lors du chargement de l\\'tat:', error);\n    return null;\n  }\n}\n\n/**\n * Migre l'tat d'une ancienne version\n */\nfunction migrateState(oldData: any): PersistedState {\n  // Pour l'instant, retourner les valeurs par dfaut\n  // Ajouter la logique de migration si ncessaire\n  return {\n    theme: oldData.theme || 'auto',\n    favorites: oldData.favorites || [],\n    personalNotes: oldData.personalNotes || {},\n    sidebarCollapsed: false,\n    mapCenter: { lat: 46.5, lon: -0.3 },\n    mapZoom: 9,\n    lastFilters: {}\n  };\n}\n\n/**\n * Sauvegarde les notes dans IndexedDB\n */\nexport async function saveNotesToIndexedDB(notes: Record<string, string>): Promise<void> {\n  try {\n    await set(NOTES_STORE_KEY, notes);\n  } catch (error) {\n    console.warn('Erreur lors de la sauvegarde des notes dans IndexedDB:', error);\n    // Fallback sur localStorage\n    try {\n      localStorage.setItem(NOTES_STORE_KEY, JSON.stringify(notes));\n    } catch (e) {\n      console.error('Impossible de sauvegarder les notes:', e);\n    }\n  }\n}\n\n/**\n * Charge les notes depuis IndexedDB\n */\nexport async function loadNotesFromIndexedDB(): Promise<Record<string, string> | null> {\n  try {\n    const notes = await get<Record<string, string>>(NOTES_STORE_KEY);\n    return notes || null;\n  } catch (error) {\n    console.warn('Erreur lors du chargement des notes depuis IndexedDB:', error);\n    // Fallback sur localStorage\n    try {\n      const stored = localStorage.getItem(NOTES_STORE_KEY);\n      return stored ? JSON.parse(stored) : null;\n    } catch (e) {\n      return null;\n    }\n  }\n}\n\n/**\n * Efface toutes les donnes persistes\n */\nexport async function clearPersistedData(): Promise<void> {\n  try {\n    localStorage.removeItem(STORAGE_KEY);\n    localStorage.removeItem(NOTES_STORE_KEY);\n    await del(NOTES_STORE_KEY);\n  } catch (error) {\n    console.warn('Erreur lors de l\\'effacement des donnes:', error);\n  }\n}\n\n/**\n * Exporte toutes les donnes utilisateur\n */\nexport async function exportUserData(): Promise<{\n  favorites: string[];\n  notes: Record<string, string>;\n  preferences: Partial<PersistedState>;\n}> {\n  const state = await loadPersistedState();\n\n  return {\n    favorites: state?.favorites || [],\n    notes: state?.personalNotes || {},\n    preferences: {\n      theme: state?.theme,\n      sidebarCollapsed: state?.sidebarCollapsed,\n      mapCenter: state?.mapCenter,\n      mapZoom: state?.mapZoom\n    }\n  };\n}\n\n/**\n * Importe les donnes utilisateur\n */\nexport async function importUserData(data: {\n  favorites?: string[];\n  notes?: Record<string, string>;\n  preferences?: Partial<PersistedState>;\n}): Promise<void> {\n  const currentState = await loadPersistedState();\n\n  const newState: PersistedState = {\n    theme: data.preferences?.theme || currentState?.theme || 'auto',\n    favorites: data.favorites || currentState?.favorites || [],\n    personalNotes: data.notes || currentState?.personalNotes || {},\n    sidebarCollapsed: data.preferences?.sidebarCollapsed ?? currentState?.sidebarCollapsed ?? false,\n    mapCenter: data.preferences?.mapCenter || currentState?.mapCenter || { lat: 46.5, lon: -0.3 },\n    mapZoom: data.preferences?.mapZoom ?? currentState?.mapZoom ?? 9,\n    lastFilters: currentState?.lastFilters || {}\n  };\n\n  persistState(newState);\n\n  if (data.notes) {\n    await saveNotesToIndexedDB(data.notes);\n  }\n}\n\n/**\n * Vrifie l'espace de stockage disponible\n */\nexport async function checkStorageQuota(): Promise<{\n  usage: number;\n  quota: number;\n  percentUsed: number;\n} | null> {\n  if ('storage' in navigator && 'estimate' in navigator.storage) {\n    try {\n      const estimate = await navigator.storage.estimate();\n      return {\n        usage: estimate.usage || 0,\n        quota: estimate.quota || 0,\n        percentUsed: estimate.quota ? ((estimate.usage || 0) / estimate.quota) * 100 : 0\n      };\n    } catch (error) {\n      return null;\n    }\n  }\n  return null;\n}\n\n/**\n * Cache pour les donnes temporaires (session only)\n */\nconst sessionCache = new Map<string, { data: any; expires: number }>();\n\nexport function setSessionCache(key: string, data: any, ttlMs: number = 5 * 60 * 1000): void {\n  sessionCache.set(key, {\n    data,\n    expires: Date.now() + ttlMs\n  });\n}\n\nexport function getSessionCache<T>(key: string): T | null {\n  const cached = sessionCache.get(key);\n  if (!cached) return null;\n\n  if (Date.now() > cached.expires) {\n    sessionCache.delete(key);\n    return null;\n  }\n\n  return cached.data as T;\n}\n\nexport function clearSessionCache(): void {\n  sessionCache.clear();\n}\n","// ============================================================================\n// Store centralis de l'application\n// ============================================================================\n\nimport type {\n  AppState,\n  Location,\n  Filters,\n  SortOptions,\n  Theme,\n  ViewMode,\n  AppEvent,\n  EventListener\n} from '../types';\nimport { reactive, batch } from './reactivity';\nimport { loadPersistedState, persistState } from '../services/storage.service';\n\n// tat initial\nconst initialFilters: Filters = {\n  search: '',\n  domains: [],\n  levelMin: 1,\n  levelMax: 5,\n  distanceKm: null,\n  referencePoint: null,\n  favoritesOnly: false\n};\n\nconst initialSortOptions: SortOptions = {\n  field: 'nom',\n  direction: 'asc'\n};\n\nconst initialState: AppState = {\n  // Donnes\n  locations: [],\n  filteredIndices: [],\n  searchIndex: new Map(),\n\n  // UI State\n  isLoading: true,\n  theme: 'auto',\n  viewMode: 'split',\n  sidebarCollapsed: false,\n  detailPanelOpen: false,\n  selectedLocationIndex: null,\n\n  // Filtres\n  filters: initialFilters,\n  sortOptions: initialSortOptions,\n\n  // Fonctionnalits\n  favorites: new Set(),\n  compareList: [],\n  personalNotes: new Map(),\n\n  // Carte\n  mapCenter: { lat: 46.5, lon: -0.3 },\n  mapZoom: 9,\n  heatmapEnabled: false,\n  clusteringEnabled: true,\n  userLocation: null,\n\n  // Stats\n  uniqueTypes: [],\n  uniqueCities: []\n};\n\n// Crer le store ractif\nexport const store = reactive<AppState>(initialState);\n\n// Event bus pour la communication inter-composants\ntype EventMap = {\n  [K in AppEvent['type']]: Set<EventListener<K>>;\n};\n\nconst eventListeners: Partial<EventMap> = {};\n\n/**\n * met un vnement\n */\nexport function emit<T extends AppEvent['type']>(\n  type: T,\n  payload: Extract<AppEvent, { type: T }>['payload']\n) {\n  const listeners = eventListeners[type] as Set<EventListener<T>> | undefined;\n  if (listeners) {\n    listeners.forEach(listener => {\n      listener({ type, payload } as Extract<AppEvent, { type: T }>);\n    });\n  }\n}\n\n/**\n * S'abonne  un vnement\n */\nexport function on<T extends AppEvent['type']>(\n  type: T,\n  listener: EventListener<T>\n): () => void {\n  if (!eventListeners[type]) {\n    eventListeners[type] = new Set() as any;\n  }\n  (eventListeners[type] as Set<EventListener<T>>).add(listener);\n\n  return () => {\n    (eventListeners[type] as Set<EventListener<T>>).delete(listener);\n  };\n}\n\n// ============================================================================\n// Actions du store\n// ============================================================================\n\n/**\n * Charge les donnes des lieux\n */\nexport function setLocations(locations: Location[]) {\n  batch(() => {\n    store.locations = locations;\n    store.filteredIndices = locations.map((_, i) => i);\n    store.uniqueTypes = [...new Set(locations.map(l => l.type).filter(Boolean))].sort();\n    store.uniqueCities = [...new Set(locations.map(l => l.ville).filter(Boolean))].sort();\n    buildSearchIndex();\n  });\n\n  emit('DATA_LOADED', locations);\n}\n\n/**\n * Construit l'index de recherche\n */\nfunction buildSearchIndex() {\n  store.searchIndex.clear();\n\n  store.locations.forEach((location, index) => {\n    const searchableText = [\n      location.nom,\n      location.adresse,\n      location.ville,\n      location.codePostal,\n      location.type,\n      location.contact,\n      location.commentaire\n    ]\n      .filter(Boolean)\n      .join(' ')\n      .toLowerCase()\n      .normalize('NFD')\n      .replace(/[\\u0300-\\u036f]/g, '');\n\n    store.searchIndex.set(index, searchableText);\n  });\n}\n\n/**\n * Met  jour les filtres\n */\nexport function updateFilters(newFilters: Partial<Filters>) {\n  batch(() => {\n    store.filters = { ...store.filters, ...newFilters };\n    applyFiltersAndSort();\n  });\n\n  emit('FILTER_CHANGED', newFilters);\n}\n\n/**\n * Met  jour le tri\n */\nexport function updateSort(sortOptions: SortOptions) {\n  batch(() => {\n    store.sortOptions = sortOptions;\n    applyFiltersAndSort();\n  });\n\n  emit('SORT_CHANGED', sortOptions);\n}\n\n/**\n * Applique les filtres et le tri\n */\nexport function applyFiltersAndSort() {\n  const { filters, sortOptions, locations, searchIndex, favorites, userLocation } = store;\n\n  // Normaliser le terme de recherche\n  const searchNormalized = filters.search\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '');\n\n  // Filtrer\n  let indices = locations.map((_, i) => i);\n\n  // Filtre de recherche\n  if (searchNormalized) {\n    indices = indices.filter(i => {\n      const text = searchIndex.get(i) || '';\n      return text.includes(searchNormalized);\n    });\n  }\n\n  // Filtre par domaines\n  if (filters.domains.length > 0) {\n    indices = indices.filter(i => {\n      const location = locations[i];\n      return filters.domains.includes(location.type);\n    });\n  }\n\n  // Filtre par niveau\n  indices = indices.filter(i => {\n    const location = locations[i];\n    const niveau = parseNiveau(location.niveau);\n    if (niveau === null) return true; // Inclure les lieux sans niveau spcifi\n    return niveau >= filters.levelMin && niveau <= filters.levelMax;\n  });\n\n  // Filtre par distance\n  if (filters.distanceKm !== null && filters.referencePoint) {\n    const refPoint = filters.referencePoint;\n    indices = indices.filter(i => {\n      const location = locations[i];\n      if (location.lat === null || location.lon === null) return false;\n      const distance = haversineDistance(\n        refPoint.lat, refPoint.lon,\n        location.lat, location.lon\n      );\n      return distance <= filters.distanceKm!;\n    });\n  }\n\n  // Filtre favoris uniquement\n  if (filters.favoritesOnly) {\n    indices = indices.filter(i => {\n      const location = locations[i];\n      const id = generateLocationId(location);\n      return favorites.has(id);\n    });\n  }\n\n  // Trier\n  indices.sort((a, b) => {\n    const locA = locations[a];\n    const locB = locations[b];\n    let comparison = 0;\n\n    switch (sortOptions.field) {\n      case 'nom':\n        comparison = locA.nom.localeCompare(locB.nom, 'fr');\n        break;\n      case 'ville':\n        comparison = locA.ville.localeCompare(locB.ville, 'fr');\n        break;\n      case 'niveau':\n        const niveauA = parseNiveau(locA.niveau) ?? 99;\n        const niveauB = parseNiveau(locB.niveau) ?? 99;\n        comparison = niveauA - niveauB;\n        break;\n      case 'type':\n        comparison = locA.type.localeCompare(locB.type, 'fr');\n        break;\n      case 'distance':\n        if (userLocation) {\n          const distA = locA.lat && locA.lon\n            ? haversineDistance(userLocation.lat, userLocation.lon, locA.lat, locA.lon)\n            : Infinity;\n          const distB = locB.lat && locB.lon\n            ? haversineDistance(userLocation.lat, userLocation.lon, locB.lat, locB.lon)\n            : Infinity;\n          comparison = distA - distB;\n        }\n        break;\n    }\n\n    return sortOptions.direction === 'asc' ? comparison : -comparison;\n  });\n\n  store.filteredIndices = indices;\n}\n\n/**\n * Parse un niveau (peut tre \"2\", \"2-3\", etc.)\n */\nfunction parseNiveau(niveau: string): number | null {\n  if (!niveau) return null;\n  const match = niveau.match(/(\\d)/);\n  return match ? parseInt(match[1], 10) : null;\n}\n\n/**\n * Calcule la distance entre deux points (formule de Haversine)\n */\nfunction haversineDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {\n  const R = 6371; // Rayon de la Terre en km\n  const dLat = toRad(lat2 - lat1);\n  const dLon = toRad(lon2 - lon1);\n  const a =\n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *\n    Math.sin(dLon / 2) * Math.sin(dLon / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  return R * c;\n}\n\nfunction toRad(deg: number): number {\n  return deg * (Math.PI / 180);\n}\n\n/**\n * Gnre un ID unique pour un lieu\n */\nexport function generateLocationId(location: Location): string {\n  return `${location.nom}-${location.codePostal}-${location.ville}`\n    .toLowerCase()\n    .replace(/\\s+/g, '-');\n}\n\n/**\n * Toggle un favori\n */\nexport function toggleFavorite(locationId: string) {\n  if (store.favorites.has(locationId)) {\n    store.favorites.delete(locationId);\n  } else {\n    store.favorites.add(locationId);\n  }\n\n  // Re-filtrer si on affiche uniquement les favoris\n  if (store.filters.favoritesOnly) {\n    applyFiltersAndSort();\n  }\n\n  emit('FAVORITE_TOGGLED', locationId);\n  persistCurrentState();\n}\n\n/**\n * Slectionne un lieu pour le dtail\n */\nexport function selectLocation(index: number | null) {\n  store.selectedLocationIndex = index;\n  store.detailPanelOpen = index !== null;\n  emit('LOCATION_SELECTED', index);\n}\n\n/**\n * Change le thme\n */\nexport function setTheme(theme: Theme) {\n  store.theme = theme;\n  applyTheme(theme);\n  emit('THEME_CHANGED', theme);\n  persistCurrentState();\n}\n\n/**\n * Applique le thme au document\n */\nfunction applyTheme(theme: Theme) {\n  const root = document.documentElement;\n\n  if (theme === 'auto') {\n    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;\n    root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');\n  } else {\n    root.setAttribute('data-theme', theme);\n  }\n}\n\n/**\n * Toggle la sidebar\n */\nexport function toggleSidebar() {\n  store.sidebarCollapsed = !store.sidebarCollapsed;\n  persistCurrentState();\n}\n\n/**\n * Met  jour la position utilisateur\n */\nexport function setUserLocation(location: { lat: number; lon: number } | null) {\n  store.userLocation = location;\n\n  // Si tri par distance, re-trier\n  if (store.sortOptions.field === 'distance') {\n    applyFiltersAndSort();\n  }\n}\n\n/**\n * Toggle la heatmap\n */\nexport function toggleHeatmap() {\n  store.heatmapEnabled = !store.heatmapEnabled;\n}\n\n/**\n * Toggle le clustering\n */\nexport function toggleClustering() {\n  store.clusteringEnabled = !store.clusteringEnabled;\n}\n\n/**\n * Ajoute un nouveau lieu au store\n */\nexport function addLocationToStore(location: Location) {\n  batch(() => {\n    store.locations = [...store.locations, location];\n    store.filteredIndices = store.locations.map((_, i) => i);\n    store.uniqueTypes = [...new Set(store.locations.map(l => l.type).filter(Boolean))].sort();\n    store.uniqueCities = [...new Set(store.locations.map(l => l.ville).filter(Boolean))].sort();\n    buildSearchIndex();\n  });\n  applyFiltersAndSort();\n  emit('DATA_LOADED', store.locations);\n}\n\n/**\n * Met  jour un lieu existant dans le store\n */\nexport function updateLocationInStore(index: number, updates: Partial<Location>) {\n  if (index < 0 || index >= store.locations.length) return false;\n\n  batch(() => {\n    const newLocations = [...store.locations];\n    newLocations[index] = { ...newLocations[index], ...updates };\n    store.locations = newLocations;\n    store.uniqueTypes = [...new Set(store.locations.map(l => l.type).filter(Boolean))].sort();\n    store.uniqueCities = [...new Set(store.locations.map(l => l.ville).filter(Boolean))].sort();\n    buildSearchIndex();\n  });\n  applyFiltersAndSort();\n  emit('DATA_LOADED', store.locations);\n  return true;\n}\n\n/**\n * Supprime un lieu du store\n */\nexport function removeLocationFromStore(index: number) {\n  if (index < 0 || index >= store.locations.length) return false;\n\n  batch(() => {\n    const newLocations = store.locations.filter((_, i) => i !== index);\n    store.locations = newLocations;\n    store.filteredIndices = newLocations.map((_, i) => i);\n    store.uniqueTypes = [...new Set(newLocations.map(l => l.type).filter(Boolean))].sort();\n    store.uniqueCities = [...new Set(newLocations.map(l => l.ville).filter(Boolean))].sort();\n    buildSearchIndex();\n  });\n  applyFiltersAndSort();\n  emit('DATA_LOADED', store.locations);\n  return true;\n}\n\n/**\n * Ajoute/retire un lieu de la liste de comparaison\n */\nexport function toggleCompare(locationId: string) {\n  const index = store.compareList.indexOf(locationId);\n  if (index === -1) {\n    if (store.compareList.length < 3) {\n      store.compareList.push(locationId);\n    }\n  } else {\n    store.compareList.splice(index, 1);\n  }\n  emit('COMPARE_TOGGLED', locationId);\n}\n\n/**\n * Met  jour une note personnelle\n */\nexport function updateNote(locationId: string, note: string) {\n  if (note.trim()) {\n    store.personalNotes.set(locationId, note);\n  } else {\n    store.personalNotes.delete(locationId);\n  }\n  emit('NOTE_UPDATED', { id: locationId, note });\n  persistCurrentState();\n}\n\n/**\n * Met  jour la position de la carte\n */\nexport function updateMapView(center: { lat: number; lon: number }, zoom: number) {\n  store.mapCenter = center;\n  store.mapZoom = zoom;\n  emit('MAP_MOVED', { center, zoom });\n}\n\n/**\n * Persiste l'tat courant\n */\nfunction persistCurrentState() {\n  persistState({\n    theme: store.theme,\n    favorites: Array.from(store.favorites),\n    personalNotes: Object.fromEntries(store.personalNotes),\n    sidebarCollapsed: store.sidebarCollapsed,\n    mapCenter: store.mapCenter,\n    mapZoom: store.mapZoom,\n    lastFilters: {\n      domains: store.filters.domains,\n      levelMin: store.filters.levelMin,\n      levelMax: store.filters.levelMax\n    }\n  });\n}\n\n/**\n * Initialise le store avec l'tat persist\n */\nexport async function initializeStore() {\n  const persisted = await loadPersistedState();\n\n  if (persisted) {\n    batch(() => {\n      store.theme = persisted.theme;\n      store.favorites = new Set(persisted.favorites);\n      store.personalNotes = new Map(Object.entries(persisted.personalNotes));\n      store.sidebarCollapsed = persisted.sidebarCollapsed;\n      store.mapCenter = persisted.mapCenter;\n      store.mapZoom = persisted.mapZoom;\n\n      if (persisted.lastFilters) {\n        store.filters = { ...store.filters, ...persisted.lastFilters };\n      }\n    });\n\n    applyTheme(store.theme);\n  }\n\n  // couter les changements de prfrence systme\n  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n    if (store.theme === 'auto') {\n      applyTheme('auto');\n    }\n  });\n}\n\n// Export pour debug\nif (import.meta.env.DEV) {\n  (window as any).__store = store;\n}\n","// ============================================================================\n// Utilitaires gnraux\n// ============================================================================\n\n/**\n * Debounce une fonction\n */\nexport function debounce<T extends (...args: any[]) => any>(\n  fn: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n\n  return (...args: Parameters<T>) => {\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n    }\n    timeoutId = setTimeout(() => {\n      fn(...args);\n      timeoutId = null;\n    }, delay);\n  };\n}\n\n/**\n * Throttle une fonction\n */\nexport function throttle<T extends (...args: any[]) => any>(\n  fn: T,\n  limit: number\n): (...args: Parameters<T>) => void {\n  let inThrottle = false;\n\n  return (...args: Parameters<T>) => {\n    if (!inThrottle) {\n      fn(...args);\n      inThrottle = true;\n      setTimeout(() => {\n        inThrottle = false;\n      }, limit);\n    }\n  };\n}\n\n/**\n * Normalise le texte pour la recherche (supprime accents, minuscules)\n */\nexport function normalizeText(text: string): string {\n  return text\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .trim();\n}\n\n/**\n * Vrifie si un niveau correspond au filtre\n */\nexport function niveauMatches(niveau: string, min: number, max: number): boolean {\n  if (!niveau) return true;\n\n  // Grer les ranges comme \"2-3\"\n  const rangeMatch = niveau.match(/(\\d)\\s*-\\s*(\\d)/);\n  if (rangeMatch) {\n    const niveauMin = parseInt(rangeMatch[1], 10);\n    const niveauMax = parseInt(rangeMatch[2], 10);\n    return niveauMin <= max && niveauMax >= min;\n  }\n\n  // Niveau simple\n  const match = niveau.match(/(\\d)/);\n  if (match) {\n    const n = parseInt(match[1], 10);\n    return n >= min && n <= max;\n  }\n\n  return true;\n}\n\n/**\n * Formate une date en franais\n */\nexport function formatDateFR(date: Date = new Date()): string {\n  return date.toLocaleDateString('fr-FR', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric'\n  });\n}\n\n/**\n * Gnre un nom de fichier avec timestamp\n */\nexport function generateFileName(prefix: string, extension: string): string {\n  const now = new Date();\n  const timestamp = now.toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');\n  return `${prefix}_${timestamp}.${extension}`;\n}\n\n/**\n * Gnre un ID unique\n */\nexport function generateId(): string {\n  return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n}\n\n/**\n * Attend un certain temps\n */\nexport function sleep(ms: number): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Clone profondment un objet\n */\nexport function deepClone<T>(obj: T): T {\n  if (obj === null || typeof obj !== 'object') {\n    return obj;\n  }\n\n  if (obj instanceof Date) {\n    return new Date(obj.getTime()) as unknown as T;\n  }\n\n  if (obj instanceof Set) {\n    return new Set(Array.from(obj).map(item => deepClone(item))) as unknown as T;\n  }\n\n  if (obj instanceof Map) {\n    return new Map(\n      Array.from(obj.entries()).map(([key, value]) => [deepClone(key), deepClone(value)])\n    ) as unknown as T;\n  }\n\n  if (Array.isArray(obj)) {\n    return obj.map(item => deepClone(item)) as unknown as T;\n  }\n\n  const cloned = {} as T;\n  for (const key in obj) {\n    if (Object.prototype.hasOwnProperty.call(obj, key)) {\n      cloned[key] = deepClone(obj[key]);\n    }\n  }\n\n  return cloned;\n}\n\n/**\n * Formate un numro de tlphone franais\n */\nexport function formatPhoneNumber(phone: string): string {\n  if (!phone) return '';\n\n  // Nettoyer le numro\n  const cleaned = phone.replace(/\\D/g, '');\n\n  // Format franais : XX XX XX XX XX\n  if (cleaned.length === 10) {\n    return cleaned.replace(/(\\d{2})(\\d{2})(\\d{2})(\\d{2})(\\d{2})/, '$1 $2 $3 $4 $5');\n  }\n\n  return phone;\n}\n\n/**\n * Tronque un texte avec ellipse\n */\nexport function truncate(text: string, maxLength: number): string {\n  if (text.length <= maxLength) return text;\n  return text.slice(0, maxLength - 3) + '...';\n}\n\n/**\n * Capitalise la premire lettre\n */\nexport function capitalize(text: string): string {\n  if (!text) return '';\n  return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();\n}\n\n/**\n * Formate un code postal\n */\nexport function formatPostalCode(code: string): string {\n  return code.padStart(5, '0');\n}\n\n/**\n * Extrait le dpartement d'un code postal\n */\nexport function getDepartmentFromPostalCode(code: string): string {\n  if (!code) return '';\n  const dept = code.slice(0, 2);\n  // Cas spciaux pour les DOM-TOM\n  if (dept === '97' || dept === '98') {\n    return code.slice(0, 3);\n  }\n  return dept;\n}\n\n/**\n * Valide une adresse email\n */\nexport function isValidEmail(email: string): boolean {\n  if (!email) return false;\n  const regex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return regex.test(email);\n}\n\n/**\n * Valide un numro de tlphone franais\n */\nexport function isValidFrenchPhone(phone: string): boolean {\n  if (!phone) return false;\n  const cleaned = phone.replace(/\\D/g, '');\n  return /^0[1-9]\\d{8}$/.test(cleaned);\n}\n\n/**\n * Cre un lment DOM avec des attributs\n */\nexport function createElement<K extends keyof HTMLElementTagNameMap>(\n  tag: K,\n  attributes?: Record<string, string>,\n  children?: (Node | string)[]\n): HTMLElementTagNameMap[K] {\n  const element = document.createElement(tag);\n\n  if (attributes) {\n    for (const [key, value] of Object.entries(attributes)) {\n      if (key === 'className') {\n        element.className = value;\n      } else if (key.startsWith('data-')) {\n        element.dataset[key.slice(5)] = value;\n      } else {\n        element.setAttribute(key, value);\n      }\n    }\n  }\n\n  if (children) {\n    children.forEach(child => {\n      if (typeof child === 'string') {\n        element.appendChild(document.createTextNode(child));\n      } else {\n        element.appendChild(child);\n      }\n    });\n  }\n\n  return element;\n}\n\n/**\n * chappe les caractres HTML\n */\nexport function escapeHtml(text: string): string {\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n\n/**\n * Parse les paramtres URL\n */\nexport function parseUrlParams(): Record<string, string> {\n  const params = new URLSearchParams(window.location.search);\n  const result: Record<string, string> = {};\n  params.forEach((value, key) => {\n    result[key] = value;\n  });\n  return result;\n}\n\n/**\n * Met  jour l'URL sans recharger la page\n */\nexport function updateUrlParams(params: Record<string, string | null>): void {\n  const url = new URL(window.location.href);\n\n  for (const [key, value] of Object.entries(params)) {\n    if (value === null) {\n      url.searchParams.delete(key);\n    } else {\n      url.searchParams.set(key, value);\n    }\n  }\n\n  window.history.replaceState({}, '', url.toString());\n}\n\n/**\n * Vrifie si on est sur mobile\n */\nexport function isMobile(): boolean {\n  return window.innerWidth < 768;\n}\n\n/**\n * Vrifie si on est en mode tactile\n */\nexport function isTouchDevice(): boolean {\n  return 'ontouchstart' in window || navigator.maxTouchPoints > 0;\n}\n\n/**\n * Demande la permission de notification\n */\nexport async function requestNotificationPermission(): Promise<boolean> {\n  if (!('Notification' in window)) {\n    return false;\n  }\n\n  if (Notification.permission === 'granted') {\n    return true;\n  }\n\n  if (Notification.permission !== 'denied') {\n    const permission = await Notification.requestPermission();\n    return permission === 'granted';\n  }\n\n  return false;\n}\n\n/**\n * Affiche une notification systme\n */\nexport function showNotification(title: string, options?: NotificationOptions): void {\n  if (Notification.permission === 'granted') {\n    new Notification(title, options);\n  }\n}\n\n/**\n * Copie du texte dans le presse-papier\n */\nexport async function copyToClipboard(text: string): Promise<boolean> {\n  try {\n    await navigator.clipboard.writeText(text);\n    return true;\n  } catch {\n    // Fallback pour les navigateurs plus anciens\n    const textarea = document.createElement('textarea');\n    textarea.value = text;\n    textarea.style.position = 'fixed';\n    textarea.style.opacity = '0';\n    document.body.appendChild(textarea);\n    textarea.select();\n    try {\n      document.execCommand('copy');\n      return true;\n    } catch {\n      return false;\n    } finally {\n      document.body.removeChild(textarea);\n    }\n  }\n}\n\n/**\n * Partage via Web Share API\n */\nexport async function share(data: ShareData): Promise<boolean> {\n  if (navigator.share) {\n    try {\n      await navigator.share(data);\n      return true;\n    } catch (error) {\n      if ((error as Error).name !== 'AbortError') {\n        console.error('Erreur de partage:', error);\n      }\n      return false;\n    }\n  }\n  return false;\n}\n","// ============================================================================\n// Service API HTTP pour communiquer avec le backend\n// ============================================================================\n\nimport type { Location } from '../types';\n\n// Configuration de l'API\nconst API_BASE_URL = '/api/v1';\n\n// Types de rponse API\ninterface ApiResponse<T = unknown> {\n  success: boolean;\n  data?: T;\n  error?: string;\n  message?: string;\n}\n\ninterface PaginatedResponse<T> extends ApiResponse<T[]> {\n  total: number;\n  page: number;\n  limit: number;\n  totalPages: number;\n}\n\n// Types pour les donnes de l'API (snake_case)\ninterface ApiLocation {\n  id: number;\n  nom: string;\n  adresse: string;\n  code_postal: string;\n  ville: string;\n  type: string;\n  niveau: string | null;\n  telephone: string | null;\n  contact: string | null;\n  email: string | null;\n  commentaire: string | null;\n  lat: number | null;\n  lon: number | null;\n  created_at?: string;\n  updated_at?: string;\n}\n\n// Stockage du code admin\nlet adminCode: string | null = null;\n\n/**\n * Dfinit le code admin pour les requtes authentifies\n */\nexport function setAdminCode(code: string | null): void {\n  adminCode = code;\n}\n\n/**\n * Rcupre le code admin actuel\n */\nexport function getAdminCode(): string | null {\n  return adminCode;\n}\n\n/**\n * Vrifie si un code admin est valide\n */\nexport async function verifyAdminCode(code: string): Promise<boolean> {\n  try {\n    const response = await fetch(`${API_BASE_URL}/auth/verify`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({ code }),\n    });\n\n    const data: ApiResponse = await response.json();\n    return data.success === true;\n  } catch (error) {\n    console.error('Error verifying admin code:', error);\n    return false;\n  }\n}\n\n/**\n * Convertit une location API (snake_case) vers le format frontend (camelCase)\n */\nfunction apiToFrontend(apiLoc: ApiLocation): Location & { id?: number } {\n  return {\n    id: apiLoc.id,\n    nom: apiLoc.nom,\n    adresse: apiLoc.adresse,\n    codePostal: apiLoc.code_postal,\n    ville: apiLoc.ville,\n    type: apiLoc.type,\n    niveau: apiLoc.niveau || '',\n    telephone: apiLoc.telephone || '',\n    contact: apiLoc.contact || '',\n    email: apiLoc.email || '',\n    commentaire: apiLoc.commentaire || '',\n    lat: apiLoc.lat,\n    lon: apiLoc.lon,\n  };\n}\n\n/**\n * Convertit une location frontend (camelCase) vers le format API (snake_case)\n */\nfunction frontendToApi(loc: Location): Omit<ApiLocation, 'id' | 'created_at' | 'updated_at'> {\n  return {\n    nom: loc.nom,\n    adresse: loc.adresse,\n    code_postal: loc.codePostal,\n    ville: loc.ville,\n    type: loc.type,\n    niveau: loc.niveau || null,\n    telephone: loc.telephone || null,\n    contact: loc.contact || null,\n    email: loc.email || null,\n    commentaire: loc.commentaire || null,\n    lat: loc.lat,\n    lon: loc.lon,\n  };\n}\n\n/**\n * Headers communs pour les requtes API\n */\nfunction getHeaders(): HeadersInit {\n  const headers: HeadersInit = {\n    'Content-Type': 'application/json',\n  };\n\n  if (adminCode) {\n    headers['X-Admin-Code'] = adminCode;\n  }\n\n  return headers;\n}\n\n/**\n * Rcupre toutes les locations depuis l'API\n */\nexport async function fetchLocations(): Promise<Location[]> {\n  const response = await fetch(`${API_BASE_URL}/locations?limit=10000`, {\n    method: 'GET',\n    headers: getHeaders(),\n  });\n\n  if (!response.ok) {\n    throw new Error(`HTTP error! status: ${response.status}`);\n  }\n\n  const data: PaginatedResponse<ApiLocation> = await response.json();\n\n  if (!data.success || !data.data) {\n    throw new Error(data.error || 'Failed to fetch locations');\n  }\n\n  return data.data.map(apiToFrontend);\n}\n\n/**\n * Rcupre une location par son ID\n */\nexport async function fetchLocationById(id: number): Promise<Location | null> {\n  try {\n    const response = await fetch(`${API_BASE_URL}/locations/${id}`, {\n      method: 'GET',\n      headers: getHeaders(),\n    });\n\n    if (response.status === 404) {\n      return null;\n    }\n\n    if (!response.ok) {\n      throw new Error(`HTTP error! status: ${response.status}`);\n    }\n\n    const data: ApiResponse<ApiLocation> = await response.json();\n\n    if (!data.success || !data.data) {\n      return null;\n    }\n\n    return apiToFrontend(data.data);\n  } catch (error) {\n    console.error('Error fetching location:', error);\n    return null;\n  }\n}\n\n/**\n * Cre une nouvelle location\n */\nexport async function createLocation(location: Location): Promise<Location> {\n  const response = await fetch(`${API_BASE_URL}/locations`, {\n    method: 'POST',\n    headers: getHeaders(),\n    body: JSON.stringify(frontendToApi(location)),\n  });\n\n  const data: ApiResponse<ApiLocation> = await response.json();\n\n  if (!response.ok || !data.success || !data.data) {\n    throw new Error(data.error || 'Failed to create location');\n  }\n\n  return apiToFrontend(data.data);\n}\n\n/**\n * Met  jour une location existante\n */\nexport async function updateLocationApi(id: number, updates: Partial<Location>): Promise<Location> {\n  // Convertir les mises  jour partielles\n  const apiUpdates: Record<string, unknown> = {};\n\n  if (updates.nom !== undefined) apiUpdates.nom = updates.nom;\n  if (updates.adresse !== undefined) apiUpdates.adresse = updates.adresse;\n  if (updates.codePostal !== undefined) apiUpdates.code_postal = updates.codePostal;\n  if (updates.ville !== undefined) apiUpdates.ville = updates.ville;\n  if (updates.type !== undefined) apiUpdates.type = updates.type;\n  if (updates.niveau !== undefined) apiUpdates.niveau = updates.niveau || null;\n  if (updates.telephone !== undefined) apiUpdates.telephone = updates.telephone || null;\n  if (updates.contact !== undefined) apiUpdates.contact = updates.contact || null;\n  if (updates.email !== undefined) apiUpdates.email = updates.email || null;\n  if (updates.commentaire !== undefined) apiUpdates.commentaire = updates.commentaire || null;\n  if (updates.lat !== undefined) apiUpdates.lat = updates.lat;\n  if (updates.lon !== undefined) apiUpdates.lon = updates.lon;\n\n  const response = await fetch(`${API_BASE_URL}/locations/${id}`, {\n    method: 'PUT',\n    headers: getHeaders(),\n    body: JSON.stringify(apiUpdates),\n  });\n\n  const data: ApiResponse<ApiLocation> = await response.json();\n\n  if (!response.ok || !data.success || !data.data) {\n    throw new Error(data.error || 'Failed to update location');\n  }\n\n  return apiToFrontend(data.data);\n}\n\n/**\n * Supprime une location\n */\nexport async function deleteLocation(id: number): Promise<boolean> {\n  const response = await fetch(`${API_BASE_URL}/locations/${id}`, {\n    method: 'DELETE',\n    headers: getHeaders(),\n  });\n\n  const data: ApiResponse = await response.json();\n\n  if (!response.ok || !data.success) {\n    throw new Error(data.error || 'Failed to delete location');\n  }\n\n  return true;\n}\n\n/**\n * Rcupre tous les types uniques\n */\nexport async function fetchUniqueTypes(): Promise<string[]> {\n  const response = await fetch(`${API_BASE_URL}/locations/types`, {\n    method: 'GET',\n    headers: getHeaders(),\n  });\n\n  if (!response.ok) {\n    throw new Error(`HTTP error! status: ${response.status}`);\n  }\n\n  const data: ApiResponse<string[]> = await response.json();\n\n  if (!data.success || !data.data) {\n    throw new Error(data.error || 'Failed to fetch types');\n  }\n\n  return data.data;\n}\n\n/**\n * Rcupre toutes les villes uniques\n */\nexport async function fetchUniqueCities(): Promise<string[]> {\n  const response = await fetch(`${API_BASE_URL}/locations/cities`, {\n    method: 'GET',\n    headers: getHeaders(),\n  });\n\n  if (!response.ok) {\n    throw new Error(`HTTP error! status: ${response.status}`);\n  }\n\n  const data: ApiResponse<string[]> = await response.json();\n\n  if (!data.success || !data.data) {\n    throw new Error(data.error || 'Failed to fetch cities');\n  }\n\n  return data.data;\n}\n\n/**\n * Vrifie si l'API est disponible\n */\nexport async function isApiAvailable(): Promise<boolean> {\n  try {\n    const response = await fetch(`${API_BASE_URL}/health`, {\n      method: 'GET',\n      signal: AbortSignal.timeout(5000),\n    });\n\n    const data: ApiResponse = await response.json();\n    return data.success === true;\n  } catch {\n    return false;\n  }\n}\n","// ============================================================================\n// Service de gestion des donnes\n// ============================================================================\n\nimport type { Location } from '../types';\nimport { normalizeText } from '../utils/helpers';\nimport {\n  isApiAvailable,\n  fetchLocations,\n  createLocation as apiCreateLocation,\n  updateLocationApi,\n  deleteLocation as apiDeleteLocation,\n  setAdminCode,\n  getAdminCode,\n  verifyAdminCode,\n} from './api.service';\n\n// Rfrence aux donnes embarques (fallback pour file://)\ndeclare global {\n  interface Window {\n    STAGE_DATA?: Location[];\n  }\n}\n\n// Types tendus avec ID pour le mode API\ninterface LocationWithId extends Location {\n  id?: number;\n}\n\nlet locations: LocationWithId[] = [];\nlet searchIndex: Map<number, string> = new Map();\nlet useApi = false; // Flag pour savoir si on utilise l'API\n\n// Export des fonctions d'authentification\nexport { setAdminCode, getAdminCode, verifyAdminCode };\n\n/**\n * Vrifie si le mode API est actif\n */\nexport function isApiMode(): boolean {\n  return useApi;\n}\n\n/**\n * Charge les donnes depuis l'API ou le fichier JSON (fallback)\n */\nexport async function loadData(): Promise<Location[]> {\n  // Essayer d'abord l'API\n  try {\n    const apiAvailable = await isApiAvailable();\n    if (apiAvailable) {\n      console.log('API disponible, chargement depuis l\\'API...');\n      const data = await fetchLocations();\n      locations = data as LocationWithId[];\n      useApi = true;\n      buildSearchIndex();\n      console.log(`Charg ${locations.length} locations depuis l'API`);\n      return locations;\n    }\n  } catch (error) {\n    console.log('API non disponible, utilisation du fallback...', error);\n  }\n\n  useApi = false;\n\n  // Fallback: essayer de charger depuis le fichier JSON\n  try {\n    const response = await fetch('./data.json');\n    if (response.ok) {\n      const data = await response.json();\n      locations = data;\n      buildSearchIndex();\n      console.log(`Charg ${locations.length} locations depuis data.json`);\n      return locations;\n    }\n  } catch (error) {\n    console.log('Chargement depuis data.json chou, utilisation des donnes embarques');\n  }\n\n  // Fallback: donnes embarques (pour file://)\n  if (window.STAGE_DATA) {\n    locations = window.STAGE_DATA;\n    buildSearchIndex();\n    return locations;\n  }\n\n  // Dernier recours: essayer js/data.json\n  try {\n    const response = await fetch('./js/data.json');\n    if (response.ok) {\n      const data = await response.json();\n      locations = data;\n      buildSearchIndex();\n      return locations;\n    }\n  } catch (error) {\n    console.error('Impossible de charger les donnes');\n  }\n\n  throw new Error('Aucune source de donnes disponible');\n}\n\n/**\n * Construit l'index de recherche pour les filtres rapides\n */\nfunction buildSearchIndex(): void {\n  searchIndex.clear();\n\n  locations.forEach((location, index) => {\n    const searchableText = normalizeText([\n      location.nom,\n      location.adresse,\n      location.ville,\n      location.codePostal,\n      location.type,\n      location.contact,\n      location.commentaire\n    ].filter(Boolean).join(' '));\n\n    searchIndex.set(index, searchableText);\n  });\n}\n\n/**\n * Retourne toutes les donnes\n */\nexport function getAllLocations(): Location[] {\n  return locations;\n}\n\n/**\n * Retourne un lieu par son index\n */\nexport function getLocationByIndex(index: number): Location | null {\n  return locations[index] || null;\n}\n\n/**\n * Filtre les donnes selon les critres\n */\nexport function filterData(options: {\n  search?: string;\n  domains?: string[];\n  levelMin?: number;\n  levelMax?: number;\n}): number[] {\n  const { search = '', domains = [], levelMin = 1, levelMax = 5 } = options;\n\n  const searchNormalized = normalizeText(search);\n\n  return locations\n    .map((_, index) => index)\n    .filter(index => {\n      const location = locations[index];\n\n      // Filtre de recherche\n      if (searchNormalized) {\n        const indexedText = searchIndex.get(index) || '';\n        if (!indexedText.includes(searchNormalized)) {\n          return false;\n        }\n      }\n\n      // Filtre par domaine\n      if (domains.length > 0 && !domains.includes(location.type)) {\n        return false;\n      }\n\n      // Filtre par niveau\n      if (location.niveau) {\n        const niveau = parseNiveau(location.niveau);\n        if (niveau !== null && (niveau < levelMin || niveau > levelMax)) {\n          return false;\n        }\n      }\n\n      return true;\n    });\n}\n\n/**\n * Parse un niveau (peut tre \"2\", \"2-3\", etc.)\n */\nfunction parseNiveau(niveau: string): number | null {\n  if (!niveau) return null;\n\n  const rangeMatch = niveau.match(/(\\d)\\s*-\\s*(\\d)/);\n  if (rangeMatch) {\n    return parseInt(rangeMatch[1], 10);\n  }\n\n  const match = niveau.match(/(\\d)/);\n  return match ? parseInt(match[1], 10) : null;\n}\n\n/**\n * Retourne tous les types uniques\n */\nexport function getUniqueTypes(): string[] {\n  const types = new Set<string>();\n  locations.forEach(loc => {\n    if (loc.type) {\n      types.add(loc.type);\n    }\n  });\n  return Array.from(types).sort((a, b) => a.localeCompare(b, 'fr'));\n}\n\n/**\n * Retourne toutes les villes uniques\n */\nexport function getUniqueCities(): string[] {\n  const cities = new Set<string>();\n  locations.forEach(loc => {\n    if (loc.ville) {\n      cities.add(loc.ville);\n    }\n  });\n  return Array.from(cities).sort((a, b) => a.localeCompare(b, 'fr'));\n}\n\n/**\n * Retourne les lieux sans coordonnes\n */\nexport function getLocationsWithoutCoords(): number[] {\n  return locations\n    .map((loc, index) => ({ loc, index }))\n    .filter(({ loc }) => loc.lat === null || loc.lon === null)\n    .map(({ index }) => index);\n}\n\n/**\n * Ajoute un nouveau lieu\n * En mode API, appelle l'API et recharge les donnes\n */\nexport async function addLocation(location: Location): Promise<number> {\n  if (useApi) {\n    try {\n      const created = await apiCreateLocation(location);\n      // Recharger les donnes pour avoir l'ID correct\n      await loadData();\n      // Trouver l'index de la nouvelle location\n      const index = locations.findIndex(\n        (loc) => loc.nom === created.nom && loc.ville === created.ville\n      );\n      return index >= 0 ? index : locations.length - 1;\n    } catch (error) {\n      console.error('Erreur lors de la cration via API:', error);\n      throw error;\n    }\n  }\n\n  // Mode local (fallback)\n  const index = locations.length;\n  locations.push(location);\n\n  // Mettre  jour l'index de recherche\n  const searchableText = normalizeText([\n    location.nom,\n    location.adresse,\n    location.ville,\n    location.codePostal,\n    location.type,\n    location.contact,\n    location.commentaire\n  ].filter(Boolean).join(' '));\n\n  searchIndex.set(index, searchableText);\n\n  return index;\n}\n\n/**\n * Met  jour un lieu existant\n * En mode API, appelle l'API pour persister les modifications\n */\nexport async function updateLocation(index: number, updates: Partial<Location>): Promise<boolean> {\n  if (index < 0 || index >= locations.length) {\n    return false;\n  }\n\n  if (useApi) {\n    const loc = locations[index];\n    if (loc.id) {\n      try {\n        await updateLocationApi(loc.id, updates);\n      } catch (error) {\n        console.error('Erreur lors de la mise  jour via API:', error);\n        throw error;\n      }\n    }\n  }\n\n  locations[index] = { ...locations[index], ...updates };\n\n  // Mettre  jour l'index de recherche\n  const location = locations[index];\n  const searchableText = normalizeText([\n    location.nom,\n    location.adresse,\n    location.ville,\n    location.codePostal,\n    location.type,\n    location.contact,\n    location.commentaire\n  ].filter(Boolean).join(' '));\n\n  searchIndex.set(index, searchableText);\n\n  return true;\n}\n\n/**\n * Supprime un lieu\n * En mode API, appelle l'API pour persister la suppression\n */\nexport async function removeLocation(index: number): Promise<boolean> {\n  if (index < 0 || index >= locations.length) {\n    return false;\n  }\n\n  if (useApi) {\n    const loc = locations[index];\n    if (loc.id) {\n      try {\n        await apiDeleteLocation(loc.id);\n      } catch (error) {\n        console.error('Erreur lors de la suppression via API:', error);\n        throw error;\n      }\n    }\n  }\n\n  locations.splice(index, 1);\n  buildSearchIndex(); // Reconstruire l'index car les indices ont chang\n\n  return true;\n}\n\n/**\n * Vrifie si un lieu existe dj (par nom et ville)\n */\nexport function locationExists(nom: string, ville: string): boolean {\n  const nomNormalized = normalizeText(nom);\n  const villeNormalized = normalizeText(ville);\n\n  return locations.some(loc =>\n    normalizeText(loc.nom) === nomNormalized &&\n    normalizeText(loc.ville) === villeNormalized\n  );\n}\n\n/**\n * Recherche des lieux similaires\n */\nexport function findSimilarLocations(location: Partial<Location>): number[] {\n  const results: number[] = [];\n\n  if (!location.nom) return results;\n\n  const nomNormalized = normalizeText(location.nom);\n\n  locations.forEach((loc, index) => {\n    const locNomNormalized = normalizeText(loc.nom);\n\n    // Correspondance exacte du nom\n    if (locNomNormalized === nomNormalized) {\n      results.push(index);\n      return;\n    }\n\n    // Correspondance partielle (contient)\n    if (locNomNormalized.includes(nomNormalized) || nomNormalized.includes(locNomNormalized)) {\n      results.push(index);\n    }\n  });\n\n  return results;\n}\n\n/**\n * Calcule les statistiques des donnes\n */\nexport function calculateStatistics() {\n  const byType: Record<string, number> = {};\n  const byLevel: Record<string, number> = {};\n  const byCity: Record<string, number> = {};\n  const byDepartment: Record<string, number> = {};\n  let geolocated = 0;\n\n  locations.forEach(loc => {\n    // Par type\n    if (loc.type) {\n      byType[loc.type] = (byType[loc.type] || 0) + 1;\n    }\n\n    // Par niveau\n    if (loc.niveau) {\n      byLevel[loc.niveau] = (byLevel[loc.niveau] || 0) + 1;\n    }\n\n    // Par ville\n    if (loc.ville) {\n      byCity[loc.ville] = (byCity[loc.ville] || 0) + 1;\n    }\n\n    // Par dpartement\n    if (loc.codePostal) {\n      const dept = loc.codePostal.slice(0, 2);\n      byDepartment[dept] = (byDepartment[dept] || 0) + 1;\n    }\n\n    // Golocalis\n    if (loc.lat !== null && loc.lon !== null) {\n      geolocated++;\n    }\n  });\n\n  return {\n    totalLocations: locations.length,\n    totalCities: Object.keys(byCity).length,\n    totalGeolocated: geolocated,\n    percentGeolocated: locations.length > 0 ? (geolocated / locations.length) * 100 : 0,\n    byType: Object.entries(byType)\n      .map(([type, count]) => ({ type, count }))\n      .sort((a, b) => b.count - a.count),\n    byLevel: Object.entries(byLevel)\n      .map(([level, count]) => ({ level, count }))\n      .sort((a, b) => a.level.localeCompare(b.level)),\n    topCities: Object.entries(byCity)\n      .map(([city, count]) => ({ city, count }))\n      .sort((a, b) => b.count - a.count)\n      .slice(0, 10),\n    byDepartment: Object.entries(byDepartment)\n      .map(([dept, count]) => ({ dept, count }))\n      .sort((a, b) => b.count - a.count)\n  };\n}\n\n/**\n * Exporte les donnes au format JSON\n */\nexport function exportAsJson(indices?: number[]): string {\n  const data = indices\n    ? indices.map(i => locations[i])\n    : locations;\n\n  return JSON.stringify(data, null, 2);\n}\n","// ============================================================================\n// Composant ThemeToggle - Slecteur de thme (clair/sombre/auto)\n// ============================================================================\n\nimport type { Theme } from '../../types';\nimport { store, setTheme } from '../../store';\n\nconst ICONS = {\n  light: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n    <circle cx=\"12\" cy=\"12\" r=\"5\"/>\n    <line x1=\"12\" y1=\"1\" x2=\"12\" y2=\"3\"/>\n    <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"23\"/>\n    <line x1=\"4.22\" y1=\"4.22\" x2=\"5.64\" y2=\"5.64\"/>\n    <line x1=\"18.36\" y1=\"18.36\" x2=\"19.78\" y2=\"19.78\"/>\n    <line x1=\"1\" y1=\"12\" x2=\"3\" y2=\"12\"/>\n    <line x1=\"21\" y1=\"12\" x2=\"23\" y2=\"12\"/>\n    <line x1=\"4.22\" y1=\"19.78\" x2=\"5.64\" y2=\"18.36\"/>\n    <line x1=\"18.36\" y1=\"5.64\" x2=\"19.78\" y2=\"4.22\"/>\n  </svg>`,\n  dark: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n    <path d=\"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z\"/>\n  </svg>`,\n  auto: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\n    <path d=\"M12 2a10 10 0 0 1 0 20\"/>\n  </svg>`\n};\n\nconst LABELS: Record<Theme, string> = {\n  light: 'Clair',\n  dark: 'Sombre',\n  auto: 'Auto'\n};\n\nconst NEXT_THEME: Record<Theme, Theme> = {\n  light: 'dark',\n  dark: 'auto',\n  auto: 'light'\n};\n\nlet button: HTMLButtonElement | null = null;\nlet dropdown: HTMLElement | null = null;\nlet isDropdownOpen = false;\n\n/**\n * Cre le bouton toggle de thme\n */\nexport function createThemeToggle(container: HTMLElement): HTMLButtonElement {\n  // Bouton principal\n  button = document.createElement('button');\n  button.className = 'theme-toggle';\n  button.setAttribute('type', 'button');\n  button.setAttribute('aria-label', 'Changer le thme');\n  button.setAttribute('aria-haspopup', 'true');\n  button.setAttribute('aria-expanded', 'false');\n\n  updateButton();\n\n  // Dropdown\n  dropdown = document.createElement('div');\n  dropdown.className = 'theme-dropdown';\n  dropdown.setAttribute('role', 'menu');\n  dropdown.innerHTML = `\n    <button class=\"theme-option\" data-theme=\"light\" role=\"menuitem\">\n      ${ICONS.light}\n      <span>Clair</span>\n    </button>\n    <button class=\"theme-option\" data-theme=\"dark\" role=\"menuitem\">\n      ${ICONS.dark}\n      <span>Sombre</span>\n    </button>\n    <button class=\"theme-option\" data-theme=\"auto\" role=\"menuitem\">\n      ${ICONS.auto}\n      <span>Automatique</span>\n    </button>\n  `;\n\n  // Wrapper\n  const wrapper = document.createElement('div');\n  wrapper.className = 'theme-toggle-wrapper';\n  wrapper.appendChild(button);\n  wrapper.appendChild(dropdown);\n\n  container.appendChild(wrapper);\n\n  // Events\n  button.addEventListener('click', toggleDropdown);\n\n  dropdown.querySelectorAll('.theme-option').forEach(option => {\n    option.addEventListener('click', () => {\n      const theme = option.getAttribute('data-theme') as Theme;\n      selectTheme(theme);\n      closeDropdown();\n    });\n  });\n\n  // Fermer au clic extrieur\n  document.addEventListener('click', (e) => {\n    if (isDropdownOpen && !wrapper.contains(e.target as Node)) {\n      closeDropdown();\n    }\n  });\n\n  // Fermer avec Escape\n  document.addEventListener('keydown', (e) => {\n    if (e.key === 'Escape' && isDropdownOpen) {\n      closeDropdown();\n      button?.focus();\n    }\n  });\n\n  return button;\n}\n\n/**\n * Cre un bouton toggle simple (cycle entre les thmes)\n */\nexport function createSimpleThemeToggle(container: HTMLElement): HTMLButtonElement {\n  button = document.createElement('button');\n  button.className = 'theme-toggle theme-toggle-simple';\n  button.setAttribute('type', 'button');\n  button.setAttribute('aria-label', 'Changer le thme');\n\n  updateButton();\n\n  button.addEventListener('click', () => {\n    const nextTheme = NEXT_THEME[store.theme];\n    selectTheme(nextTheme);\n  });\n\n  container.appendChild(button);\n\n  return button;\n}\n\n/**\n * Met  jour l'apparence du bouton\n */\nfunction updateButton(): void {\n  if (!button) return;\n\n  const currentTheme = store.theme;\n  button.innerHTML = ICONS[currentTheme];\n  button.setAttribute('aria-label', `Thme: ${LABELS[currentTheme]}. Cliquer pour changer.`);\n  button.setAttribute('title', `Thme: ${LABELS[currentTheme]}`);\n\n  // Mettre  jour l'option active dans le dropdown\n  dropdown?.querySelectorAll('.theme-option').forEach(option => {\n    const isActive = option.getAttribute('data-theme') === currentTheme;\n    option.classList.toggle('active', isActive);\n    option.setAttribute('aria-checked', String(isActive));\n  });\n}\n\n/**\n * Toggle le dropdown\n */\nfunction toggleDropdown(): void {\n  if (isDropdownOpen) {\n    closeDropdown();\n  } else {\n    openDropdown();\n  }\n}\n\n/**\n * Ouvre le dropdown\n */\nfunction openDropdown(): void {\n  if (!dropdown || !button) return;\n\n  isDropdownOpen = true;\n  dropdown.classList.add('open');\n  button.setAttribute('aria-expanded', 'true');\n\n  // Focus sur l'option active\n  const activeOption = dropdown.querySelector('.theme-option.active') as HTMLElement;\n  activeOption?.focus();\n}\n\n/**\n * Ferme le dropdown\n */\nfunction closeDropdown(): void {\n  if (!dropdown || !button) return;\n\n  isDropdownOpen = false;\n  dropdown.classList.remove('open');\n  button.setAttribute('aria-expanded', 'false');\n}\n\n/**\n * Slectionne un thme\n */\nfunction selectTheme(theme: Theme): void {\n  setTheme(theme);\n  updateButton();\n}\n\n/**\n * Applique le thme au document\n */\nexport function applyTheme(theme: Theme): void {\n  const root = document.documentElement;\n\n  if (theme === 'auto') {\n    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;\n    root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');\n  } else {\n    root.setAttribute('data-theme', theme);\n  }\n\n  // Mettre  jour la meta theme-color\n  const metaThemeColor = document.querySelector('meta[name=\"theme-color\"]');\n  if (metaThemeColor) {\n    const effectiveTheme = theme === 'auto'\n      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')\n      : theme;\n    metaThemeColor.setAttribute('content', effectiveTheme === 'dark' ? '#1e293b' : '#2563eb');\n  }\n}\n\n/**\n * Initialise le systme de thme\n */\nexport function initTheme(): void {\n  // Appliquer le thme initial\n  applyTheme(store.theme);\n\n  // couter les changements de prfrence systme\n  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {\n    if (store.theme === 'auto') {\n      applyTheme('auto');\n    }\n  });\n}\n\n/**\n * Dtruit le composant\n */\nexport function destroyThemeToggle(): void {\n  button?.parentElement?.remove();\n  button = null;\n  dropdown = null;\n  isDropdownOpen = false;\n}\n","// ============================================================================\n// Composant Toast - Notifications non-bloquantes\n// ============================================================================\n\nimport type { Toast, ToastConfig } from '../../types';\nimport { generateId } from '../../utils/helpers';\n\nlet container: HTMLElement | null = null;\nconst toasts: Map<string, { element: HTMLElement; timeout: number }> = new Map();\n\nconst ICONS = {\n  success: `<svg class=\"toast-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M22 11.08V12a10 10 0 1 1-5.93-9.14\"/><polyline points=\"22 4 12 14.01 9 11.01\"/></svg>`,\n  error: `<svg class=\"toast-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><line x1=\"15\" y1=\"9\" x2=\"9\" y2=\"15\"/><line x1=\"9\" y1=\"9\" x2=\"15\" y2=\"15\"/></svg>`,\n  warning: `<svg class=\"toast-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z\"/><line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"/><line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"/></svg>`,\n  info: `<svg class=\"toast-icon\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><line x1=\"12\" y1=\"16\" x2=\"12\" y2=\"12\"/><line x1=\"12\" y1=\"8\" x2=\"12.01\" y2=\"8\"/></svg>`\n};\n\n/**\n * Initialise le conteneur de toasts\n */\nfunction initContainer(): HTMLElement {\n  if (container) return container;\n\n  container = document.createElement('div');\n  container.className = 'toast-container';\n  container.setAttribute('role', 'region');\n  container.setAttribute('aria-label', 'Notifications');\n  container.setAttribute('aria-live', 'polite');\n  document.body.appendChild(container);\n\n  return container;\n}\n\n/**\n * Affiche un toast\n */\nexport function show(config: ToastConfig): string {\n  const cont = initContainer();\n  const id = generateId();\n  const duration = config.duration ?? 4000;\n\n  const toast: Toast = {\n    ...config,\n    id,\n    createdAt: Date.now()\n  };\n\n  // Crer l'lment\n  const element = document.createElement('div');\n  element.className = `toast toast-${config.type}`;\n  element.setAttribute('role', 'alert');\n  element.dataset.toastId = id;\n\n  element.innerHTML = `\n    ${ICONS[config.type]}\n    <div class=\"toast-content\">\n      <p class=\"toast-message\">${escapeHtml(config.message)}</p>\n      ${config.action ? `\n        <button class=\"toast-action\" type=\"button\">\n          ${escapeHtml(config.action.label)}\n        </button>\n      ` : ''}\n    </div>\n    <button class=\"toast-close\" type=\"button\" aria-label=\"Fermer\">\n      <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n        <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"/>\n        <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"/>\n      </svg>\n    </button>\n  `;\n\n  // Event listeners\n  const closeBtn = element.querySelector('.toast-close');\n  closeBtn?.addEventListener('click', () => dismiss(id));\n\n  if (config.action) {\n    const actionBtn = element.querySelector('.toast-action');\n    actionBtn?.addEventListener('click', () => {\n      config.action!.callback();\n      dismiss(id);\n    });\n  }\n\n  // Ajouter au container\n  cont.appendChild(element);\n\n  // Animation d'entre\n  requestAnimationFrame(() => {\n    element.classList.add('toast-enter');\n  });\n\n  // Auto-dismiss\n  const timeout = window.setTimeout(() => {\n    dismiss(id);\n  }, duration);\n\n  toasts.set(id, { element, timeout });\n\n  // Limiter le nombre de toasts visibles\n  if (toasts.size > 5) {\n    const oldestId = toasts.keys().next().value;\n    if (oldestId) dismiss(oldestId);\n  }\n\n  return id;\n}\n\n/**\n * Ferme un toast\n */\nexport function dismiss(id: string): void {\n  const toast = toasts.get(id);\n  if (!toast) return;\n\n  clearTimeout(toast.timeout);\n\n  toast.element.classList.remove('toast-enter');\n  toast.element.classList.add('toast-exit');\n\n  toast.element.addEventListener('animationend', () => {\n    toast.element.remove();\n    toasts.delete(id);\n  }, { once: true });\n}\n\n/**\n * Ferme tous les toasts\n */\nexport function dismissAll(): void {\n  toasts.forEach((_, id) => dismiss(id));\n}\n\n// Raccourcis\nexport function success(message: string, options?: Partial<ToastConfig>): string {\n  return show({ type: 'success', message, ...options });\n}\n\nexport function error(message: string, options?: Partial<ToastConfig>): string {\n  return show({ type: 'error', message, duration: 6000, ...options });\n}\n\nexport function warning(message: string, options?: Partial<ToastConfig>): string {\n  return show({ type: 'warning', message, ...options });\n}\n\nexport function info(message: string, options?: Partial<ToastConfig>): string {\n  return show({ type: 'info', message, ...options });\n}\n\n/**\n * Toast avec action d'annulation\n */\nexport function withUndo(\n  message: string,\n  onUndo: () => void,\n  type: ToastConfig['type'] = 'info'\n): string {\n  return show({\n    type,\n    message,\n    duration: 6000,\n    action: {\n      label: 'Annuler',\n      callback: onUndo\n    }\n  });\n}\n\n/**\n * Toast de chargement (reste affich jusqu' dismiss)\n */\nexport function loading(message: string): { id: string; done: (successMessage?: string) => void } {\n  const id = show({\n    type: 'info',\n    message,\n    duration: 60000 // Long timeout\n  });\n\n  return {\n    id,\n    done: (successMessage?: string) => {\n      dismiss(id);\n      if (successMessage) {\n        success(successMessage);\n      }\n    }\n  };\n}\n\nfunction escapeHtml(text: string): string {\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n\n/**\n * Initialise le conteneur de toasts (export public)\n */\nexport function initToastContainer(): HTMLElement {\n  return initContainer();\n}\n\n/**\n * Alias pour show (compatibilit)\n */\nexport function showToast(config: ToastConfig): string {\n  return show(config);\n}\n\n// Export default pour utilisation simplifie\nexport const toast = {\n  show,\n  dismiss,\n  dismissAll,\n  success,\n  error,\n  warning,\n  info,\n  withUndo,\n  loading\n};\n\nexport default toast;\n","// ============================================================================\n// Utilitaires de calcul de distance gographique\n// ============================================================================\n\nconst EARTH_RADIUS_KM = 6371;\n\n/**\n * Convertit des degrs en radians\n */\nfunction toRadians(degrees: number): number {\n  return degrees * (Math.PI / 180);\n}\n\n/**\n * Calcule la distance entre deux points en km (formule de Haversine)\n */\nexport function haversineDistance(\n  lat1: number,\n  lon1: number,\n  lat2: number,\n  lon2: number\n): number {\n  const dLat = toRadians(lat2 - lat1);\n  const dLon = toRadians(lon2 - lon1);\n\n  const a =\n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos(toRadians(lat1)) *\n    Math.cos(toRadians(lat2)) *\n    Math.sin(dLon / 2) *\n    Math.sin(dLon / 2);\n\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n  return EARTH_RADIUS_KM * c;\n}\n\n/**\n * Formate une distance pour l'affichage\n */\nexport function formatDistance(distanceKm: number): string {\n  if (distanceKm < 1) {\n    return `${Math.round(distanceKm * 1000)} m`;\n  }\n  if (distanceKm < 10) {\n    return `${distanceKm.toFixed(1)} km`;\n  }\n  return `${Math.round(distanceKm)} km`;\n}\n\n/**\n * Vrifie si un point est dans un cercle\n */\nexport function isPointInCircle(\n  pointLat: number,\n  pointLon: number,\n  centerLat: number,\n  centerLon: number,\n  radiusKm: number\n): boolean {\n  const distance = haversineDistance(pointLat, pointLon, centerLat, centerLon);\n  return distance <= radiusKm;\n}\n\n/**\n * Vrifie si un point est dans un rectangle\n */\nexport function isPointInBounds(\n  pointLat: number,\n  pointLon: number,\n  bounds: { north: number; south: number; east: number; west: number }\n): boolean {\n  return (\n    pointLat <= bounds.north &&\n    pointLat >= bounds.south &&\n    pointLon <= bounds.east &&\n    pointLon >= bounds.west\n  );\n}\n\n/**\n * Vrifie si un point est dans un polygone (algorithme ray casting)\n */\nexport function isPointInPolygon(\n  pointLat: number,\n  pointLon: number,\n  polygon: { lat: number; lon: number }[]\n): boolean {\n  let inside = false;\n  const n = polygon.length;\n\n  for (let i = 0, j = n - 1; i < n; j = i++) {\n    const xi = polygon[i].lon;\n    const yi = polygon[i].lat;\n    const xj = polygon[j].lon;\n    const yj = polygon[j].lat;\n\n    const intersect =\n      yi > pointLat !== yj > pointLat &&\n      pointLon < ((xj - xi) * (pointLat - yi)) / (yj - yi) + xi;\n\n    if (intersect) {\n      inside = !inside;\n    }\n  }\n\n  return inside;\n}\n\n/**\n * Calcule le centre d'un ensemble de points\n */\nexport function calculateCenter(\n  points: { lat: number; lon: number }[]\n): { lat: number; lon: number } {\n  if (points.length === 0) {\n    return { lat: 0, lon: 0 };\n  }\n\n  const sum = points.reduce(\n    (acc, point) => ({\n      lat: acc.lat + point.lat,\n      lon: acc.lon + point.lon\n    }),\n    { lat: 0, lon: 0 }\n  );\n\n  return {\n    lat: sum.lat / points.length,\n    lon: sum.lon / points.length\n  };\n}\n\n/**\n * Calcule les bounds contenant tous les points\n */\nexport function calculateBounds(\n  points: { lat: number; lon: number }[]\n): { north: number; south: number; east: number; west: number } | null {\n  if (points.length === 0) {\n    return null;\n  }\n\n  let north = -Infinity;\n  let south = Infinity;\n  let east = -Infinity;\n  let west = Infinity;\n\n  for (const point of points) {\n    north = Math.max(north, point.lat);\n    south = Math.min(south, point.lat);\n    east = Math.max(east, point.lon);\n    west = Math.min(west, point.lon);\n  }\n\n  return { north, south, east, west };\n}\n\n/**\n * Ajoute un padding aux bounds\n */\nexport function padBounds(\n  bounds: { north: number; south: number; east: number; west: number },\n  paddingPercent: number = 10\n): { north: number; south: number; east: number; west: number } {\n  const latPadding = ((bounds.north - bounds.south) * paddingPercent) / 100;\n  const lonPadding = ((bounds.east - bounds.west) * paddingPercent) / 100;\n\n  return {\n    north: bounds.north + latPadding,\n    south: bounds.south - latPadding,\n    east: bounds.east + lonPadding,\n    west: bounds.west - lonPadding\n  };\n}\n\n/**\n * Calcule le bearing (direction) entre deux points en degrs\n */\nexport function calculateBearing(\n  lat1: number,\n  lon1: number,\n  lat2: number,\n  lon2: number\n): number {\n  const dLon = toRadians(lon2 - lon1);\n  const lat1Rad = toRadians(lat1);\n  const lat2Rad = toRadians(lat2);\n\n  const y = Math.sin(dLon) * Math.cos(lat2Rad);\n  const x =\n    Math.cos(lat1Rad) * Math.sin(lat2Rad) -\n    Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLon);\n\n  let bearing = Math.atan2(y, x) * (180 / Math.PI);\n  bearing = (bearing + 360) % 360;\n\n  return bearing;\n}\n\n/**\n * Convertit un bearing en direction cardinale\n */\nexport function bearingToCardinal(bearing: number): string {\n  const directions = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];\n  const index = Math.round(bearing / 45) % 8;\n  return directions[index];\n}\n\n/**\n * Calcule un nouveau point  partir d'un point, d'une distance et d'un bearing\n */\nexport function destinationPoint(\n  lat: number,\n  lon: number,\n  distanceKm: number,\n  bearingDegrees: number\n): { lat: number; lon: number } {\n  const bearing = toRadians(bearingDegrees);\n  const lat1 = toRadians(lat);\n  const lon1 = toRadians(lon);\n  const angularDistance = distanceKm / EARTH_RADIUS_KM;\n\n  const lat2 = Math.asin(\n    Math.sin(lat1) * Math.cos(angularDistance) +\n    Math.cos(lat1) * Math.sin(angularDistance) * Math.cos(bearing)\n  );\n\n  const lon2 =\n    lon1 +\n    Math.atan2(\n      Math.sin(bearing) * Math.sin(angularDistance) * Math.cos(lat1),\n      Math.cos(angularDistance) - Math.sin(lat1) * Math.sin(lat2)\n    );\n\n  return {\n    lat: lat2 * (180 / Math.PI),\n    lon: lon2 * (180 / Math.PI)\n  };\n}\n\n/**\n * Gnre des points pour dessiner un cercle sur la carte\n */\nexport function generateCirclePoints(\n  centerLat: number,\n  centerLon: number,\n  radiusKm: number,\n  numPoints: number = 64\n): { lat: number; lon: number }[] {\n  const points: { lat: number; lon: number }[] = [];\n\n  for (let i = 0; i < numPoints; i++) {\n    const bearing = (360 / numPoints) * i;\n    points.push(destinationPoint(centerLat, centerLon, radiusKm, bearing));\n  }\n\n  return points;\n}\n","// ============================================================================\r\n// Composant Map - Carte interactive Leaflet\r\n// ============================================================================\r\n\r\nimport type { Location, MarkerOptions } from '../../types';\r\nimport {\r\n  store,\r\n  on,\r\n  updateMapView,\r\n  generateLocationId,\r\n  toggleFavorite\r\n} from '../../store';\r\nimport { haversineDistance, formatDistance } from '../../utils/distance';\r\nimport { debounce } from '../../utils/helpers';\r\n\r\n// Variables du module (types any pour compatibilit CDN Leaflet)\r\nlet map: any = null;\r\nlet markersLayer: any = null;\r\nlet heatmapLayer: any = null;\r\nlet markers: Map<number, any> = new Map();\r\nlet userLocationMarker: any = null;\r\n\r\n// Configuration des icnes\r\nconst MARKER_COLORS = {\r\n  default: '#3b82f6',\r\n  matching: '#ef4444',\r\n  favorite: '#f59e0b',\r\n  selected: '#10b981'\r\n};\r\n\r\n/**\r\n * Cre une icne de marqueur personnalise\r\n */\r\nfunction createMarkerIcon(options: MarkerOptions): any {\r\n  const { color, isMatching, isFavorite, isSelected } = options;\r\n\r\n  let iconColor = color || MARKER_COLORS.default;\r\n  if (isSelected) iconColor = MARKER_COLORS.selected;\r\n  else if (isFavorite) iconColor = MARKER_COLORS.favorite;\r\n  else if (isMatching) iconColor = MARKER_COLORS.matching;\r\n\r\n  return L.divIcon({\r\n    className: 'custom-marker',\r\n    html: `\r\n      <div class=\"marker-pin\" style=\"--marker-color: ${iconColor}\">\r\n        <svg viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n          <path d=\"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z\"/>\r\n        </svg>\r\n        ${isFavorite ? '<span class=\"marker-star\"></span>' : ''}\r\n      </div>\r\n    `,\r\n    iconSize: [32, 42],\r\n    iconAnchor: [16, 42],\r\n    popupAnchor: [0, -42]\r\n  });\r\n}\r\n\r\n/**\r\n * Cre le contenu du popup\r\n */\r\nfunction createPopupContent(location: Location, index: number): string {\r\n  const id = generateLocationId(location);\r\n  const isFav = store.favorites.has(id);\r\n  const note = store.personalNotes.get(id);\r\n  const userLoc = store.userLocation;\r\n\r\n  let distanceInfo = '';\r\n  if (userLoc && location.lat && location.lon) {\r\n    const dist = haversineDistance(userLoc.lat, userLoc.lon, location.lat, location.lon);\r\n    distanceInfo = `<p class=\"popup-distance\"> ${formatDistance(dist)}</p>`;\r\n  }\r\n\r\n  return `\r\n    <div class=\"popup-content\" data-index=\"${index}\">\r\n      <div class=\"popup-header\">\r\n        <h3 class=\"popup-title\">${location.nom}</h3>\r\n        <button class=\"popup-fav-btn ${isFav ? 'active' : ''}\"\r\n                data-location-id=\"${id}\"\r\n                title=\"${isFav ? 'Retirer des favoris' : 'Ajouter aux favoris'}\">\r\n          ${isFav ? '' : ''}\r\n        </button>\r\n      </div>\r\n\r\n      <div class=\"popup-body\">\r\n        <p class=\"popup-address\">\r\n          ${location.adresse}<br>\r\n          ${location.codePostal} ${location.ville}\r\n        </p>\r\n\r\n        ${location.type ? `<p class=\"popup-type\"><span class=\"tag\">${location.type}</span></p>` : ''}\r\n        ${location.niveau ? `<p class=\"popup-level\">Niveau: ${location.niveau}</p>` : ''}\r\n        ${distanceInfo}\r\n\r\n        ${location.telephone ? `\r\n          <p class=\"popup-phone\">\r\n            <a href=\"tel:${location.telephone.replace(/\\s/g, '')}\">${location.telephone}</a>\r\n          </p>\r\n        ` : ''}\r\n\r\n        ${location.email ? `\r\n          <p class=\"popup-email\">\r\n            <a href=\"mailto:${location.email}\">${location.email}</a>\r\n          </p>\r\n        ` : ''}\r\n\r\n        ${location.contact ? `<p class=\"popup-contact\">Contact: ${location.contact}</p>` : ''}\r\n        ${location.commentaire ? `<p class=\"popup-comment\">${location.commentaire}</p>` : ''}\r\n        ${note ? `<p class=\"popup-note\"><strong>Note:</strong> ${note}</p>` : ''}\r\n      </div>\r\n\r\n      <div class=\"popup-actions\">\r\n        ${location.telephone ? `\r\n          <a href=\"tel:${location.telephone.replace(/\\s/g, '')}\" class=\"popup-btn popup-btn-call\">\r\n            <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" width=\"16\" height=\"16\">\r\n              <path d=\"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z\"/>\r\n            </svg>\r\n            Appeler\r\n          </a>\r\n        ` : ''}\r\n        <button class=\"popup-btn popup-btn-directions\"\r\n                data-lat=\"${location.lat}\"\r\n                data-lon=\"${location.lon}\"\r\n                data-name=\"${encodeURIComponent(location.nom)}\">\r\n           Itinraire\r\n        </button>\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\n/**\r\n * Initialise la carte\r\n */\r\nexport function initMap(container: HTMLElement): any {\r\n  // Crer la carte\r\n  map = L.map(container, {\r\n    center: [store.mapCenter.lat, store.mapCenter.lon],\r\n    zoom: store.mapZoom,\r\n    zoomControl: true,\r\n    attributionControl: true\r\n  });\r\n\r\n  // Ajouter le tile layer\r\n  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n    attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a>',\r\n    maxZoom: 19\r\n  }).addTo(map);\r\n\r\n  // Crer le groupe de clusters avec configuration optimise\r\n  markersLayer = L.markerClusterGroup({\r\n    // Performances\r\n    chunkedLoading: true,\r\n    chunkInterval: 200,\r\n    chunkDelay: 50,\r\n    removeOutsideVisibleBounds: true,\r\n    animate: true,\r\n    animateAddingMarkers: false,\r\n\r\n    // Comportement\r\n    maxClusterRadius: 60,\r\n    spiderfyOnMaxZoom: true,\r\n    spiderfyDistanceMultiplier: 1.5,\r\n    showCoverageOnHover: true,\r\n    zoomToBoundsOnClick: true,\r\n    disableClusteringAtZoom: 18,\r\n\r\n    // Icne personnalise avec infos\r\n    iconCreateFunction: (cluster: any) => {\r\n      const count = cluster.getChildCount();\r\n      const markers = cluster.getAllChildMarkers();\r\n\r\n      // Calculer les stats du cluster\r\n      let matchingCount = 0;\r\n      let favoriteCount = 0;\r\n      const types = new Set<string>();\r\n\r\n      markers.forEach((marker: any) => {\r\n        const clusterIndex = (window as any).__clusterMarkerIndex as Map<number, any> | undefined;\r\n        const idx = Array.from(clusterIndex?.entries() || [])\r\n          .find(([_, m]: [number, any]) => m === marker)?.[0];\r\n        if (idx !== undefined) {\r\n          const loc = store.locations[idx];\r\n          if (loc) {\r\n            types.add(loc.type);\r\n            if (store.filteredIndices.includes(idx)) matchingCount++;\r\n            if (store.favorites.has(generateLocationId(loc))) favoriteCount++;\r\n          }\r\n        }\r\n      });\r\n\r\n      // Dterminer la taille et couleur\r\n      let sizeClass = 'small';\r\n      let size = 40;\r\n      if (count > 100) { sizeClass = 'xlarge'; size = 60; }\r\n      else if (count > 50) { sizeClass = 'large'; size = 50; }\r\n      else if (count > 20) { sizeClass = 'medium'; size = 45; }\r\n\r\n      // Couleur base sur le ratio de correspondance\r\n      const matchRatio = count > 0 ? matchingCount / count : 0;\r\n      let colorClass = 'default';\r\n      if (matchRatio > 0.7) colorClass = 'hot';\r\n      else if (matchRatio > 0.3) colorClass = 'warm';\r\n\r\n      // Indicateur de favoris\r\n      const favIndicator = favoriteCount > 0\r\n        ? `<span class=\"cluster-fav\">${favoriteCount}</span>`\r\n        : '';\r\n\r\n      return L.divIcon({\r\n        html: `\r\n          <div class=\"cluster-marker cluster-${sizeClass} cluster-${colorClass}\">\r\n            <span class=\"cluster-count\">${count}</span>\r\n            ${favIndicator}\r\n          </div>\r\n        `,\r\n        className: 'marker-cluster-custom',\r\n        iconSize: L.point(size, size)\r\n      });\r\n    }\r\n  });\r\n\r\n  // Stocker la rfrence des marqueurs pour le cluster\r\n  (window as any).__clusterMarkerIndex = markers;\r\n\r\n  map.addLayer(markersLayer);\r\n\r\n  // vnements des clusters\r\n  markersLayer.on('clustermouseover', (e: any) => {\r\n    const cluster = e.layer;\r\n    const count = cluster.getChildCount();\r\n    const markers = cluster.getAllChildMarkers();\r\n\r\n    // Collecter les infos des lieux\r\n    const cities = new Map<string, number>();\r\n    const types = new Map<string, number>();\r\n    let matchingCount = 0;\r\n\r\n    markers.forEach((marker: any) => {\r\n      const clusterIndex = (window as any).__clusterMarkerIndex as Map<number, any> | undefined;\r\n      const idx = Array.from(clusterIndex?.entries() || [])\r\n        .find(([_, m]: [number, any]) => m === marker)?.[0];\r\n      if (idx !== undefined) {\r\n        const loc = store.locations[idx];\r\n        if (loc) {\r\n          cities.set(loc.ville, (cities.get(loc.ville) || 0) + 1);\r\n          types.set(loc.type, (types.get(loc.type) || 0) + 1);\r\n          if (store.filteredIndices.includes(idx)) matchingCount++;\r\n        }\r\n      }\r\n    });\r\n\r\n    // Top 3 villes\r\n    const topCities = Array.from(cities.entries())\r\n      .sort((a, b) => b[1] - a[1])\r\n      .slice(0, 3)\r\n      .map(([city, n]) => `${city} (${n})`)\r\n      .join(', ');\r\n\r\n    // Top 3 types\r\n    const topTypes = Array.from(types.entries())\r\n      .sort((a, b) => b[1] - a[1])\r\n      .slice(0, 3)\r\n      .map(([type, n]) => `${type} (${n})`)\r\n      .join(', ');\r\n\r\n    const tooltipContent = `\r\n      <div class=\"cluster-tooltip\">\r\n        <strong>${count} tablissements</strong>\r\n        ${matchingCount > 0 ? `<br><span class=\"cluster-tooltip-match\"> ${matchingCount} correspondent aux filtres</span>` : ''}\r\n        <hr>\r\n        <small><strong>Villes:</strong> ${topCities || 'N/A'}</small><br>\r\n        <small><strong>Types:</strong> ${topTypes || 'N/A'}</small>\r\n      </div>\r\n    `;\r\n\r\n    cluster.bindTooltip(tooltipContent, {\r\n      direction: 'top',\r\n      className: 'cluster-tooltip-container',\r\n      offset: [0, -20]\r\n    }).openTooltip();\r\n  });\r\n\r\n  markersLayer.on('clustermouseout', (e: any) => {\r\n    e.layer.closeTooltip();\r\n  });\r\n\r\n  // vnements de la carte\r\n  const debouncedMapMove = debounce(() => {\r\n    if (map) {\r\n      const center = map.getCenter();\r\n      updateMapView({ lat: center.lat, lon: center.lng }, map.getZoom());\r\n    }\r\n  }, 300);\r\n\r\n  map.on('moveend', debouncedMapMove);\r\n  map.on('zoomend', debouncedMapMove);\r\n\r\n  // Gestionnaire de clic sur les popups\r\n  map.on('popupopen', (e: any) => {\r\n    const popup = e.popup;\r\n    const content = popup.getElement();\r\n    if (!content) return;\r\n\r\n    // Bouton favori\r\n    content.querySelectorAll('.popup-fav-btn').forEach((btn: Element) => {\r\n      btn.addEventListener('click', (event: Event) => {\r\n        event.stopPropagation();\r\n        const locationId = (btn as HTMLElement).dataset.locationId;\r\n        if (locationId) {\r\n          toggleFavorite(locationId);\r\n          btn.classList.toggle('active');\r\n          btn.textContent = btn.classList.contains('active') ? '' : '';\r\n        }\r\n      });\r\n    });\r\n\r\n    // Bouton itinraire\r\n    content.querySelectorAll('.popup-btn-directions').forEach((btn: Element) => {\r\n      btn.addEventListener('click', () => {\r\n        const lat = (btn as HTMLElement).dataset.lat;\r\n        const lon = (btn as HTMLElement).dataset.lon;\r\n        const name = decodeURIComponent((btn as HTMLElement).dataset.name || '');\r\n        if (lat && lon) {\r\n          const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&destination_place_id=${name}`;\r\n          window.open(url, '_blank');\r\n        }\r\n      });\r\n    });\r\n  });\r\n\r\n  // couter les vnements du store\r\n  setupStoreListeners();\r\n\r\n  return map;\r\n}\r\n\r\n/**\r\n * Configure les couteurs d'vnements du store\r\n */\r\nfunction setupStoreListeners(): void {\r\n  // Donnes charges\r\n  on('DATA_LOADED', () => {\r\n    refreshMarkers();\r\n    fitToMarkers();\r\n  });\r\n\r\n  // Filtres changs\r\n  on('FILTER_CHANGED', () => {\r\n    updateMarkerStyles();\r\n  });\r\n\r\n  // Lieu slectionn\r\n  on('LOCATION_SELECTED', (event) => {\r\n    const index = event.payload;\r\n    if (index !== null) {\r\n      focusOnMarker(index);\r\n    }\r\n  });\r\n\r\n  // Favori bascul\r\n  on('FAVORITE_TOGGLED', () => {\r\n    updateMarkerStyles();\r\n  });\r\n}\r\n\r\n/**\r\n * Rafrachit tous les marqueurs\r\n */\r\nexport function refreshMarkers(): void {\r\n  if (!markersLayer) return;\r\n\r\n  markersLayer.clearLayers();\r\n  markers.clear();\r\n\r\n  const { locations, filteredIndices, favorites } = store;\r\n  const filteredSet = new Set(filteredIndices);\r\n\r\n  locations.forEach((location, index) => {\r\n    if (location.lat === null || location.lon === null) return;\r\n\r\n    const id = generateLocationId(location);\r\n    const isMatching = filteredSet.has(index);\r\n    const isFavorite = favorites.has(id);\r\n    const isSelected = store.selectedLocationIndex === index;\r\n\r\n    const icon = createMarkerIcon({\r\n      color: MARKER_COLORS.default,\r\n      isMatching,\r\n      isFavorite,\r\n      isSelected\r\n    });\r\n\r\n    const marker = L.marker([location.lat, location.lon], { icon });\r\n    marker.bindPopup(() => createPopupContent(location, index), {\r\n      maxWidth: 320,\r\n      className: 'custom-popup'\r\n    });\r\n\r\n    marker.on('click', () => {\r\n      window.dispatchEvent(new CustomEvent('location-selected', { detail: { index } }));\r\n    });\r\n\r\n    markers.set(index, marker);\r\n    markersLayer!.addLayer(marker);\r\n  });\r\n}\r\n\r\n/**\r\n * Met  jour le style des marqueurs sans les recrer\r\n */\r\nfunction updateMarkerStyles(): void {\r\n  const { filteredIndices, favorites, selectedLocationIndex, locations } = store;\r\n  const filteredSet = new Set(filteredIndices);\r\n\r\n  markers.forEach((marker, index) => {\r\n    const location = locations[index];\r\n    if (!location) return;\r\n\r\n    const id = generateLocationId(location);\r\n    const isMatching = filteredSet.has(index);\r\n    const isFavorite = favorites.has(id);\r\n    const isSelected = selectedLocationIndex === index;\r\n\r\n    const icon = createMarkerIcon({\r\n      color: MARKER_COLORS.default,\r\n      isMatching,\r\n      isFavorite,\r\n      isSelected\r\n    });\r\n\r\n    marker.setIcon(icon);\r\n  });\r\n}\r\n\r\n/**\r\n * Focus sur un marqueur spcifique\r\n */\r\nexport function focusOnMarker(index: number, options: { zoom?: number; openPopup?: boolean } = {}): void {\r\n  const marker = markers.get(index);\r\n  if (!marker || !map) return;\r\n\r\n  const { zoom = 15, openPopup = true } = options;\r\n  const latLng = marker.getLatLng();\r\n\r\n  map.setView(latLng, zoom, { animate: true });\r\n\r\n  if (openPopup) {\r\n    // Attendre la fin de l'animation\r\n    setTimeout(() => {\r\n      marker.openPopup();\r\n    }, 300);\r\n  }\r\n\r\n  // Mettre  jour le style\r\n  updateMarkerStyles();\r\n}\r\n\r\n/**\r\n * Ajuste la vue pour afficher tous les marqueurs filtrs\r\n */\r\nexport function fitToMarkers(padding: number = 50): void {\r\n  if (!map || !markersLayer) return;\r\n\r\n  const { locations, filteredIndices } = store;\r\n  const points: any[] = [];\r\n\r\n  filteredIndices.forEach(index => {\r\n    const location = locations[index];\r\n    if (location.lat !== null && location.lon !== null) {\r\n      points.push(L.latLng(location.lat, location.lon));\r\n    }\r\n  });\r\n\r\n  if (points.length === 0) return;\r\n\r\n  if (points.length === 1) {\r\n    map.setView(points[0], 14);\r\n  } else {\r\n    const bounds = L.latLngBounds(points);\r\n    map.fitBounds(bounds, { padding: [padding, padding] });\r\n  }\r\n}\r\n\r\n/**\r\n * Active/dsactive la heatmap\r\n */\r\nexport function toggleHeatmap(enabled: boolean): void {\r\n  if (!map) return;\r\n\r\n  if (enabled) {\r\n    const { locations, filteredIndices } = store;\r\n    const heatData: [number, number, number][] = [];\r\n\r\n    filteredIndices.forEach(index => {\r\n      const location = locations[index];\r\n      if (location.lat !== null && location.lon !== null) {\r\n        heatData.push([location.lat, location.lon, 1]);\r\n      }\r\n    });\r\n\r\n    if (heatmapLayer) {\r\n      map.removeLayer(heatmapLayer);\r\n    }\r\n\r\n    heatmapLayer = (L as any).heatLayer(heatData, {\r\n      radius: 25,\r\n      blur: 15,\r\n      maxZoom: 17,\r\n      gradient: {\r\n        0.4: 'blue',\r\n        0.6: 'cyan',\r\n        0.7: 'lime',\r\n        0.8: 'yellow',\r\n        1.0: 'red'\r\n      }\r\n    }).addTo(map);\r\n  } else if (heatmapLayer) {\r\n    map.removeLayer(heatmapLayer);\r\n    heatmapLayer = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Active/dsactive le clustering\r\n */\r\nexport function toggleClustering(enabled: boolean): void {\r\n  if (!map || !markersLayer) return;\r\n\r\n  if (enabled) {\r\n    markersLayer.enableClustering();\r\n  } else {\r\n    markersLayer.disableClustering();\r\n  }\r\n}\r\n\r\n/**\r\n * Affiche la position de l'utilisateur\r\n */\r\nexport function showUserLocation(lat: number, lon: number): void {\r\n  if (!map) return;\r\n\r\n  if (userLocationMarker) {\r\n    map.removeLayer(userLocationMarker);\r\n  }\r\n\r\n  const icon = L.divIcon({\r\n    className: 'user-location-marker',\r\n    html: `\r\n      <div class=\"user-location-pulse\"></div>\r\n      <div class=\"user-location-dot\"></div>\r\n    `,\r\n    iconSize: [24, 24],\r\n    iconAnchor: [12, 12]\r\n  });\r\n\r\n  userLocationMarker = L.marker([lat, lon], { icon }).addTo(map);\r\n  userLocationMarker.bindPopup('Votre position');\r\n}\r\n\r\n/**\r\n * Centre la carte sur la position de l'utilisateur\r\n */\r\nexport function centerOnUserLocation(): void {\r\n  if (!map || !store.userLocation) return;\r\n  map.setView([store.userLocation.lat, store.userLocation.lon], 14, { animate: true });\r\n}\r\n\r\n/**\r\n * Retourne l'instance de la carte\r\n */\r\nexport function getMap(): any {\r\n  return map;\r\n}\r\n\r\n/**\r\n * Invalide la taille de la carte ( appeler aprs redimensionnement)\r\n */\r\nexport function invalidateSize(): void {\r\n  if (map) {\r\n    setTimeout(() => map!.invalidateSize(), 100);\r\n  }\r\n}\r\n\r\n/**\r\n * Dtruit la carte\r\n */\r\nexport function destroyMap(): void {\r\n  if (map) {\r\n    map.remove();\r\n    map = null;\r\n  }\r\n  markersLayer = null;\r\n  heatmapLayer = null;\r\n  markers.clear();\r\n  userLocationMarker = null;\r\n}\r\n","// ============================================================================\n// Composant d'authentification admin\n// ============================================================================\n\nconst ADMIN_CODE_KEY = 'admin_code_hash';\nconst SESSION_KEY = 'admin_session';\nconst DEFAULT_CODE = 'admin2024';\n\n/**\n * Hash simple pour le code d'accs (non cryptographique, juste obfuscation)\n */\nfunction hashCode(str: string): string {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return hash.toString(36);\n}\n\n/**\n * Vrifie si le code stock existe, sinon initialise avec le dfaut\n */\nfunction ensureCodeExists(): void {\n  if (!localStorage.getItem(ADMIN_CODE_KEY)) {\n    localStorage.setItem(ADMIN_CODE_KEY, hashCode(DEFAULT_CODE));\n  }\n}\n\n/**\n * Vrifie si l'utilisateur est authentifi pour la session\n */\nexport function isAuthenticated(): boolean {\n  return sessionStorage.getItem(SESSION_KEY) === 'true';\n}\n\n/**\n * Vrifie le code d'accs\n */\nexport function verifyCode(code: string): boolean {\n  ensureCodeExists();\n  const storedHash = localStorage.getItem(ADMIN_CODE_KEY);\n  return hashCode(code) === storedHash;\n}\n\n/**\n * Authentifie l'utilisateur pour la session\n */\nexport function authenticate(code: string): boolean {\n  if (verifyCode(code)) {\n    sessionStorage.setItem(SESSION_KEY, 'true');\n    return true;\n  }\n  return false;\n}\n\n/**\n * Dconnecte l'utilisateur\n */\nexport function logout(): void {\n  sessionStorage.removeItem(SESSION_KEY);\n}\n\n/**\n * Change le code d'accs\n */\nexport function changeCode(oldCode: string, newCode: string): boolean {\n  if (!verifyCode(oldCode)) {\n    return false;\n  }\n  if (newCode.length < 4) {\n    return false;\n  }\n  localStorage.setItem(ADMIN_CODE_KEY, hashCode(newCode));\n  return true;\n}\n\n/**\n * Cre le modal d'authentification\n */\nexport function createAuthModal(onSuccess: () => void): HTMLElement {\n  const modal = document.createElement('div');\n  modal.className = 'admin-auth-modal';\n  modal.innerHTML = `\n    <div class=\"admin-auth-content\">\n      <div class=\"admin-auth-header\">\n        <i class=\"fas fa-lock\"></i>\n        <h3>Accs Administration</h3>\n      </div>\n      <p class=\"admin-auth-desc\">Entrez le code d'accs pour grer les lieux de stage.</p>\n      <div class=\"admin-auth-input-group\">\n        <input type=\"password\"\n               class=\"admin-auth-input\"\n               placeholder=\"Code d'accs\"\n               autocomplete=\"off\"\n               id=\"adminCodeInput\">\n        <button type=\"button\" class=\"admin-auth-toggle\" title=\"Afficher/masquer\">\n          <i class=\"fas fa-eye\"></i>\n        </button>\n      </div>\n      <p class=\"admin-auth-error\" style=\"display: none;\">\n        <i class=\"fas fa-exclamation-circle\"></i>\n        Code incorrect\n      </p>\n      <div class=\"admin-auth-buttons\">\n        <button type=\"button\" class=\"admin-auth-btn admin-auth-btn-cancel\">\n          Annuler\n        </button>\n        <button type=\"button\" class=\"admin-auth-btn admin-auth-btn-submit\">\n          <i class=\"fas fa-unlock\"></i> Valider\n        </button>\n      </div>\n    </div>\n  `;\n\n  const input = modal.querySelector('.admin-auth-input') as HTMLInputElement;\n  const toggleBtn = modal.querySelector('.admin-auth-toggle') as HTMLButtonElement;\n  const errorEl = modal.querySelector('.admin-auth-error') as HTMLElement;\n  const cancelBtn = modal.querySelector('.admin-auth-btn-cancel') as HTMLButtonElement;\n  const submitBtn = modal.querySelector('.admin-auth-btn-submit') as HTMLButtonElement;\n\n  // Toggle password visibility\n  toggleBtn.addEventListener('click', () => {\n    const isPassword = input.type === 'password';\n    input.type = isPassword ? 'text' : 'password';\n    toggleBtn.innerHTML = `<i class=\"fas fa-eye${isPassword ? '-slash' : ''}\"></i>`;\n  });\n\n  // Validate on submit\n  const validate = () => {\n    const code = input.value.trim();\n    if (authenticate(code)) {\n      modal.remove();\n      onSuccess();\n    } else {\n      errorEl.style.display = 'flex';\n      input.classList.add('error');\n      input.focus();\n      input.select();\n    }\n  };\n\n  submitBtn.addEventListener('click', validate);\n\n  input.addEventListener('keydown', (e) => {\n    if (e.key === 'Enter') {\n      e.preventDefault();\n      validate();\n    }\n    // Clear error on input\n    errorEl.style.display = 'none';\n    input.classList.remove('error');\n  });\n\n  // Cancel\n  cancelBtn.addEventListener('click', () => {\n    modal.remove();\n  });\n\n  // Close on backdrop click\n  modal.addEventListener('click', (e) => {\n    if (e.target === modal) {\n      modal.remove();\n    }\n  });\n\n  // Focus input when shown\n  setTimeout(() => input.focus(), 100);\n\n  return modal;\n}\n\n/**\n * Affiche le modal d'authentification si ncessaire\n */\nexport function requireAuth(onSuccess: () => void): void {\n  if (isAuthenticated()) {\n    onSuccess();\n    return;\n  }\n\n  const modal = createAuthModal(onSuccess);\n  document.body.appendChild(modal);\n}\n\n/**\n * Cre le formulaire de changement de code\n */\nexport function createChangeCodeForm(container: HTMLElement): void {\n  container.innerHTML = `\n    <div class=\"admin-change-code\">\n      <h4><i class=\"fas fa-key\"></i> Changer le code d'accs</h4>\n      <div class=\"admin-form-group\">\n        <label for=\"oldCodeInput\">Code actuel</label>\n        <input type=\"password\" id=\"oldCodeInput\" class=\"admin-input\" autocomplete=\"off\">\n      </div>\n      <div class=\"admin-form-group\">\n        <label for=\"newCodeInput\">Nouveau code (min. 4 caractres)</label>\n        <input type=\"password\" id=\"newCodeInput\" class=\"admin-input\" autocomplete=\"off\">\n      </div>\n      <div class=\"admin-form-group\">\n        <label for=\"confirmCodeInput\">Confirmer le nouveau code</label>\n        <input type=\"password\" id=\"confirmCodeInput\" class=\"admin-input\" autocomplete=\"off\">\n      </div>\n      <p class=\"admin-change-code-message\" style=\"display: none;\"></p>\n      <button type=\"button\" class=\"admin-btn admin-btn-primary\" id=\"changeCodeBtn\">\n        <i class=\"fas fa-save\"></i> Enregistrer\n      </button>\n    </div>\n  `;\n\n  const oldInput = container.querySelector('#oldCodeInput') as HTMLInputElement;\n  const newInput = container.querySelector('#newCodeInput') as HTMLInputElement;\n  const confirmInput = container.querySelector('#confirmCodeInput') as HTMLInputElement;\n  const messageEl = container.querySelector('.admin-change-code-message') as HTMLElement;\n  const submitBtn = container.querySelector('#changeCodeBtn') as HTMLButtonElement;\n\n  submitBtn.addEventListener('click', () => {\n    const oldCode = oldInput.value.trim();\n    const newCode = newInput.value.trim();\n    const confirmCode = confirmInput.value.trim();\n\n    messageEl.style.display = 'block';\n\n    if (!oldCode || !newCode || !confirmCode) {\n      messageEl.className = 'admin-change-code-message error';\n      messageEl.textContent = 'Tous les champs sont obligatoires';\n      return;\n    }\n\n    if (newCode !== confirmCode) {\n      messageEl.className = 'admin-change-code-message error';\n      messageEl.textContent = 'Les codes ne correspondent pas';\n      return;\n    }\n\n    if (newCode.length < 4) {\n      messageEl.className = 'admin-change-code-message error';\n      messageEl.textContent = 'Le nouveau code doit faire au moins 4 caractres';\n      return;\n    }\n\n    if (changeCode(oldCode, newCode)) {\n      messageEl.className = 'admin-change-code-message success';\n      messageEl.textContent = 'Code modifi avec succs';\n      oldInput.value = '';\n      newInput.value = '';\n      confirmInput.value = '';\n    } else {\n      messageEl.className = 'admin-change-code-message error';\n      messageEl.textContent = 'Code actuel incorrect';\n    }\n  });\n}\n","// ============================================================================\n// Service de gocodage (BAN + Nominatim)\n// ============================================================================\n\nimport type { GeocodingResult } from '../types';\nimport { setSessionCache, getSessionCache } from './storage.service';\n\nconst BAN_API_URL = 'https://api-adresse.data.gouv.fr/search/';\nconst NOMINATIM_API_URL = 'https://nominatim.openstreetmap.org/search';\n\n/**\n * Gocode une adresse en utilisant l'API BAN puis Nominatim en fallback\n */\nexport async function geocodeAddress(\n  adresse: string,\n  codePostal: string,\n  ville: string\n): Promise<GeocodingResult | null> {\n  const cacheKey = `geo:${adresse}:${codePostal}:${ville}`;\n  const cached = getSessionCache<GeocodingResult>(cacheKey);\n  if (cached) return cached;\n\n  // Essayer l'API BAN d'abord (meilleure qualit pour la France)\n  const banResult = await geocodeWithBAN(adresse, codePostal, ville);\n  if (banResult) {\n    setSessionCache(cacheKey, banResult, 30 * 60 * 1000); // 30 min\n    return banResult;\n  }\n\n  // Fallback sur Nominatim\n  const nominatimResult = await geocodeWithNominatim(adresse, codePostal, ville);\n  if (nominatimResult) {\n    setSessionCache(cacheKey, nominatimResult, 30 * 60 * 1000);\n    return nominatimResult;\n  }\n\n  return null;\n}\n\n/**\n * Gocode avec l'API BAN (Base Adresse Nationale)\n */\nasync function geocodeWithBAN(\n  adresse: string,\n  codePostal: string,\n  ville: string\n): Promise<GeocodingResult | null> {\n  try {\n    const query = `${adresse} ${codePostal} ${ville}`;\n    const url = new URL(BAN_API_URL);\n    url.searchParams.set('q', query);\n    url.searchParams.set('limit', '1');\n    if (codePostal) {\n      url.searchParams.set('postcode', codePostal);\n    }\n\n    const response = await fetch(url.toString());\n    if (!response.ok) {\n      throw new Error(`BAN API error: ${response.status}`);\n    }\n\n    const data = await response.json();\n\n    if (data.features && data.features.length > 0) {\n      const feature = data.features[0];\n      const [lon, lat] = feature.geometry.coordinates;\n      const score = feature.properties.score || 0;\n\n      // Seuil de confiance minimum\n      if (score < 0.3) {\n        return null;\n      }\n\n      return {\n        lat,\n        lon,\n        confidence: score,\n        source: 'ban',\n        label: feature.properties.label\n      };\n    }\n\n    return null;\n  } catch (error) {\n    console.warn('Erreur API BAN:', error);\n    return null;\n  }\n}\n\n/**\n * Gocode avec Nominatim (OpenStreetMap)\n */\nasync function geocodeWithNominatim(\n  adresse: string,\n  codePostal: string,\n  ville: string\n): Promise<GeocodingResult | null> {\n  try {\n    const query = `${adresse}, ${codePostal} ${ville}, France`;\n    const url = new URL(NOMINATIM_API_URL);\n    url.searchParams.set('q', query);\n    url.searchParams.set('format', 'json');\n    url.searchParams.set('limit', '1');\n    url.searchParams.set('countrycodes', 'fr');\n\n    const response = await fetch(url.toString(), {\n      headers: {\n        'User-Agent': 'CarteStages/2.0'\n      }\n    });\n\n    if (!response.ok) {\n      throw new Error(`Nominatim API error: ${response.status}`);\n    }\n\n    const data = await response.json();\n\n    if (data && data.length > 0) {\n      const result = data[0];\n      const importance = parseFloat(result.importance) || 0;\n\n      return {\n        lat: parseFloat(result.lat),\n        lon: parseFloat(result.lon),\n        confidence: importance,\n        source: 'nominatim',\n        label: result.display_name\n      };\n    }\n\n    return null;\n  } catch (error) {\n    console.warn('Erreur Nominatim:', error);\n    return null;\n  }\n}\n\n/**\n * Gocode par code postal uniquement (centre-ville)\n */\nexport async function geocodePostalCode(codePostal: string): Promise<GeocodingResult | null> {\n  const cacheKey = `geo:cp:${codePostal}`;\n  const cached = getSessionCache<GeocodingResult>(cacheKey);\n  if (cached) return cached;\n\n  try {\n    const url = new URL(BAN_API_URL);\n    url.searchParams.set('q', codePostal);\n    url.searchParams.set('type', 'municipality');\n    url.searchParams.set('limit', '1');\n\n    const response = await fetch(url.toString());\n    if (!response.ok) {\n      return null;\n    }\n\n    const data = await response.json();\n\n    if (data.features && data.features.length > 0) {\n      const feature = data.features[0];\n      const [lon, lat] = feature.geometry.coordinates;\n\n      const result: GeocodingResult = {\n        lat,\n        lon,\n        confidence: 0.8,\n        source: 'ban',\n        label: feature.properties.label\n      };\n\n      setSessionCache(cacheKey, result, 60 * 60 * 1000); // 1h\n      return result;\n    }\n\n    return null;\n  } catch (error) {\n    console.warn('Erreur gocodage code postal:', error);\n    return null;\n  }\n}\n\n/**\n * Gocodage inverse (coordonnes  adresse)\n */\nexport async function reverseGeocode(\n  lat: number,\n  lon: number\n): Promise<{ adresse: string; ville: string; codePostal: string } | null> {\n  const cacheKey = `geo:rev:${lat.toFixed(5)}:${lon.toFixed(5)}`;\n  const cached = getSessionCache<{ adresse: string; ville: string; codePostal: string }>(cacheKey);\n  if (cached) return cached;\n\n  try {\n    const url = `https://api-adresse.data.gouv.fr/reverse/?lon=${lon}&lat=${lat}`;\n    const response = await fetch(url);\n\n    if (!response.ok) {\n      return null;\n    }\n\n    const data = await response.json();\n\n    if (data.features && data.features.length > 0) {\n      const props = data.features[0].properties;\n\n      const result = {\n        adresse: props.name || '',\n        ville: props.city || '',\n        codePostal: props.postcode || ''\n      };\n\n      setSessionCache(cacheKey, result, 60 * 60 * 1000);\n      return result;\n    }\n\n    return null;\n  } catch (error) {\n    console.warn('Erreur gocodage inverse:', error);\n    return null;\n  }\n}\n\n/**\n * Recherche d'autocompltion d'adresses\n */\nexport async function autocompleteAddress(query: string): Promise<{\n  label: string;\n  lat: number;\n  lon: number;\n  type: string;\n}[]> {\n  if (query.length < 3) {\n    return [];\n  }\n\n  const cacheKey = `geo:auto:${query}`;\n  const cached = getSessionCache<{ label: string; lat: number; lon: number; type: string }[]>(cacheKey);\n  if (cached) return cached;\n\n  try {\n    const url = new URL(BAN_API_URL);\n    url.searchParams.set('q', query);\n    url.searchParams.set('limit', '5');\n    url.searchParams.set('autocomplete', '1');\n\n    const response = await fetch(url.toString());\n    if (!response.ok) {\n      return [];\n    }\n\n    const data = await response.json();\n\n    const results = (data.features || []).map((feature: any) => ({\n      label: feature.properties.label,\n      lat: feature.geometry.coordinates[1],\n      lon: feature.geometry.coordinates[0],\n      type: feature.properties.type\n    }));\n\n    setSessionCache(cacheKey, results, 5 * 60 * 1000);\n    return results;\n  } catch (error) {\n    console.warn('Erreur autocompltion:', error);\n    return [];\n  }\n}\n\n/**\n * Recherche de communes\n */\nexport async function searchCommunes(query: string): Promise<{\n  nom: string;\n  codePostal: string;\n  codeDepartement: string;\n  lat: number;\n  lon: number;\n}[]> {\n  if (query.length < 2) {\n    return [];\n  }\n\n  try {\n    const url = new URL(BAN_API_URL);\n    url.searchParams.set('q', query);\n    url.searchParams.set('type', 'municipality');\n    url.searchParams.set('limit', '10');\n\n    const response = await fetch(url.toString());\n    if (!response.ok) {\n      return [];\n    }\n\n    const data = await response.json();\n\n    return (data.features || []).map((feature: any) => ({\n      nom: feature.properties.city || feature.properties.name,\n      codePostal: feature.properties.postcode || '',\n      codeDepartement: feature.properties.context?.split(',')[0]?.trim() || '',\n      lat: feature.geometry.coordinates[1],\n      lon: feature.geometry.coordinates[0]\n    }));\n  } catch (error) {\n    console.warn('Erreur recherche communes:', error);\n    return [];\n  }\n}\n\n/**\n * Gocode plusieurs adresses en batch (avec rate limiting)\n */\nexport async function batchGeocode(\n  items: { adresse: string; codePostal: string; ville: string }[],\n  onProgress?: (current: number, total: number) => void\n): Promise<(GeocodingResult | null)[]> {\n  const results: (GeocodingResult | null)[] = [];\n  const total = items.length;\n\n  for (let i = 0; i < items.length; i++) {\n    const item = items[i];\n    const result = await geocodeAddress(item.adresse, item.codePostal, item.ville);\n    results.push(result);\n\n    if (onProgress) {\n      onProgress(i + 1, total);\n    }\n\n    // Rate limiting: 100ms entre chaque requte\n    if (i < items.length - 1) {\n      await new Promise(resolve => setTimeout(resolve, 100));\n    }\n  }\n\n  return results;\n}\n","// ============================================================================\n// Formulaire d'ajout/modification de lieu de stage\n// ============================================================================\n\nimport type { Location } from '../../types';\nimport { geocodeAddress, autocompleteAddress } from '../../services/geocoding.service';\nimport { findSimilarLocations, getAllLocations } from '../../services/data.service';\nimport { store } from '../../store';\n\ninterface AddressSuggestion {\n  label: string;\n  lat: number;\n  lon: number;\n  type: string;\n}\n\nexport interface LocationFormOptions {\n  location?: Location;\n  index?: number;\n  onSave: (location: Location, index?: number) => void;\n  onCancel: () => void;\n}\n\n/**\n * Cre le formulaire d'ajout/modification\n */\nexport function createLocationForm(container: HTMLElement, options: LocationFormOptions): void {\n  const { location, index, onSave, onCancel } = options;\n  const isEdit = index !== undefined;\n  const types = store.uniqueTypes;\n\n  container.innerHTML = `\n    <form class=\"admin-location-form\" id=\"locationForm\">\n      <h3 class=\"admin-form-title\">\n        <i class=\"fas fa-${isEdit ? 'edit' : 'plus-circle'}\"></i>\n        ${isEdit ? 'Modifier le lieu' : 'Ajouter un nouveau lieu'}\n      </h3>\n\n      <div class=\"admin-form-section\">\n        <h4><i class=\"fas fa-building\"></i> Informations gnrales</h4>\n\n        <div class=\"admin-form-row\">\n          <div class=\"admin-form-group admin-form-group-large\">\n            <label for=\"nom\">Nom de l'tablissement *</label>\n            <input type=\"text\" id=\"nom\" name=\"nom\" class=\"admin-input\" required\n                   value=\"${escapeHtml(location?.nom || '')}\"\n                   placeholder=\"Ex: Restaurant Le Bon Got\">\n            <span class=\"admin-form-error\" id=\"nomError\"></span>\n          </div>\n          <div class=\"admin-form-group\">\n            <label for=\"type\">Type d'tablissement *</label>\n            <select id=\"type\" name=\"type\" class=\"admin-input\" required>\n              <option value=\"\">-- Slectionner --</option>\n              ${types.map(t => `<option value=\"${escapeHtml(t)}\" ${location?.type === t ? 'selected' : ''}>${escapeHtml(t)}</option>`).join('')}\n              <option value=\"__autre__\">Autre (saisir)</option>\n            </select>\n            <input type=\"text\" id=\"typeAutre\" class=\"admin-input admin-input-autre\" style=\"display: none;\"\n                   placeholder=\"Saisir le nouveau type\">\n          </div>\n        </div>\n\n        <div class=\"admin-form-row\">\n          <div class=\"admin-form-group\">\n            <label for=\"niveau\">Niveau</label>\n            <select id=\"niveau\" name=\"niveau\" class=\"admin-input\">\n              <option value=\"\">-- Non spcifi --</option>\n              <option value=\"1\" ${location?.niveau === '1' ? 'selected' : ''}>Niveau 1</option>\n              <option value=\"2\" ${location?.niveau === '2' ? 'selected' : ''}>Niveau 2</option>\n              <option value=\"3\" ${location?.niveau === '3' ? 'selected' : ''}>Niveau 3</option>\n              <option value=\"4\" ${location?.niveau === '4' ? 'selected' : ''}>Niveau 4</option>\n              <option value=\"5\" ${location?.niveau === '5' ? 'selected' : ''}>Niveau 5</option>\n            </select>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"admin-form-section\">\n        <h4><i class=\"fas fa-map-marker-alt\"></i> Adresse</h4>\n\n        <div class=\"admin-form-group admin-address-autocomplete\">\n          <label for=\"adresse\">Adresse *</label>\n          <div class=\"admin-autocomplete-wrapper\">\n            <input type=\"text\" id=\"adresse\" name=\"adresse\" class=\"admin-input\" required\n                   value=\"${escapeHtml(location?.adresse || '')}\"\n                   placeholder=\"Commencez  taper une adresse...\"\n                   autocomplete=\"off\">\n            <div class=\"admin-autocomplete-spinner\" id=\"autocompleteSpinner\" style=\"display: none;\">\n              <i class=\"fas fa-spinner fa-spin\"></i>\n            </div>\n            <ul class=\"admin-autocomplete-list\" id=\"autocompleteList\"></ul>\n          </div>\n          <small class=\"admin-form-hint\">L'adresse sera auto-complte et les coordonnes GPS seront rcupres automatiquement</small>\n        </div>\n\n        <div class=\"admin-form-row\">\n          <div class=\"admin-form-group\">\n            <label for=\"codePostal\">Code postal *</label>\n            <input type=\"text\" id=\"codePostal\" name=\"codePostal\" class=\"admin-input\" required\n                   value=\"${escapeHtml(location?.codePostal || '')}\"\n                   pattern=\"[0-9]{5}\" maxlength=\"5\"\n                   placeholder=\"Ex: 79200\">\n            <span class=\"admin-form-error\" id=\"codePostalError\"></span>\n          </div>\n          <div class=\"admin-form-group admin-form-group-large\">\n            <label for=\"ville\">Ville *</label>\n            <input type=\"text\" id=\"ville\" name=\"ville\" class=\"admin-input\" required\n                   value=\"${escapeHtml(location?.ville || '')}\"\n                   placeholder=\"Ex: Parthenay\">\n          </div>\n        </div>\n\n        <div class=\"admin-form-row admin-form-coords\" id=\"coordsSection\">\n          <div class=\"admin-form-group\">\n            <label for=\"lat\">Latitude</label>\n            <input type=\"number\" id=\"lat\" name=\"lat\" class=\"admin-input admin-coord-input\"\n                   value=\"${location?.lat ?? ''}\"\n                   step=\"0.000001\" min=\"-90\" max=\"90\"\n                   placeholder=\"46.6453\">\n          </div>\n          <div class=\"admin-form-group\">\n            <label for=\"lon\">Longitude</label>\n            <input type=\"number\" id=\"lon\" name=\"lon\" class=\"admin-input admin-coord-input\"\n                   value=\"${location?.lon ?? ''}\"\n                   step=\"0.000001\" min=\"-180\" max=\"180\"\n                   placeholder=\"-0.2489\">\n          </div>\n          <div class=\"admin-form-group admin-form-group-btn\">\n            <button type=\"button\" class=\"admin-btn admin-btn-secondary\" id=\"geocodeBtn\">\n              <i class=\"fas fa-crosshairs\"></i> Gocoder\n            </button>\n          </div>\n        </div>\n        <div class=\"admin-geocode-result\" id=\"geocodeResult\" style=\"display: none;\"></div>\n      </div>\n\n      <div class=\"admin-form-section\">\n        <h4><i class=\"fas fa-address-book\"></i> Contact</h4>\n\n        <div class=\"admin-form-row\">\n          <div class=\"admin-form-group\">\n            <label for=\"telephone\">Tlphone</label>\n            <input type=\"tel\" id=\"telephone\" name=\"telephone\" class=\"admin-input\"\n                   value=\"${escapeHtml(location?.telephone || '')}\"\n                   placeholder=\"Ex: 05 49 94 00 00\">\n            <span class=\"admin-form-error\" id=\"telephoneError\"></span>\n          </div>\n          <div class=\"admin-form-group\">\n            <label for=\"email\">Email</label>\n            <input type=\"email\" id=\"email\" name=\"email\" class=\"admin-input\"\n                   value=\"${escapeHtml(location?.email || '')}\"\n                   placeholder=\"Ex: contact@restaurant.fr\">\n            <span class=\"admin-form-error\" id=\"emailError\"></span>\n          </div>\n        </div>\n\n        <div class=\"admin-form-group\">\n          <label for=\"contact\">Nom du contact</label>\n          <input type=\"text\" id=\"contact\" name=\"contact\" class=\"admin-input\"\n                 value=\"${escapeHtml(location?.contact || '')}\"\n                 placeholder=\"Ex: M. Dupont\">\n        </div>\n      </div>\n\n      <div class=\"admin-form-section\">\n        <h4><i class=\"fas fa-comment\"></i> Notes</h4>\n\n        <div class=\"admin-form-group\">\n          <label for=\"commentaire\">Commentaire</label>\n          <textarea id=\"commentaire\" name=\"commentaire\" class=\"admin-input admin-textarea\"\n                    rows=\"3\" placeholder=\"Informations complmentaires...\">${escapeHtml(location?.commentaire || '')}</textarea>\n        </div>\n      </div>\n\n      <div class=\"admin-form-duplicates\" id=\"duplicatesWarning\" style=\"display: none;\">\n        <i class=\"fas fa-exclamation-triangle\"></i>\n        <span>Lieux similaires dtects :</span>\n        <ul id=\"duplicatesList\"></ul>\n      </div>\n\n      <div class=\"admin-form-actions\">\n        <button type=\"button\" class=\"admin-btn admin-btn-cancel\" id=\"cancelBtn\">\n          <i class=\"fas fa-times\"></i> Annuler\n        </button>\n        <button type=\"submit\" class=\"admin-btn admin-btn-primary\" id=\"saveBtn\">\n          <i class=\"fas fa-save\"></i> ${isEdit ? 'Enregistrer' : 'Ajouter'}\n        </button>\n      </div>\n    </form>\n  `;\n\n  const form = container.querySelector('#locationForm') as HTMLFormElement;\n  const typeSelect = form.querySelector('#type') as HTMLSelectElement;\n  const typeAutre = form.querySelector('#typeAutre') as HTMLInputElement;\n  const geocodeBtn = form.querySelector('#geocodeBtn') as HTMLButtonElement;\n  const geocodeResult = form.querySelector('#geocodeResult') as HTMLElement;\n  const nomInput = form.querySelector('#nom') as HTMLInputElement;\n  const villeInput = form.querySelector('#ville') as HTMLInputElement;\n  const duplicatesWarning = form.querySelector('#duplicatesWarning') as HTMLElement;\n  const duplicatesList = form.querySelector('#duplicatesList') as HTMLUListElement;\n  const cancelBtn = form.querySelector('#cancelBtn') as HTMLButtonElement;\n\n  // Autocomplete elements\n  const adresseInput = form.querySelector('#adresse') as HTMLInputElement;\n  const autocompleteList = form.querySelector('#autocompleteList') as HTMLUListElement;\n  const autocompleteSpinner = form.querySelector('#autocompleteSpinner') as HTMLElement;\n  const coordsSection = form.querySelector('#coordsSection') as HTMLElement;\n  const latInput = form.querySelector('#lat') as HTMLInputElement;\n  const lonInput = form.querySelector('#lon') as HTMLInputElement;\n  const codePostalInput = form.querySelector('#codePostal') as HTMLInputElement;\n\n  let currentSuggestions: AddressSuggestion[] = [];\n  let selectedIndex = -1;\n\n  // Type \"Autre\" handling\n  typeSelect.addEventListener('change', () => {\n    if (typeSelect.value === '__autre__') {\n      typeAutre.style.display = 'block';\n      typeAutre.required = true;\n      typeAutre.focus();\n    } else {\n      typeAutre.style.display = 'none';\n      typeAutre.required = false;\n      typeAutre.value = '';\n    }\n  });\n\n  // ============================================================================\n  // Address Autocomplete\n  // ============================================================================\n\n  const showAutocompleteList = () => {\n    autocompleteList.classList.add('visible');\n  };\n\n  const hideAutocompleteList = () => {\n    autocompleteList.classList.remove('visible');\n    selectedIndex = -1;\n  };\n\n  const updateAutocompleteList = (suggestions: AddressSuggestion[]) => {\n    currentSuggestions = suggestions;\n    selectedIndex = -1;\n\n    if (suggestions.length === 0) {\n      hideAutocompleteList();\n      return;\n    }\n\n    autocompleteList.innerHTML = suggestions.map((s, i) => `\n      <li class=\"admin-autocomplete-item\" data-index=\"${i}\">\n        <i class=\"fas fa-map-marker-alt\"></i>\n        <span>${escapeHtml(s.label)}</span>\n      </li>\n    `).join('');\n\n    showAutocompleteList();\n  };\n\n  const selectSuggestion = (suggestion: AddressSuggestion) => {\n    // Parse the label to extract address components\n    // Format: \"numero rue, code_postal ville\" or \"lieu-dit, code_postal ville\"\n    const parts = suggestion.label.split(',');\n    let adresse = '';\n    let codePostal = '';\n    let ville = '';\n\n    if (parts.length >= 2) {\n      adresse = parts[0].trim();\n      // The last part usually contains \"code_postal ville\"\n      const lastPart = parts[parts.length - 1].trim();\n      const cpMatch = lastPart.match(/^(\\d{5})\\s+(.+)$/);\n      if (cpMatch) {\n        codePostal = cpMatch[1];\n        ville = cpMatch[2];\n      } else {\n        ville = lastPart;\n      }\n    } else {\n      adresse = suggestion.label;\n    }\n\n    // Update form fields\n    adresseInput.value = adresse;\n    if (codePostal) codePostalInput.value = codePostal;\n    if (ville) villeInput.value = ville;\n\n    // Update coordinates with animation\n    updateCoordsWithAnimation(suggestion.lat, suggestion.lon);\n\n    hideAutocompleteList();\n  };\n\n  const updateCoordsWithAnimation = (lat: number, lon: number) => {\n    // Add animation class\n    coordsSection.classList.add('coords-updating');\n    latInput.classList.add('coord-flash');\n    lonInput.classList.add('coord-flash');\n\n    // Update values\n    latInput.value = lat.toFixed(6);\n    lonInput.value = lon.toFixed(6);\n\n    // Show success message\n    geocodeResult.innerHTML = `<i class=\"fas fa-check-circle\"></i> Coordonnes GPS rcupres automatiquement`;\n    geocodeResult.className = 'admin-geocode-result success';\n    geocodeResult.style.display = 'flex';\n\n    // Remove animation class after animation completes\n    setTimeout(() => {\n      coordsSection.classList.remove('coords-updating');\n      latInput.classList.remove('coord-flash');\n      lonInput.classList.remove('coord-flash');\n    }, 600);\n  };\n\n  // Debounced autocomplete search\n  const searchAutocomplete = debounce(async (query: string) => {\n    if (query.length < 3) {\n      hideAutocompleteList();\n      autocompleteSpinner.style.display = 'none';\n      return;\n    }\n\n    autocompleteSpinner.style.display = 'flex';\n\n    try {\n      const suggestions = await autocompleteAddress(query);\n      updateAutocompleteList(suggestions);\n    } catch (error) {\n      console.error('Autocomplete error:', error);\n      hideAutocompleteList();\n    }\n\n    autocompleteSpinner.style.display = 'none';\n  }, 300);\n\n  // Input event for autocomplete\n  adresseInput.addEventListener('input', (e) => {\n    const query = (e.target as HTMLInputElement).value;\n    searchAutocomplete(query);\n  });\n\n  // Keyboard navigation\n  adresseInput.addEventListener('keydown', (e) => {\n    if (!autocompleteList.classList.contains('visible')) return;\n\n    const items = autocompleteList.querySelectorAll('.admin-autocomplete-item');\n\n    switch (e.key) {\n      case 'ArrowDown':\n        e.preventDefault();\n        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);\n        break;\n      case 'ArrowUp':\n        e.preventDefault();\n        selectedIndex = Math.max(selectedIndex - 1, 0);\n        break;\n      case 'Enter':\n        e.preventDefault();\n        if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {\n          selectSuggestion(currentSuggestions[selectedIndex]);\n        }\n        return;\n      case 'Escape':\n        hideAutocompleteList();\n        return;\n      default:\n        return;\n    }\n\n    // Update visual selection\n    items.forEach((item, i) => {\n      item.classList.toggle('selected', i === selectedIndex);\n    });\n  });\n\n  // Click on suggestion\n  autocompleteList.addEventListener('click', (e) => {\n    const item = (e.target as HTMLElement).closest('.admin-autocomplete-item');\n    if (item) {\n      const index = parseInt(item.getAttribute('data-index') || '0', 10);\n      if (currentSuggestions[index]) {\n        selectSuggestion(currentSuggestions[index]);\n      }\n    }\n  });\n\n  // Hide autocomplete on blur (with delay to allow click)\n  adresseInput.addEventListener('blur', () => {\n    setTimeout(hideAutocompleteList, 200);\n  });\n\n  // Show autocomplete on focus if there's content\n  adresseInput.addEventListener('focus', () => {\n    if (adresseInput.value.length >= 3 && currentSuggestions.length > 0) {\n      showAutocompleteList();\n    }\n  });\n\n  // ============================================================================\n  // Manual Geocoding Button\n  // ============================================================================\n\n  geocodeBtn.addEventListener('click', async () => {\n    const adresse = adresseInput.value.trim();\n    const codePostal = codePostalInput.value.trim();\n    const ville = villeInput.value.trim();\n\n    if (!adresse || !codePostal || !ville) {\n      geocodeResult.innerHTML = '<i class=\"fas fa-exclamation-circle\"></i> Remplissez l\\'adresse, le code postal et la ville';\n      geocodeResult.className = 'admin-geocode-result error';\n      geocodeResult.style.display = 'flex';\n      return;\n    }\n\n    geocodeBtn.disabled = true;\n    geocodeBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin\"></i> Recherche...';\n    geocodeResult.style.display = 'none';\n\n    try {\n      const result = await geocodeAddress(adresse, codePostal, ville);\n      if (result) {\n        updateCoordsWithAnimation(result.lat, result.lon);\n        geocodeResult.innerHTML = `<i class=\"fas fa-check-circle\"></i> Coordonnes trouves (confiance: ${Math.round(result.confidence * 100)}%)`;\n        geocodeResult.className = 'admin-geocode-result success';\n      } else {\n        geocodeResult.innerHTML = '<i class=\"fas fa-exclamation-triangle\"></i> Adresse non trouve. Vrifiez ou saisissez les coordonnes manuellement.';\n        geocodeResult.className = 'admin-geocode-result warning';\n      }\n    } catch (error) {\n      geocodeResult.innerHTML = '<i class=\"fas fa-times-circle\"></i> Erreur lors du gocodage';\n      geocodeResult.className = 'admin-geocode-result error';\n    }\n\n    geocodeResult.style.display = 'flex';\n    geocodeBtn.disabled = false;\n    geocodeBtn.innerHTML = '<i class=\"fas fa-crosshairs\"></i> Gocoder';\n  });\n\n  // Duplicate detection\n  const checkDuplicates = debounce(() => {\n    const nom = nomInput.value.trim();\n    const ville = villeInput.value.trim();\n\n    if (nom.length < 3) {\n      duplicatesWarning.style.display = 'none';\n      return;\n    }\n\n    const similar = findSimilarLocations({ nom, ville });\n    // Filter out current location if editing\n    const filtered = isEdit ? similar.filter(i => i !== index) : similar;\n\n    if (filtered.length > 0) {\n      const locations = getAllLocations();\n      duplicatesList.innerHTML = filtered.slice(0, 3).map(i => {\n        const loc = locations[i];\n        return `<li>${escapeHtml(loc.nom)} - ${escapeHtml(loc.ville)} (${loc.codePostal})</li>`;\n      }).join('');\n      duplicatesWarning.style.display = 'flex';\n    } else {\n      duplicatesWarning.style.display = 'none';\n    }\n  }, 500);\n\n  nomInput.addEventListener('input', checkDuplicates);\n  villeInput.addEventListener('input', checkDuplicates);\n\n  // Validation\n  const validateField = (field: HTMLInputElement, errorId: string, validator: (value: string) => string | null) => {\n    const error = validator(field.value.trim());\n    const errorEl = form.querySelector(`#${errorId}`) as HTMLElement;\n    if (error) {\n      field.classList.add('error');\n      errorEl.textContent = error;\n      errorEl.style.display = 'block';\n      return false;\n    } else {\n      field.classList.remove('error');\n      errorEl.style.display = 'none';\n      return true;\n    }\n  };\n\n  // Real-time validation\n  codePostalInput.addEventListener('blur', () => {\n    validateField(codePostalInput, 'codePostalError', (value) => {\n      if (!/^\\d{5}$/.test(value)) return 'Le code postal doit contenir 5 chiffres';\n      return null;\n    });\n  });\n\n  const telephoneInput = form.querySelector('#telephone') as HTMLInputElement;\n  telephoneInput.addEventListener('blur', () => {\n    validateField(telephoneInput, 'telephoneError', (value) => {\n      if (value && !/^[\\d\\s.+-]{10,}$/.test(value.replace(/\\s/g, ''))) {\n        return 'Format de tlphone invalide';\n      }\n      return null;\n    });\n  });\n\n  const emailInput = form.querySelector('#email') as HTMLInputElement;\n  emailInput.addEventListener('blur', () => {\n    validateField(emailInput, 'emailError', (value) => {\n      if (value && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(value)) {\n        return 'Format d\\'email invalide';\n      }\n      return null;\n    });\n  });\n\n  // Cancel\n  cancelBtn.addEventListener('click', () => {\n    onCancel();\n  });\n\n  // Submit\n  form.addEventListener('submit', (e) => {\n    e.preventDefault();\n\n    // Validate required fields\n    let valid = true;\n\n    valid = validateField(nomInput, 'nomError', (v) => v ? null : 'Le nom est obligatoire') && valid;\n    valid = validateField(codePostalInput, 'codePostalError', (v) => {\n      if (!v) return 'Le code postal est obligatoire';\n      if (!/^\\d{5}$/.test(v)) return 'Le code postal doit contenir 5 chiffres';\n      return null;\n    }) && valid;\n\n    // Get type value\n    let typeValue = typeSelect.value;\n    if (typeValue === '__autre__') {\n      typeValue = typeAutre.value.trim();\n      if (!typeValue) {\n        valid = false;\n        typeAutre.classList.add('error');\n      }\n    }\n\n    if (!valid) {\n      return;\n    }\n\n    const newLocation: Location = {\n      nom: nomInput.value.trim(),\n      adresse: adresseInput.value.trim(),\n      codePostal: codePostalInput.value.trim(),\n      ville: villeInput.value.trim(),\n      type: typeValue,\n      niveau: (form.querySelector('#niveau') as HTMLSelectElement).value,\n      telephone: telephoneInput.value.trim(),\n      email: emailInput.value.trim(),\n      contact: (form.querySelector('#contact') as HTMLInputElement).value.trim(),\n      commentaire: (form.querySelector('#commentaire') as HTMLTextAreaElement).value.trim(),\n      lat: latInput.value ? parseFloat(latInput.value) : null,\n      lon: lonInput.value ? parseFloat(lonInput.value) : null\n    };\n\n    onSave(newLocation, index);\n  });\n}\n\n/**\n * chappe le HTML\n */\nfunction escapeHtml(text: string): string {\n  if (!text) return '';\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n\n/**\n * Debounce\n */\nfunction debounce<T extends (...args: any[]) => any>(fn: T, delay: number): (...args: Parameters<T>) => void {\n  let timeout: ReturnType<typeof setTimeout> | null = null;\n  return (...args: Parameters<T>) => {\n    if (timeout) clearTimeout(timeout);\n    timeout = setTimeout(() => fn(...args), delay);\n  };\n}\n","// ============================================================================\n// Liste des lieux avec actions de gestion\n// ============================================================================\n\nimport type { Location } from '../../types';\nimport { store } from '../../store';\n\nexport interface LocationListOptions {\n  onEdit: (index: number) => void;\n  onDelete: (indices: number[]) => void;\n  onLocate: (index: number) => void;\n}\n\ninterface ListState {\n  page: number;\n  perPage: number;\n  search: string;\n  sortField: keyof Location | null;\n  sortDir: 'asc' | 'desc';\n  selected: Set<number>;\n}\n\n/**\n * Cre la liste de gestion des lieux\n */\nexport function createLocationList(container: HTMLElement, options: LocationListOptions): void {\n  const { onEdit, onDelete, onLocate } = options;\n\n  const state: ListState = {\n    page: 1,\n    perPage: 20,\n    search: '',\n    sortField: 'nom',\n    sortDir: 'asc',\n    selected: new Set()\n  };\n\n  function render() {\n    const locations = store.locations;\n    let filtered = locations.map((_, i) => i);\n\n    // Filter by search\n    if (state.search) {\n      const searchLower = state.search.toLowerCase();\n      filtered = filtered.filter(i => {\n        const loc = locations[i];\n        return (\n          loc.nom.toLowerCase().includes(searchLower) ||\n          loc.ville.toLowerCase().includes(searchLower) ||\n          loc.codePostal.includes(searchLower) ||\n          loc.type.toLowerCase().includes(searchLower)\n        );\n      });\n    }\n\n    // Sort\n    if (state.sortField) {\n      filtered.sort((a, b) => {\n        const aVal = locations[a][state.sortField!] || '';\n        const bVal = locations[b][state.sortField!] || '';\n        const cmp = String(aVal).localeCompare(String(bVal), 'fr', { numeric: true });\n        return state.sortDir === 'asc' ? cmp : -cmp;\n      });\n    }\n\n    // Pagination\n    const totalPages = Math.ceil(filtered.length / state.perPage);\n    const startIdx = (state.page - 1) * state.perPage;\n    const pageItems = filtered.slice(startIdx, startIdx + state.perPage);\n\n    container.innerHTML = `\n      <div class=\"admin-list-header\">\n        <div class=\"admin-list-search\">\n          <i class=\"fas fa-search\"></i>\n          <input type=\"text\" class=\"admin-input\" placeholder=\"Rechercher...\"\n                 value=\"${escapeHtml(state.search)}\" id=\"listSearchInput\">\n        </div>\n        <div class=\"admin-list-info\">\n          ${filtered.length} lieu${filtered.length > 1 ? 'x' : ''} trouv${filtered.length > 1 ? 's' : ''}\n        </div>\n        <div class=\"admin-list-bulk-actions\" style=\"display: ${state.selected.size > 0 ? 'flex' : 'none'}\">\n          <span>${state.selected.size} slectionn${state.selected.size > 1 ? 's' : ''}</span>\n          <button type=\"button\" class=\"admin-btn admin-btn-danger admin-btn-sm\" id=\"bulkDeleteBtn\">\n            <i class=\"fas fa-trash\"></i> Supprimer\n          </button>\n        </div>\n      </div>\n\n      <div class=\"admin-list-table-container\">\n        <table class=\"admin-list-table\">\n          <thead>\n            <tr>\n              <th class=\"admin-list-th-check\">\n                <input type=\"checkbox\" id=\"selectAllCheck\" ${state.selected.size === pageItems.length && pageItems.length > 0 ? 'checked' : ''}>\n              </th>\n              <th class=\"admin-list-th-sortable\" data-field=\"nom\">\n                Nom ${getSortIcon('nom')}\n              </th>\n              <th class=\"admin-list-th-sortable\" data-field=\"ville\">\n                Ville ${getSortIcon('ville')}\n              </th>\n              <th class=\"admin-list-th-sortable\" data-field=\"type\">\n                Type ${getSortIcon('type')}\n              </th>\n              <th class=\"admin-list-th-sortable\" data-field=\"niveau\">\n                Niveau ${getSortIcon('niveau')}\n              </th>\n              <th>Goloc</th>\n              <th>Actions</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${pageItems.length === 0 ? `\n              <tr>\n                <td colspan=\"7\" class=\"admin-list-empty\">\n                  <i class=\"fas fa-inbox\"></i>\n                  <p>Aucun lieu trouv</p>\n                </td>\n              </tr>\n            ` : pageItems.map(index => {\n              const loc = locations[index];\n              const hasCoords = loc.lat !== null && loc.lon !== null;\n              return `\n                <tr data-index=\"${index}\" class=\"${state.selected.has(index) ? 'selected' : ''}\">\n                  <td>\n                    <input type=\"checkbox\" class=\"row-check\" ${state.selected.has(index) ? 'checked' : ''}>\n                  </td>\n                  <td class=\"admin-list-cell-nom\" title=\"${escapeHtml(loc.nom)}\">\n                    ${escapeHtml(truncate(loc.nom, 30))}\n                  </td>\n                  <td>\n                    ${escapeHtml(loc.ville)} <span class=\"admin-list-cp\">(${loc.codePostal})</span>\n                  </td>\n                  <td>\n                    <span class=\"admin-list-type\">${escapeHtml(truncate(loc.type, 20))}</span>\n                  </td>\n                  <td>\n                    ${loc.niveau ? `<span class=\"admin-list-niveau niveau-${loc.niveau}\">${loc.niveau}</span>` : '-'}\n                  </td>\n                  <td>\n                    <span class=\"admin-list-geo ${hasCoords ? 'yes' : 'no'}\">\n                      <i class=\"fas fa-${hasCoords ? 'check' : 'times'}\"></i>\n                    </span>\n                  </td>\n                  <td class=\"admin-list-actions\">\n                    <button type=\"button\" class=\"admin-btn-icon btn-locate\" title=\"Localiser sur la carte\">\n                      <i class=\"fas fa-map-marker-alt\"></i>\n                    </button>\n                    <button type=\"button\" class=\"admin-btn-icon btn-edit\" title=\"Modifier\">\n                      <i class=\"fas fa-edit\"></i>\n                    </button>\n                    <button type=\"button\" class=\"admin-btn-icon btn-delete\" title=\"Supprimer\">\n                      <i class=\"fas fa-trash\"></i>\n                    </button>\n                  </td>\n                </tr>\n              `;\n            }).join('')}\n          </tbody>\n        </table>\n      </div>\n\n      ${totalPages > 1 ? `\n        <div class=\"admin-list-pagination\">\n          <button type=\"button\" class=\"admin-btn admin-btn-sm\" id=\"prevPageBtn\" ${state.page <= 1 ? 'disabled' : ''}>\n            <i class=\"fas fa-chevron-left\"></i>\n          </button>\n          <span class=\"admin-list-page-info\">\n            Page ${state.page} / ${totalPages}\n          </span>\n          <button type=\"button\" class=\"admin-btn admin-btn-sm\" id=\"nextPageBtn\" ${state.page >= totalPages ? 'disabled' : ''}>\n            <i class=\"fas fa-chevron-right\"></i>\n          </button>\n        </div>\n      ` : ''}\n    `;\n\n    // Event handlers\n    const searchInput = container.querySelector('#listSearchInput') as HTMLInputElement;\n    searchInput?.addEventListener('input', debounce(() => {\n      state.search = searchInput.value;\n      state.page = 1;\n      state.selected.clear();\n      render();\n    }, 300));\n\n    // Sort headers\n    container.querySelectorAll('.admin-list-th-sortable').forEach(th => {\n      th.addEventListener('click', () => {\n        const field = (th as HTMLElement).dataset.field as keyof Location;\n        if (state.sortField === field) {\n          state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';\n        } else {\n          state.sortField = field;\n          state.sortDir = 'asc';\n        }\n        render();\n      });\n    });\n\n    // Select all\n    const selectAllCheck = container.querySelector('#selectAllCheck') as HTMLInputElement;\n    selectAllCheck?.addEventListener('change', () => {\n      if (selectAllCheck.checked) {\n        pageItems.forEach(i => state.selected.add(i));\n      } else {\n        pageItems.forEach(i => state.selected.delete(i));\n      }\n      render();\n    });\n\n    // Row checkboxes\n    container.querySelectorAll('.row-check').forEach(check => {\n      check.addEventListener('change', (e) => {\n        const tr = (e.target as HTMLElement).closest('tr');\n        const index = parseInt(tr?.dataset.index || '-1', 10);\n        if ((e.target as HTMLInputElement).checked) {\n          state.selected.add(index);\n        } else {\n          state.selected.delete(index);\n        }\n        render();\n      });\n    });\n\n    // Bulk delete\n    const bulkDeleteBtn = container.querySelector('#bulkDeleteBtn');\n    bulkDeleteBtn?.addEventListener('click', () => {\n      if (state.selected.size > 0) {\n        if (confirm(`Supprimer ${state.selected.size} lieu${state.selected.size > 1 ? 'x' : ''} ?`)) {\n          onDelete(Array.from(state.selected).sort((a, b) => b - a));\n          state.selected.clear();\n          state.page = 1;\n          render();\n        }\n      }\n    });\n\n    // Row actions\n    container.querySelectorAll('tr[data-index]').forEach(tr => {\n      const index = parseInt((tr as HTMLElement).dataset.index || '-1', 10);\n\n      tr.querySelector('.btn-locate')?.addEventListener('click', (e) => {\n        e.stopPropagation();\n        onLocate(index);\n      });\n\n      tr.querySelector('.btn-edit')?.addEventListener('click', (e) => {\n        e.stopPropagation();\n        onEdit(index);\n      });\n\n      tr.querySelector('.btn-delete')?.addEventListener('click', (e) => {\n        e.stopPropagation();\n        if (confirm(`Supprimer \"${locations[index].nom}\" ?`)) {\n          onDelete([index]);\n          state.selected.delete(index);\n          render();\n        }\n      });\n    });\n\n    // Pagination\n    const prevBtn = container.querySelector('#prevPageBtn');\n    const nextBtn = container.querySelector('#nextPageBtn');\n\n    prevBtn?.addEventListener('click', () => {\n      if (state.page > 1) {\n        state.page--;\n        render();\n      }\n    });\n\n    nextBtn?.addEventListener('click', () => {\n      if (state.page < totalPages) {\n        state.page++;\n        render();\n      }\n    });\n  }\n\n  function getSortIcon(field: string): string {\n    if (state.sortField !== field) return '<i class=\"fas fa-sort admin-sort-inactive\"></i>';\n    return state.sortDir === 'asc'\n      ? '<i class=\"fas fa-sort-up\"></i>'\n      : '<i class=\"fas fa-sort-down\"></i>';\n  }\n\n  // Initial render\n  render();\n\n  // Re-render when data changes\n  window.addEventListener('admin-data-changed', () => {\n    render();\n  });\n}\n\n/**\n * chappe le HTML\n */\nfunction escapeHtml(text: string): string {\n  if (!text) return '';\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n\n/**\n * Tronque le texte\n */\nfunction truncate(text: string, max: number): string {\n  if (!text) return '';\n  return text.length > max ? text.slice(0, max) + '...' : text;\n}\n\n/**\n * Debounce\n */\nfunction debounce<T extends (...args: any[]) => any>(fn: T, delay: number): (...args: Parameters<T>) => void {\n  let timeout: ReturnType<typeof setTimeout> | null = null;\n  return (...args: Parameters<T>) => {\n    if (timeout) clearTimeout(timeout);\n    timeout = setTimeout(() => fn(...args), delay);\n  };\n}\n","// ============================================================================\n// Panneau d'import Excel/CSV\n// ============================================================================\n\nimport type { Location } from '../../types';\nimport { geocodeAddress } from '../../services/geocoding.service';\nimport { locationExists } from '../../services/data.service';\n\nexport interface ImportOptions {\n  onImport: (locations: Location[]) => void;\n  onCancel: () => void;\n}\n\ninterface ParsedData {\n  headers: string[];\n  rows: string[][];\n}\n\ninterface ColumnMapping {\n  nom: number;\n  adresse: number;\n  codePostal: number;\n  ville: number;\n  type: number;\n  niveau: number;\n  telephone: number;\n  email: number;\n  contact: number;\n  commentaire: number;\n  lat: number;\n  lon: number;\n}\n\n// Column name patterns for auto-mapping\nconst COLUMN_PATTERNS: Record<keyof ColumnMapping, RegExp[]> = {\n  nom: [/^nom$/i, /^name$/i, /^tablissement$/i, /^entreprise$/i, /^raison/i],\n  adresse: [/^adresse$/i, /^address$/i, /^rue$/i, /^voie$/i],\n  codePostal: [/^code.?postal$/i, /^cp$/i, /^postal/i, /^zip/i],\n  ville: [/^ville$/i, /^city$/i, /^commune$/i, /^localit$/i],\n  type: [/^type$/i, /^catgorie$/i, /^category$/i, /^activit$/i],\n  niveau: [/^niveau$/i, /^level$/i, /^niv$/i],\n  telephone: [/^t[e]l[e]?phone$/i, /^tel$/i, /^phone$/i, /^mobile$/i],\n  email: [/^e?.?mail$/i, /^courriel$/i],\n  contact: [/^contact$/i, /^responsable$/i, /^interlocuteur$/i],\n  commentaire: [/^commentaire$/i, /^comment$/i, /^note$/i, /^remarque$/i],\n  lat: [/^lat$/i, /^latitude$/i],\n  lon: [/^lon$/i, /^lng$/i, /^longitude$/i]\n};\n\n/**\n * Cre le panneau d'import\n */\nexport function createImportPanel(container: HTMLElement, options: ImportOptions): void {\n  const { onImport, onCancel } = options;\n\n  let parsedData: ParsedData | null = null;\n  let mapping: ColumnMapping = createEmptyMapping();\n  let importSettings = {\n    skipDuplicates: true,\n    autoGeocode: true\n  };\n\n  renderDropZone();\n\n  function renderDropZone() {\n    container.innerHTML = `\n      <div class=\"admin-import-panel\">\n        <h3 class=\"admin-form-title\">\n          <i class=\"fas fa-file-import\"></i>\n          Importer des lieux depuis un fichier\n        </h3>\n\n        <div class=\"admin-import-dropzone\" id=\"dropzone\">\n          <i class=\"fas fa-cloud-upload-alt\"></i>\n          <p>Glissez-dposez un fichier ici</p>\n          <span>ou</span>\n          <label class=\"admin-btn admin-btn-secondary\">\n            <i class=\"fas fa-folder-open\"></i> Parcourir\n            <input type=\"file\" accept=\".csv,.xlsx,.xls\" id=\"fileInput\" style=\"display: none;\">\n          </label>\n          <p class=\"admin-import-formats\">Formats accepts : CSV, Excel (.xlsx, .xls)</p>\n        </div>\n\n        <div class=\"admin-import-help\">\n          <h4><i class=\"fas fa-info-circle\"></i> Format attendu</h4>\n          <p>Le fichier doit contenir une ligne d'en-tte avec au minimum les colonnes :</p>\n          <ul>\n            <li><strong>Nom</strong> - Nom de l'tablissement</li>\n            <li><strong>Adresse</strong> - Adresse postale</li>\n            <li><strong>Code postal</strong> - Code postal (5 chiffres)</li>\n            <li><strong>Ville</strong> - Nom de la ville</li>\n          </ul>\n          <p>Colonnes optionnelles : Type, Niveau, Tlphone, Email, Contact, Commentaire, Latitude, Longitude</p>\n        </div>\n\n        <div class=\"admin-form-actions\">\n          <button type=\"button\" class=\"admin-btn admin-btn-cancel\" id=\"cancelBtn\">\n            <i class=\"fas fa-times\"></i> Annuler\n          </button>\n        </div>\n      </div>\n    `;\n\n    setupDropZone();\n  }\n\n  function setupDropZone() {\n    const dropzone = container.querySelector('#dropzone') as HTMLElement;\n    const fileInput = container.querySelector('#fileInput') as HTMLInputElement;\n    const cancelBtn = container.querySelector('#cancelBtn') as HTMLButtonElement;\n\n    // Drag events\n    ['dragenter', 'dragover'].forEach(event => {\n      dropzone.addEventListener(event, (e) => {\n        e.preventDefault();\n        dropzone.classList.add('dragover');\n      });\n    });\n\n    ['dragleave', 'drop'].forEach(event => {\n      dropzone.addEventListener(event, (e) => {\n        e.preventDefault();\n        dropzone.classList.remove('dragover');\n      });\n    });\n\n    dropzone.addEventListener('drop', (e) => {\n      const files = e.dataTransfer?.files;\n      if (files && files.length > 0) {\n        handleFile(files[0]);\n      }\n    });\n\n    fileInput.addEventListener('change', () => {\n      if (fileInput.files && fileInput.files.length > 0) {\n        handleFile(fileInput.files[0]);\n      }\n    });\n\n    cancelBtn.addEventListener('click', () => {\n      onCancel();\n    });\n  }\n\n  async function handleFile(file: File) {\n    const ext = file.name.split('.').pop()?.toLowerCase();\n\n    container.innerHTML = `\n      <div class=\"admin-import-loading\">\n        <i class=\"fas fa-spinner fa-spin\"></i>\n        <p>Lecture du fichier...</p>\n      </div>\n    `;\n\n    try {\n      if (ext === 'csv') {\n        parsedData = await parseCSV(file);\n      } else if (ext === 'xlsx' || ext === 'xls') {\n        parsedData = await parseExcel(file);\n      } else {\n        throw new Error('Format de fichier non support');\n      }\n\n      if (parsedData.rows.length === 0) {\n        throw new Error('Le fichier est vide');\n      }\n\n      // Auto-map columns\n      mapping = autoMapColumns(parsedData.headers);\n\n      renderPreview();\n    } catch (error) {\n      container.innerHTML = `\n        <div class=\"admin-import-error\">\n          <i class=\"fas fa-exclamation-triangle\"></i>\n          <p>Erreur lors de la lecture du fichier</p>\n          <span>${(error as Error).message}</span>\n          <button type=\"button\" class=\"admin-btn admin-btn-secondary\" id=\"retryBtn\">\n            <i class=\"fas fa-redo\"></i> Ressayer\n          </button>\n        </div>\n      `;\n      container.querySelector('#retryBtn')?.addEventListener('click', renderDropZone);\n    }\n  }\n\n  function renderPreview() {\n    if (!parsedData) return;\n\n    const previewRows = parsedData.rows.slice(0, 5);\n    const totalRows = parsedData.rows.length;\n\n    container.innerHTML = `\n      <div class=\"admin-import-preview\">\n        <h3 class=\"admin-form-title\">\n          <i class=\"fas fa-table\"></i>\n          Aperu et mapping des colonnes\n        </h3>\n\n        <div class=\"admin-import-stats\">\n          <span><i class=\"fas fa-file\"></i> ${totalRows} lignes dtectes</span>\n          <span><i class=\"fas fa-columns\"></i> ${parsedData.headers.length} colonnes</span>\n        </div>\n\n        <div class=\"admin-import-mapping\">\n          <h4>Correspondance des colonnes</h4>\n          <p class=\"admin-import-mapping-desc\">Associez chaque champ avec la colonne correspondante du fichier.</p>\n\n          <div class=\"admin-import-mapping-grid\">\n            ${renderMappingSelects()}\n          </div>\n        </div>\n\n        <div class=\"admin-import-preview-table-container\">\n          <h4>Aperu des donnes</h4>\n          <table class=\"admin-import-preview-table\">\n            <thead>\n              <tr>\n                ${parsedData.headers.map((h, i) => `\n                  <th class=\"${isMapped(i) ? 'mapped' : ''}\">\n                    ${escapeHtml(h)}\n                    ${isMapped(i) ? `<span class=\"mapped-badge\">${getMappedField(i)}</span>` : ''}\n                  </th>\n                `).join('')}\n              </tr>\n            </thead>\n            <tbody>\n              ${previewRows.map(row => `\n                <tr>\n                  ${row.map((cell, i) => `\n                    <td class=\"${isMapped(i) ? 'mapped' : ''}\">${escapeHtml(truncate(cell, 30))}</td>\n                  `).join('')}\n                </tr>\n              `).join('')}\n            </tbody>\n          </table>\n          ${totalRows > 5 ? `<p class=\"admin-import-more\">... et ${totalRows - 5} autres lignes</p>` : ''}\n        </div>\n\n        <div class=\"admin-import-options\">\n          <h4>Options d'import</h4>\n          <label class=\"admin-checkbox\">\n            <input type=\"checkbox\" id=\"skipDuplicates\" ${importSettings.skipDuplicates ? 'checked' : ''}>\n            <span>Ignorer les doublons (mme nom et ville)</span>\n          </label>\n          <label class=\"admin-checkbox\">\n            <input type=\"checkbox\" id=\"autoGeocode\" ${importSettings.autoGeocode ? 'checked' : ''}>\n            <span>Gocoder automatiquement les adresses</span>\n          </label>\n        </div>\n\n        <div class=\"admin-form-actions\">\n          <button type=\"button\" class=\"admin-btn admin-btn-cancel\" id=\"backBtn\">\n            <i class=\"fas fa-arrow-left\"></i> Retour\n          </button>\n          <button type=\"button\" class=\"admin-btn admin-btn-primary\" id=\"importBtn\" ${!isValidMapping() ? 'disabled' : ''}>\n            <i class=\"fas fa-file-import\"></i> Importer ${totalRows} lieu${totalRows > 1 ? 'x' : ''}\n          </button>\n        </div>\n      </div>\n    `;\n\n    setupPreviewEvents();\n  }\n\n  function renderMappingSelects(): string {\n    const fields: { key: keyof ColumnMapping; label: string; required: boolean }[] = [\n      { key: 'nom', label: 'Nom *', required: true },\n      { key: 'adresse', label: 'Adresse *', required: true },\n      { key: 'codePostal', label: 'Code postal *', required: true },\n      { key: 'ville', label: 'Ville *', required: true },\n      { key: 'type', label: 'Type', required: false },\n      { key: 'niveau', label: 'Niveau', required: false },\n      { key: 'telephone', label: 'Tlphone', required: false },\n      { key: 'email', label: 'Email', required: false },\n      { key: 'contact', label: 'Contact', required: false },\n      { key: 'commentaire', label: 'Commentaire', required: false },\n      { key: 'lat', label: 'Latitude', required: false },\n      { key: 'lon', label: 'Longitude', required: false }\n    ];\n\n    return fields.map(({ key, label, required }) => `\n      <div class=\"admin-import-mapping-item ${required ? 'required' : ''}\">\n        <label>${label}</label>\n        <select class=\"admin-input\" data-field=\"${key}\">\n          <option value=\"-1\">${required ? '-- Slectionner --' : '-- Non import --'}</option>\n          ${parsedData!.headers.map((h, i) => `\n            <option value=\"${i}\" ${mapping[key] === i ? 'selected' : ''}>${escapeHtml(h)}</option>\n          `).join('')}\n        </select>\n      </div>\n    `).join('');\n  }\n\n  function setupPreviewEvents() {\n    // Mapping selects\n    container.querySelectorAll('.admin-import-mapping-item select').forEach(select => {\n      select.addEventListener('change', () => {\n        const field = (select as HTMLSelectElement).dataset.field as keyof ColumnMapping;\n        mapping[field] = parseInt((select as HTMLSelectElement).value, 10);\n        renderPreview();\n      });\n    });\n\n    // Options\n    const skipDuplicates = container.querySelector('#skipDuplicates') as HTMLInputElement;\n    const autoGeocode = container.querySelector('#autoGeocode') as HTMLInputElement;\n\n    skipDuplicates?.addEventListener('change', () => {\n      importSettings.skipDuplicates = skipDuplicates.checked;\n    });\n\n    autoGeocode?.addEventListener('change', () => {\n      importSettings.autoGeocode = autoGeocode.checked;\n    });\n\n    // Buttons\n    container.querySelector('#backBtn')?.addEventListener('click', renderDropZone);\n    container.querySelector('#importBtn')?.addEventListener('click', startImport);\n  }\n\n  async function startImport() {\n    if (!parsedData || !isValidMapping()) return;\n\n    const totalRows = parsedData.rows.length;\n    let imported = 0;\n    let skipped = 0;\n    let errors = 0;\n    const locations: Location[] = [];\n\n    container.innerHTML = `\n      <div class=\"admin-import-progress\">\n        <h3><i class=\"fas fa-cog fa-spin\"></i> Import en cours...</h3>\n        <div class=\"admin-progress-bar\">\n          <div class=\"admin-progress-fill\" id=\"progressFill\" style=\"width: 0%\"></div>\n        </div>\n        <p class=\"admin-progress-text\" id=\"progressText\">0 / ${totalRows}</p>\n        <p class=\"admin-progress-status\" id=\"progressStatus\">Prparation...</p>\n      </div>\n    `;\n\n    const progressFill = container.querySelector('#progressFill') as HTMLElement;\n    const progressText = container.querySelector('#progressText') as HTMLElement;\n    const progressStatus = container.querySelector('#progressStatus') as HTMLElement;\n\n    for (let i = 0; i < parsedData.rows.length; i++) {\n      const row = parsedData.rows[i];\n\n      // Update progress\n      const percent = Math.round(((i + 1) / totalRows) * 100);\n      progressFill.style.width = `${percent}%`;\n      progressText.textContent = `${i + 1} / ${totalRows}`;\n\n      try {\n        const location = rowToLocation(row);\n\n        // Check for duplicates\n        if (importSettings.skipDuplicates && locationExists(location.nom, location.ville)) {\n          skipped++;\n          progressStatus.textContent = `Ignor: ${location.nom} (doublon)`;\n          continue;\n        }\n\n        // Geocode if needed\n        if (importSettings.autoGeocode && location.lat === null) {\n          progressStatus.textContent = `Gocodage: ${location.nom}...`;\n          const geo = await geocodeAddress(location.adresse, location.codePostal, location.ville);\n          if (geo) {\n            location.lat = geo.lat;\n            location.lon = geo.lon;\n          }\n          // Rate limiting\n          await new Promise(resolve => setTimeout(resolve, 100));\n        }\n\n        locations.push(location);\n        imported++;\n        progressStatus.textContent = `Import: ${location.nom}`;\n      } catch (error) {\n        errors++;\n        progressStatus.textContent = `Erreur ligne ${i + 1}`;\n      }\n    }\n\n    // Show results\n    renderResults(imported, skipped, errors, locations);\n  }\n\n  function renderResults(imported: number, skipped: number, errors: number, locations: Location[]) {\n    container.innerHTML = `\n      <div class=\"admin-import-results\">\n        <h3><i class=\"fas fa-check-circle\"></i> Import termin</h3>\n\n        <div class=\"admin-import-results-stats\">\n          <div class=\"stat success\">\n            <i class=\"fas fa-check\"></i>\n            <span class=\"number\">${imported}</span>\n            <span class=\"label\">import${imported > 1 ? 's' : ''}</span>\n          </div>\n          <div class=\"stat warning\">\n            <i class=\"fas fa-forward\"></i>\n            <span class=\"number\">${skipped}</span>\n            <span class=\"label\">ignor${skipped > 1 ? 's' : ''}</span>\n          </div>\n          <div class=\"stat error\">\n            <i class=\"fas fa-times\"></i>\n            <span class=\"number\">${errors}</span>\n            <span class=\"label\">erreur${errors > 1 ? 's' : ''}</span>\n          </div>\n        </div>\n\n        <div class=\"admin-form-actions\">\n          <button type=\"button\" class=\"admin-btn admin-btn-secondary\" id=\"importMoreBtn\">\n            <i class=\"fas fa-plus\"></i> Importer un autre fichier\n          </button>\n          <button type=\"button\" class=\"admin-btn admin-btn-primary\" id=\"finishBtn\">\n            <i class=\"fas fa-check\"></i> Terminer\n          </button>\n        </div>\n      </div>\n    `;\n\n    container.querySelector('#importMoreBtn')?.addEventListener('click', renderDropZone);\n    container.querySelector('#finishBtn')?.addEventListener('click', () => {\n      if (locations.length > 0) {\n        onImport(locations);\n      } else {\n        onCancel();\n      }\n    });\n  }\n\n  function rowToLocation(row: string[]): Location {\n    return {\n      nom: getCell(row, mapping.nom) || '',\n      adresse: getCell(row, mapping.adresse) || '',\n      codePostal: getCell(row, mapping.codePostal) || '',\n      ville: getCell(row, mapping.ville) || '',\n      type: getCell(row, mapping.type) || '',\n      niveau: getCell(row, mapping.niveau) || '',\n      telephone: getCell(row, mapping.telephone) || '',\n      email: getCell(row, mapping.email) || '',\n      contact: getCell(row, mapping.contact) || '',\n      commentaire: getCell(row, mapping.commentaire) || '',\n      lat: parseCoord(getCell(row, mapping.lat)),\n      lon: parseCoord(getCell(row, mapping.lon))\n    };\n  }\n\n  function getCell(row: string[], index: number): string {\n    if (index < 0 || index >= row.length) return '';\n    return row[index].trim();\n  }\n\n  function parseCoord(value: string): number | null {\n    if (!value) return null;\n    const num = parseFloat(value.replace(',', '.'));\n    return isNaN(num) ? null : num;\n  }\n\n  function isMapped(colIndex: number): boolean {\n    return Object.values(mapping).includes(colIndex);\n  }\n\n  function getMappedField(colIndex: number): string {\n    for (const [key, value] of Object.entries(mapping)) {\n      if (value === colIndex) return key;\n    }\n    return '';\n  }\n\n  function isValidMapping(): boolean {\n    return (\n      mapping.nom >= 0 &&\n      mapping.adresse >= 0 &&\n      mapping.codePostal >= 0 &&\n      mapping.ville >= 0\n    );\n  }\n}\n\n/**\n * Parse un fichier CSV\n */\nasync function parseCSV(file: File): Promise<ParsedData> {\n  const text = await file.text();\n  const lines = text.split(/\\r?\\n/).filter(line => line.trim());\n\n  if (lines.length === 0) {\n    throw new Error('Fichier vide');\n  }\n\n  // Detect delimiter\n  const firstLine = lines[0];\n  const delimiter = firstLine.includes(';') ? ';' : ',';\n\n  const parseRow = (line: string): string[] => {\n    const cells: string[] = [];\n    let current = '';\n    let inQuotes = false;\n\n    for (let i = 0; i < line.length; i++) {\n      const char = line[i];\n      if (char === '\"') {\n        if (inQuotes && line[i + 1] === '\"') {\n          current += '\"';\n          i++;\n        } else {\n          inQuotes = !inQuotes;\n        }\n      } else if (char === delimiter && !inQuotes) {\n        cells.push(current);\n        current = '';\n      } else {\n        current += char;\n      }\n    }\n    cells.push(current);\n    return cells;\n  };\n\n  const headers = parseRow(lines[0]);\n  const rows = lines.slice(1).map(parseRow);\n\n  return { headers, rows };\n}\n\n/**\n * Parse un fichier Excel\n */\nasync function parseExcel(file: File): Promise<ParsedData> {\n  // Dynamic import of xlsx library\n  const XLSX = await import('xlsx');\n\n  const arrayBuffer = await file.arrayBuffer();\n  const workbook = XLSX.read(arrayBuffer, { type: 'array' });\n\n  // Get first sheet\n  const sheetName = workbook.SheetNames[0];\n  const sheet = workbook.Sheets[sheetName];\n\n  // Convert to JSON\n  const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' }) as unknown[][];\n\n  if (data.length === 0) {\n    throw new Error('Feuille vide');\n  }\n\n  const headers = (data[0] as unknown[]).map(String);\n  const rows = data.slice(1).map(row => (row as unknown[]).map(String));\n\n  return { headers, rows };\n}\n\n/**\n * Auto-mapping des colonnes\n */\nfunction autoMapColumns(headers: string[]): ColumnMapping {\n  const mapping = createEmptyMapping();\n\n  headers.forEach((header, index) => {\n    const normalized = header.toLowerCase().trim();\n\n    for (const [field, patterns] of Object.entries(COLUMN_PATTERNS)) {\n      if ((mapping as any)[field] === -1) {\n        for (const pattern of patterns) {\n          if (pattern.test(normalized)) {\n            (mapping as any)[field] = index;\n            break;\n          }\n        }\n      }\n    }\n  });\n\n  return mapping;\n}\n\n/**\n * Cre un mapping vide\n */\nfunction createEmptyMapping(): ColumnMapping {\n  return {\n    nom: -1,\n    adresse: -1,\n    codePostal: -1,\n    ville: -1,\n    type: -1,\n    niveau: -1,\n    telephone: -1,\n    email: -1,\n    contact: -1,\n    commentaire: -1,\n    lat: -1,\n    lon: -1\n  };\n}\n\n/**\n * chappe le HTML\n */\nfunction escapeHtml(text: string): string {\n  if (!text) return '';\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n\n/**\n * Tronque le texte\n */\nfunction truncate(text: string, max: number): string {\n  if (!text) return '';\n  return text.length > max ? text.slice(0, max) + '...' : text;\n}\n","// ============================================================================\n// Service d'intgration API INSEE (SIRENE)\n// ============================================================================\n\nimport type { INSEEResult } from '../types';\nimport { geocodeAddress } from './geocoding.service';\n\n// Mapping des codes NAF vers des types lisibles\nconst NAF_TYPES: Record<string, string> = {\n  '55.10Z': 'Htel',\n  '55.20Z': 'Hbergement touristique',\n  '55.30Z': 'Camping',\n  '56.10A': 'Restauration traditionnelle',\n  '56.10B': 'Caftria',\n  '56.10C': 'Restauration rapide',\n  '56.21Z': 'Traiteur',\n  '56.29A': 'Restauration collective sous contrat',\n  '56.29B': 'Restauration collective autre',\n  '56.30Z': 'Dbit de boissons',\n  '47.11A': 'Commerce alimentaire de dtail',\n  '47.11B': 'Commerce alimentaire de proximit',\n  '47.11C': 'Grande surface alimentaire',\n  '47.11D': 'Supermarch',\n  '47.11E': 'Magasin multi-commerce',\n  '47.11F': 'Hypermarch',\n  '10.71A': 'Fabrication industrielle de pain',\n  '10.71B': 'Cuisson de produits de boulangerie',\n  '10.71C': 'Boulangerie-ptisserie',\n  '10.71D': 'Ptisserie',\n  '10.13A': 'Prparation industrielle de produits  base de viande',\n  '10.13B': 'Charcuterie',\n  '10.52Z': 'Fabrication de glaces',\n  '10.82Z': 'Fabrication de cacao, chocolat',\n  '47.24Z': 'Commerce pain, ptisserie, confiserie',\n  '47.29Z': 'Autre commerce alimentaire',\n  '47.81Z': 'Commerce alimentaire sur marchs'\n};\n\n// Dpartements pris en charge\nconst DEPARTMENTS = [\n  { code: '79', nom: 'Deux-Svres' },\n  { code: '86', nom: 'Vienne' },\n  { code: '17', nom: 'Charente-Maritime' },\n  { code: '85', nom: 'Vende' },\n  { code: '16', nom: 'Charente' },\n  { code: '87', nom: 'Haute-Vienne' }\n];\n\n/**\n * Retourne la liste des dpartements\n */\nexport function getDepartments(): { code: string; nom: string }[] {\n  return DEPARTMENTS;\n}\n\n/**\n * Retourne les codes NAF filtrs par domaine\n */\nexport function getNafCodesByDomain(domain: 'restauration' | 'hotellerie' | 'commerce' | 'all'): string[] {\n  const restauration = ['56.10A', '56.10B', '56.10C', '56.21Z', '56.29A', '56.29B', '56.30Z'];\n  const hotellerie = ['55.10Z', '55.20Z', '55.30Z'];\n  const commerce = ['47.11A', '47.11B', '47.11C', '47.11D', '47.11E', '47.11F', '47.24Z', '47.29Z', '47.81Z'];\n  const production = ['10.71A', '10.71B', '10.71C', '10.71D', '10.13A', '10.13B', '10.52Z', '10.82Z'];\n\n  switch (domain) {\n    case 'restauration':\n      return restauration;\n    case 'hotellerie':\n      return hotellerie;\n    case 'commerce':\n      return [...commerce, ...production];\n    case 'all':\n    default:\n      return [...restauration, ...hotellerie, ...commerce, ...production];\n  }\n}\n\n/**\n * Convertit un code NAF en type lisible\n */\nexport function nafToType(nafCode: string): string {\n  return NAF_TYPES[nafCode] || 'tablissement';\n}\n\n/**\n * Recherche dans l'API Recherche Entreprises (gouvernement franais)\n * Cette API est gratuite, fiable et filtre correctement par dpartement\n */\nexport async function searchSirene(params: {\n  departement?: string;\n  commune?: string;\n  codeNaf?: string[];\n  raisonSociale?: string;\n  limit?: number;\n}): Promise<INSEEResult[]> {\n  const { departement, commune, codeNaf, raisonSociale, limit = 25 } = params;\n\n  // API Recherche Entreprises - filtrage fiable par dpartement\n  const baseUrl = 'https://recherche-entreprises.api.gouv.fr/search';\n\n  try {\n    const url = new URL(baseUrl);\n\n    // Paramtre de recherche textuelle (ville ou raison sociale)\n    if (raisonSociale) {\n      url.searchParams.set('q', raisonSociale);\n    } else if (commune) {\n      url.searchParams.set('q', commune);\n    }\n\n    // Filtre par dpartement - paramtre explicite et fiable\n    if (departement) {\n      url.searchParams.set('departement', departement);\n    }\n\n    // Filtre par activit NAF\n    if (codeNaf && codeNaf.length > 0) {\n      // L'API accepte plusieurs codes NAF spars par des virgules\n      url.searchParams.set('activite_principale', codeNaf.join(','));\n    }\n\n    // Pagination\n    url.searchParams.set('per_page', String(limit));\n    url.searchParams.set('page', '1');\n\n    const response = await fetch(url.toString());\n\n    if (!response.ok) {\n      if (response.status === 429) {\n        throw new Error('Trop de requtes. Veuillez ressayer dans quelques instants.');\n      }\n      throw new Error(`Erreur API: ${response.status}`);\n    }\n\n    const data = await response.json();\n\n    if (!data.results || data.results.length === 0) {\n      return [];\n    }\n\n    // Transformer les rsultats\n    // L'API retourne les entreprises avec leurs tablissements correspondant au filtre\n    // On utilise matching_etablissements pour avoir les tablissements dans le bon dpartement\n    const results: INSEEResult[] = [];\n\n    for (const entreprise of data.results) {\n      // Utiliser matching_etablissements si disponible (tablissements dans le dpartement recherch)\n      // Sinon utiliser le sige (cas d'une recherche sans filtre dpartement)\n      const etablissements = entreprise.matching_etablissements?.length > 0\n        ? entreprise.matching_etablissements\n        : [entreprise.siege];\n\n      for (const etab of etablissements) {\n        if (!etab) continue;\n\n        // Vrifier que l'tablissement est bien dans le dpartement demand\n        if (departement && etab.code_postal && !etab.code_postal.startsWith(departement)) {\n          continue;\n        }\n\n        // Rcuprer le nom (enseigne de l'tablissement, nom commercial, ou nom de l'entreprise)\n        const enseignes = etab.liste_enseignes || [];\n        const nom = enseignes[0] || etab.nom_commercial || entreprise.nom_complet || 'Sans nom';\n\n        // Code NAF format (ex: \"56.10A\")\n        const activiteCode = etab.activite_principale || '';\n        const activiteFormatee = activiteCode.replace(/(\\d{2})(\\d{2})([A-Z])/, '$1.$2$3');\n\n        // Extraire l'adresse depuis le champ adresse ou construire depuis les composants\n        let adresse = '';\n        if (etab.adresse) {\n          // L'adresse complte inclut souvent le code postal et la ville, on les retire\n          const adresseParts = etab.adresse.split(' ');\n          const codePostalIndex = adresseParts.findIndex((p: string) => /^\\d{5}$/.test(p));\n          if (codePostalIndex > 0) {\n            adresse = adresseParts.slice(0, codePostalIndex).join(' ');\n          } else {\n            adresse = etab.adresse;\n          }\n        }\n\n        results.push({\n          siret: etab.siret || entreprise.siren,\n          nom: nom,\n          adresse: adresse,\n          codePostal: etab.code_postal || '',\n          ville: etab.libelle_commune || '',\n          activitePrincipale: activiteCode,\n          type: nafToType(activiteFormatee),\n          // Coordonnes GPS incluses dans la rponse\n          lat: etab.latitude ? parseFloat(etab.latitude) : undefined,\n          lon: etab.longitude ? parseFloat(etab.longitude) : undefined\n        });\n      }\n    }\n\n    return results;\n  } catch (error) {\n    console.error('Erreur recherche SIRENE:', error);\n    throw error;\n  }\n}\n\n/**\n * Recherche et gocode un tablissement\n * Note: La nouvelle API retourne dj les coordonnes GPS pour la plupart des rsultats\n * Le gocodage n'est effectu que pour les rsultats sans coordonnes\n */\nexport async function searchAndGeocode(params: {\n  departement?: string;\n  commune?: string;\n  codeNaf?: string[];\n  limit?: number;\n}): Promise<INSEEResult[]> {\n  const results = await searchSirene(params);\n\n  // Gocoder uniquement les rsultats sans coordonnes\n  const geocodedResults = await Promise.all(\n    results.map(async (result) => {\n      // Si les coordonnes sont dj prsentes, on les garde\n      if (result.lat && result.lon) {\n        return result;\n      }\n\n      // Sinon, on gocode l'adresse\n      if (result.adresse && result.codePostal && result.ville) {\n        const coords = await geocodeAddress(result.adresse, result.codePostal, result.ville);\n        if (coords) {\n          return {\n            ...result,\n            lat: coords.lat,\n            lon: coords.lon\n          };\n        }\n      }\n      return result;\n    })\n  );\n\n  return geocodedResults;\n}\n\n/**\n * Rcupre les dtails d'un tablissement par SIRET\n */\nexport async function getEtablissementBySiret(siret: string): Promise<INSEEResult | null> {\n  try {\n    const url = `https://entreprise.data.gouv.fr/api/sirene/v3/etablissements/${siret}`;\n    const response = await fetch(url);\n\n    if (!response.ok) {\n      return null;\n    }\n\n    const data = await response.json();\n    const etab = data.etablissement;\n\n    if (!etab) {\n      return null;\n    }\n\n    const adresseParts = [\n      etab.numeroVoieEtablissement,\n      etab.typeVoieEtablissement,\n      etab.libelleVoieEtablissement\n    ].filter(Boolean);\n\n    return {\n      siret: etab.siret,\n      nom: etab.uniteLegale?.denominationUniteLegale ||\n        etab.uniteLegale?.nomUniteLegale ||\n        'Sans nom',\n      adresse: adresseParts.join(' '),\n      codePostal: etab.codePostalEtablissement || '',\n      ville: etab.libelleCommuneEtablissement || '',\n      activitePrincipale: etab.activitePrincipaleEtablissement || '',\n      type: nafToType(etab.activitePrincipaleEtablissement?.replace(/(\\d{2})(\\d{2})([A-Z])/, '$1.$2$3') || '')\n    };\n  } catch (error) {\n    console.error('Erreur rcupration SIRET:', error);\n    return null;\n  }\n}\n\n/**\n * Recherche des communes par dpartement\n */\nexport async function searchCommunesByDepartement(\n  departement: string\n): Promise<{ code: string; nom: string }[]> {\n  try {\n    const url = `https://geo.api.gouv.fr/departements/${departement}/communes?fields=nom,code`;\n    const response = await fetch(url);\n\n    if (!response.ok) {\n      return [];\n    }\n\n    const data = await response.json();\n    return data.map((commune: any) => ({\n      code: commune.code,\n      nom: commune.nom\n    })).sort((a: any, b: any) => a.nom.localeCompare(b.nom, 'fr'));\n  } catch (error) {\n    console.error('Erreur recherche communes:', error);\n    return [];\n  }\n}\n\n/**\n * Suggestions d'activits NAF\n */\nexport function searchNafCodes(query: string): { code: string; label: string }[] {\n  const queryLower = query.toLowerCase();\n\n  return Object.entries(NAF_TYPES)\n    .filter(([code, label]) =>\n      code.toLowerCase().includes(queryLower) ||\n      label.toLowerCase().includes(queryLower)\n    )\n    .map(([code, label]) => ({ code, label }))\n    .slice(0, 10);\n}\n","// ============================================================================\n// Panneau de recherche INSEE (API Recherche Entreprises)\n// ============================================================================\n\nimport type { Location } from '../../types';\nimport type { INSEEResult } from '../../types';\nimport { searchSirene, getDepartments, getNafCodesByDomain } from '../../services/insee.service';\nimport { showToast } from '../UI/Toast';\n\nexport interface InseeSearchPanelOptions {\n  onAdd: (location: Location) => void;\n}\n\n/**\n * Cre le panneau de recherche INSEE\n */\nexport function createInseeSearchPanel(container: HTMLElement, options: InseeSearchPanelOptions): void {\n  const { onAdd } = options;\n  const departments = getDepartments();\n\n  container.innerHTML = `\n    <div class=\"admin-insee-panel\">\n      <div class=\"admin-insee-header\">\n        <h3><i class=\"fas fa-building\"></i> Recherche INSEE</h3>\n        <p>Recherchez des tablissements dans la base de donnes officielle des entreprises franaises.</p>\n      </div>\n\n      <div class=\"admin-insee-form\">\n        <div class=\"admin-form-row\">\n          <div class=\"admin-form-group\">\n            <label for=\"inseeDept\"><i class=\"fas fa-map\"></i> Dpartement *</label>\n            <select id=\"inseeDept\" class=\"admin-input\" required>\n              ${departments.map(d => `<option value=\"${d.code}\">${d.code} - ${d.nom}</option>`).join('')}\n            </select>\n          </div>\n\n          <div class=\"admin-form-group\">\n            <label for=\"inseeDomain\"><i class=\"fas fa-utensils\"></i> Domaine</label>\n            <select id=\"inseeDomain\" class=\"admin-input\">\n              <option value=\"all\">Tous les domaines</option>\n              <option value=\"restauration\">Restauration</option>\n              <option value=\"hotellerie\">Htellerie</option>\n              <option value=\"commerce\">Commerce alimentaire</option>\n            </select>\n          </div>\n        </div>\n\n        <div class=\"admin-form-row\">\n          <div class=\"admin-form-group admin-form-group-large\">\n            <label for=\"inseeCity\"><i class=\"fas fa-city\"></i> Ville (optionnel)</label>\n            <input type=\"text\" id=\"inseeCity\" class=\"admin-input\" placeholder=\"Ex: Niort, Parthenay...\">\n          </div>\n\n          <div class=\"admin-form-group\">\n            <label for=\"inseeLimit\"><i class=\"fas fa-list-ol\"></i> Rsultats max</label>\n            <select id=\"inseeLimit\" class=\"admin-input\">\n              <option value=\"10\">10</option>\n              <option value=\"25\" selected>25</option>\n              <option value=\"50\">50</option>\n              <option value=\"100\">100</option>\n            </select>\n          </div>\n        </div>\n\n        <div class=\"admin-form-actions\">\n          <button type=\"button\" class=\"admin-btn admin-btn-primary\" id=\"inseeSearchBtn\">\n            <i class=\"fas fa-search\"></i> Rechercher\n          </button>\n        </div>\n      </div>\n\n      <div class=\"admin-insee-results\" id=\"inseeResults\" style=\"display: none;\">\n        <div class=\"admin-insee-results-header\">\n          <h4><i class=\"fas fa-list\"></i> Rsultats (<span id=\"inseeResultsCount\">0</span>)</h4>\n          <button type=\"button\" class=\"admin-btn admin-btn-sm admin-btn-secondary\" id=\"inseeAddAllBtn\">\n            <i class=\"fas fa-plus-circle\"></i> Tout ajouter\n          </button>\n        </div>\n        <div class=\"admin-insee-results-list\" id=\"inseeResultsList\"></div>\n      </div>\n\n      <div class=\"admin-insee-loading\" id=\"inseeLoading\" style=\"display: none;\">\n        <i class=\"fas fa-spinner fa-spin\"></i>\n        <span>Recherche en cours...</span>\n      </div>\n\n      <div class=\"admin-insee-empty\" id=\"inseeEmpty\" style=\"display: none;\">\n        <i class=\"fas fa-search\"></i>\n        <span>Aucun rsultat trouv. Essayez d'largir vos critres de recherche.</span>\n      </div>\n    </div>\n  `;\n\n  // Elements\n  const deptSelect = container.querySelector('#inseeDept') as HTMLSelectElement;\n  const domainSelect = container.querySelector('#inseeDomain') as HTMLSelectElement;\n  const cityInput = container.querySelector('#inseeCity') as HTMLInputElement;\n  const limitSelect = container.querySelector('#inseeLimit') as HTMLSelectElement;\n  const searchBtn = container.querySelector('#inseeSearchBtn') as HTMLButtonElement;\n  const resultsSection = container.querySelector('#inseeResults') as HTMLElement;\n  const resultsCount = container.querySelector('#inseeResultsCount') as HTMLElement;\n  const resultsList = container.querySelector('#inseeResultsList') as HTMLElement;\n  const loadingSection = container.querySelector('#inseeLoading') as HTMLElement;\n  const emptySection = container.querySelector('#inseeEmpty') as HTMLElement;\n  const addAllBtn = container.querySelector('#inseeAddAllBtn') as HTMLButtonElement;\n\n  let currentResults: INSEEResult[] = [];\n\n  // Search handler\n  searchBtn.addEventListener('click', async () => {\n    const departement = deptSelect.value;\n    const domain = domainSelect.value as 'all' | 'restauration' | 'hotellerie' | 'commerce';\n    const commune = cityInput.value.trim();\n    const limit = parseInt(limitSelect.value, 10);\n\n    // Get NAF codes for selected domain\n    const codeNaf = getNafCodesByDomain(domain);\n\n    // Show loading\n    searchBtn.disabled = true;\n    searchBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin\"></i> Recherche...';\n    resultsSection.style.display = 'none';\n    emptySection.style.display = 'none';\n    loadingSection.style.display = 'flex';\n\n    try {\n      currentResults = await searchSirene({\n        departement,\n        commune: commune || undefined,\n        codeNaf,\n        limit\n      });\n\n      if (currentResults.length === 0) {\n        emptySection.style.display = 'flex';\n        resultsSection.style.display = 'none';\n      } else {\n        renderResults(currentResults);\n        resultsSection.style.display = 'block';\n        emptySection.style.display = 'none';\n      }\n    } catch (error) {\n      console.error('Erreur recherche INSEE:', error);\n      showToast({ message: 'Erreur lors de la recherche', type: 'error' });\n      emptySection.style.display = 'flex';\n    }\n\n    loadingSection.style.display = 'none';\n    searchBtn.disabled = false;\n    searchBtn.innerHTML = '<i class=\"fas fa-search\"></i> Rechercher';\n  });\n\n  // Render results\n  function renderResults(results: INSEEResult[]) {\n    resultsCount.textContent = String(results.length);\n\n    resultsList.innerHTML = results.map((result, index) => `\n      <div class=\"admin-insee-result-item\" data-index=\"${index}\">\n        <div class=\"admin-insee-result-info\">\n          <div class=\"admin-insee-result-name\">${escapeHtml(result.nom)}</div>\n          <div class=\"admin-insee-result-address\">\n            ${escapeHtml(result.adresse || 'Adresse non renseigne')},\n            ${escapeHtml(result.codePostal)} ${escapeHtml(result.ville)}\n          </div>\n          <div class=\"admin-insee-result-meta\">\n            <span class=\"admin-insee-result-type\"><i class=\"fas fa-tag\"></i> ${escapeHtml(result.type)}</span>\n            ${result.lat && result.lon ? '<span class=\"admin-insee-result-geo\"><i class=\"fas fa-map-marker-alt\"></i> Golocalis</span>' : ''}\n            <span class=\"admin-insee-result-siret\"><i class=\"fas fa-barcode\"></i> ${escapeHtml(result.siret)}</span>\n          </div>\n        </div>\n        <button type=\"button\" class=\"admin-btn admin-btn-sm admin-btn-primary insee-add-btn\" data-index=\"${index}\">\n          <i class=\"fas fa-plus\"></i> Ajouter\n        </button>\n      </div>\n    `).join('');\n\n    // Add click handlers for individual add buttons\n    resultsList.querySelectorAll('.insee-add-btn').forEach(btn => {\n      btn.addEventListener('click', (e) => {\n        const index = parseInt((e.currentTarget as HTMLElement).dataset.index || '0', 10);\n        addResult(index);\n        // Mark as added\n        const item = resultsList.querySelector(`[data-index=\"${index}\"]`);\n        if (item) {\n          item.classList.add('added');\n          (btn as HTMLButtonElement).disabled = true;\n          (btn as HTMLButtonElement).innerHTML = '<i class=\"fas fa-check\"></i> Ajout';\n        }\n      });\n    });\n  }\n\n  // Add single result\n  function addResult(index: number) {\n    const result = currentResults[index];\n    if (!result) return;\n\n    const location: Location = {\n      nom: result.nom,\n      adresse: result.adresse || '',\n      codePostal: result.codePostal,\n      ville: result.ville,\n      type: result.type,\n      niveau: '',\n      telephone: '',\n      email: '',\n      contact: '',\n      commentaire: `SIRET: ${result.siret}`,\n      lat: result.lat || null,\n      lon: result.lon || null\n    };\n\n    onAdd(location);\n    showToast({ message: `${result.nom} ajout`, type: 'success' });\n  }\n\n  // Add all results\n  addAllBtn.addEventListener('click', () => {\n    let added = 0;\n    currentResults.forEach((result, index) => {\n      const item = resultsList.querySelector(`[data-index=\"${index}\"]`);\n      if (item && !item.classList.contains('added')) {\n        addResult(index);\n        item.classList.add('added');\n        const btn = item.querySelector('.insee-add-btn') as HTMLButtonElement;\n        if (btn) {\n          btn.disabled = true;\n          btn.innerHTML = '<i class=\"fas fa-check\"></i> Ajout';\n        }\n        added++;\n      }\n    });\n\n    if (added > 0) {\n      showToast({ message: `${added} lieu${added > 1 ? 'x' : ''} ajout${added > 1 ? 's' : ''}`, type: 'success' });\n    }\n  });\n}\n\n/**\n * chappe le HTML\n */\nfunction escapeHtml(text: string): string {\n  if (!text) return '';\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n","// ============================================================================\n// Panneau principal d'administration\n// ============================================================================\n\nimport type { Location } from '../../types';\nimport { store, setLocations, emit } from '../../store';\nimport { addLocation, updateLocation, removeLocation, getAllLocations } from '../../services/data.service';\nimport { showToast } from '../UI/Toast';\nimport { requireAuth, logout, createChangeCodeForm } from './AdminAuth';\nimport { createLocationForm } from './LocationForm';\nimport { createLocationList } from './LocationList';\nimport { createImportPanel } from './ImportPanel';\nimport { createInseeSearchPanel } from './InseeSearchPanel';\nimport { refreshMarkers, focusOnMarker } from '../Map/Map';\n\ntype Tab = 'add' | 'insee' | 'import' | 'manage' | 'settings';\n\nlet currentTab: Tab = 'add';\nlet editingIndex: number | undefined = undefined;\nlet modalElement: HTMLElement | null = null;\n\n/**\n * Ouvre le panneau d'administration\n */\nexport function openAdminPanel(): void {\n  requireAuth(() => {\n    createAdminModal();\n  });\n}\n\n/**\n * Ferme le panneau d'administration\n */\nexport function closeAdminPanel(): void {\n  if (modalElement) {\n    modalElement.classList.add('closing');\n    setTimeout(() => {\n      modalElement?.remove();\n      modalElement = null;\n    }, 300);\n  }\n}\n\n/**\n * Cre le modal d'administration\n */\nfunction createAdminModal(): void {\n  // Remove existing modal if any\n  if (modalElement) {\n    modalElement.remove();\n  }\n\n  modalElement = document.createElement('div');\n  modalElement.className = 'admin-modal-overlay';\n  modalElement.innerHTML = `\n    <div class=\"admin-modal\">\n      <div class=\"admin-modal-header\">\n        <h2><i class=\"fas fa-cog\"></i> Administration des Lieux de Stage</h2>\n        <button type=\"button\" class=\"admin-modal-close\" id=\"closeAdminBtn\">\n          <i class=\"fas fa-times\"></i>\n        </button>\n      </div>\n\n      <nav class=\"admin-tabs\">\n        <button type=\"button\" class=\"admin-tab ${currentTab === 'add' ? 'active' : ''}\" data-tab=\"add\">\n          <i class=\"fas fa-plus-circle\"></i>\n          <span>Ajouter</span>\n        </button>\n        <button type=\"button\" class=\"admin-tab ${currentTab === 'insee' ? 'active' : ''}\" data-tab=\"insee\">\n          <i class=\"fas fa-building\"></i>\n          <span>INSEE</span>\n        </button>\n        <button type=\"button\" class=\"admin-tab ${currentTab === 'import' ? 'active' : ''}\" data-tab=\"import\">\n          <i class=\"fas fa-file-import\"></i>\n          <span>Importer</span>\n        </button>\n        <button type=\"button\" class=\"admin-tab ${currentTab === 'manage' ? 'active' : ''}\" data-tab=\"manage\">\n          <i class=\"fas fa-list\"></i>\n          <span>Grer</span>\n        </button>\n        <button type=\"button\" class=\"admin-tab ${currentTab === 'settings' ? 'active' : ''}\" data-tab=\"settings\">\n          <i class=\"fas fa-cog\"></i>\n          <span>Paramtres</span>\n        </button>\n      </nav>\n\n      <div class=\"admin-content\" id=\"adminContent\">\n        <!-- Content will be rendered here -->\n      </div>\n    </div>\n  `;\n\n  document.body.appendChild(modalElement);\n\n  // Setup events\n  const closeBtn = modalElement.querySelector('#closeAdminBtn') as HTMLButtonElement;\n  closeBtn.addEventListener('click', closeAdminPanel);\n\n  // Close on backdrop click\n  modalElement.addEventListener('click', (e) => {\n    if (e.target === modalElement) {\n      closeAdminPanel();\n    }\n  });\n\n  // Tab navigation\n  modalElement.querySelectorAll('.admin-tab').forEach(tab => {\n    tab.addEventListener('click', () => {\n      const newTab = (tab as HTMLElement).dataset.tab as Tab;\n      switchTab(newTab);\n    });\n  });\n\n  // Keyboard shortcut to close\n  const handleKeydown = (e: KeyboardEvent) => {\n    if (e.key === 'Escape') {\n      closeAdminPanel();\n      document.removeEventListener('keydown', handleKeydown);\n    }\n  };\n  document.addEventListener('keydown', handleKeydown);\n\n  // Render initial tab\n  renderTab(currentTab);\n}\n\n/**\n * Change d'onglet\n */\nfunction switchTab(tab: Tab): void {\n  currentTab = tab;\n  editingIndex = undefined;\n\n  // Update tab buttons\n  modalElement?.querySelectorAll('.admin-tab').forEach(btn => {\n    btn.classList.toggle('active', (btn as HTMLElement).dataset.tab === tab);\n  });\n\n  renderTab(tab);\n}\n\n/**\n * Affiche le contenu de l'onglet\n */\nfunction renderTab(tab: Tab): void {\n  const content = modalElement?.querySelector('#adminContent') as HTMLElement;\n  if (!content) return;\n\n  switch (tab) {\n    case 'add':\n      renderAddTab(content);\n      break;\n    case 'insee':\n      renderInseeTab(content);\n      break;\n    case 'import':\n      renderImportTab(content);\n      break;\n    case 'manage':\n      renderManageTab(content);\n      break;\n    case 'settings':\n      renderSettingsTab(content);\n      break;\n  }\n}\n\n/**\n * Onglet Ajouter\n */\nfunction renderAddTab(content: HTMLElement): void {\n  const locationToEdit = editingIndex !== undefined ? store.locations[editingIndex] : undefined;\n\n  createLocationForm(content, {\n    location: locationToEdit,\n    index: editingIndex,\n    onSave: (location, index) => {\n      if (index !== undefined) {\n        // Update existing\n        updateLocation(index, location);\n        syncStore();\n        showToast({ message: 'Lieu modifi avec succs', type: 'success' });\n      } else {\n        // Add new\n        addLocation(location);\n        syncStore();\n        showToast({ message: 'Lieu ajout avec succs', type: 'success' });\n      }\n      editingIndex = undefined;\n      renderAddTab(content);\n    },\n    onCancel: () => {\n      editingIndex = undefined;\n      if (editingIndex !== undefined) {\n        switchTab('manage');\n      }\n    }\n  });\n}\n\n/**\n * Onglet Recherche INSEE\n */\nfunction renderInseeTab(content: HTMLElement): void {\n  createInseeSearchPanel(content, {\n    onAdd: (location) => {\n      addLocation(location);\n      syncStore();\n    }\n  });\n}\n\n/**\n * Onglet Importer\n */\nfunction renderImportTab(content: HTMLElement): void {\n  createImportPanel(content, {\n    onImport: (locations) => {\n      let added = 0;\n      for (const loc of locations) {\n        addLocation(loc);\n        added++;\n      }\n      syncStore();\n      showToast({\n        message: `${added} lieu${added > 1 ? 'x' : ''} import${added > 1 ? 's' : ''} avec succs`,\n        type: 'success'\n      });\n      switchTab('manage');\n    },\n    onCancel: () => {\n      // Stay on import tab\n    }\n  });\n}\n\n/**\n * Onglet Grer\n */\nfunction renderManageTab(content: HTMLElement): void {\n  createLocationList(content, {\n    onEdit: (index) => {\n      editingIndex = index;\n      switchTab('add');\n    },\n    onDelete: (indices) => {\n      // Delete from highest to lowest to maintain indices\n      indices.sort((a, b) => b - a).forEach(index => {\n        removeLocation(index);\n      });\n      syncStore();\n      showToast({\n        message: `${indices.length} lieu${indices.length > 1 ? 'x' : ''} supprim${indices.length > 1 ? 's' : ''}`,\n        type: 'success'\n      });\n      // Trigger re-render\n      window.dispatchEvent(new CustomEvent('admin-data-changed'));\n    },\n    onLocate: (index) => {\n      closeAdminPanel();\n      setTimeout(() => {\n        focusOnMarker(index, { zoom: 15, openPopup: true });\n      }, 300);\n    }\n  });\n}\n\n/**\n * Onglet Paramtres\n */\nfunction renderSettingsTab(content: HTMLElement): void {\n  content.innerHTML = `\n    <div class=\"admin-settings\">\n      <div class=\"admin-settings-section\">\n        <h3><i class=\"fas fa-key\"></i> Scurit</h3>\n        <div id=\"changeCodeContainer\"></div>\n      </div>\n\n      <div class=\"admin-settings-section\">\n        <h3><i class=\"fas fa-download\"></i> Export des donnes</h3>\n        <p class=\"admin-settings-desc\">Tlchargez toutes les donnes au format JSON pour sauvegarde.</p>\n        <button type=\"button\" class=\"admin-btn admin-btn-secondary\" id=\"exportDataBtn\">\n          <i class=\"fas fa-download\"></i> Exporter les donnes (JSON)\n        </button>\n      </div>\n\n      <div class=\"admin-settings-section\">\n        <h3><i class=\"fas fa-chart-bar\"></i> Statistiques</h3>\n        <div class=\"admin-stats-grid\" id=\"statsGrid\">\n          <!-- Stats will be rendered here -->\n        </div>\n      </div>\n\n      <div class=\"admin-settings-section\">\n        <h3><i class=\"fas fa-sign-out-alt\"></i> Session</h3>\n        <p class=\"admin-settings-desc\">Dconnectez-vous de l'interface d'administration.</p>\n        <button type=\"button\" class=\"admin-btn admin-btn-danger\" id=\"logoutBtn\">\n          <i class=\"fas fa-sign-out-alt\"></i> Se dconnecter\n        </button>\n      </div>\n    </div>\n  `;\n\n  // Change code form\n  const changeCodeContainer = content.querySelector('#changeCodeContainer') as HTMLElement;\n  createChangeCodeForm(changeCodeContainer);\n\n  // Export data\n  const exportBtn = content.querySelector('#exportDataBtn') as HTMLButtonElement;\n  exportBtn.addEventListener('click', () => {\n    const data = getAllLocations();\n    const json = JSON.stringify(data, null, 2);\n    const blob = new Blob([json], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `lieux-stage-${new Date().toISOString().split('T')[0]}.json`;\n    a.click();\n    URL.revokeObjectURL(url);\n    showToast({ message: 'Donnes exportes', type: 'success' });\n  });\n\n  // Stats\n  renderStats(content.querySelector('#statsGrid') as HTMLElement);\n\n  // Logout\n  const logoutBtn = content.querySelector('#logoutBtn') as HTMLButtonElement;\n  logoutBtn.addEventListener('click', () => {\n    logout();\n    closeAdminPanel();\n    showToast({ message: 'Dconnexion russie', type: 'info' });\n  });\n}\n\n/**\n * Affiche les statistiques\n */\nfunction renderStats(container: HTMLElement): void {\n  const locations = store.locations;\n  const totalLocations = locations.length;\n  const geolocated = locations.filter(l => l.lat !== null && l.lon !== null).length;\n  const uniqueCities = new Set(locations.map(l => l.ville)).size;\n  const uniqueTypes = new Set(locations.map(l => l.type)).size;\n\n  container.innerHTML = `\n    <div class=\"admin-stat-card\">\n      <i class=\"fas fa-map-marker-alt\"></i>\n      <div class=\"admin-stat-value\">${totalLocations}</div>\n      <div class=\"admin-stat-label\">Lieux de stage</div>\n    </div>\n    <div class=\"admin-stat-card\">\n      <i class=\"fas fa-crosshairs\"></i>\n      <div class=\"admin-stat-value\">${geolocated}</div>\n      <div class=\"admin-stat-label\">Golocaliss</div>\n    </div>\n    <div class=\"admin-stat-card\">\n      <i class=\"fas fa-city\"></i>\n      <div class=\"admin-stat-value\">${uniqueCities}</div>\n      <div class=\"admin-stat-label\">Villes</div>\n    </div>\n    <div class=\"admin-stat-card\">\n      <i class=\"fas fa-tags\"></i>\n      <div class=\"admin-stat-value\">${uniqueTypes}</div>\n      <div class=\"admin-stat-label\">Types</div>\n    </div>\n  `;\n}\n\n/**\n * Synchronise le store avec les donnes du service\n */\nfunction syncStore(): void {\n  const locations = getAllLocations();\n  setLocations(locations);\n  refreshMarkers();\n}\n","// ============================================================================\n// Point d'entre principal de l'application - Carte des Lieux de Stage\n// ============================================================================\n\nimport { store, initializeStore, setLocations, on, updateFilters } from './store';\nimport { loadData } from './services/data.service';\nimport { createThemeToggle, initTheme } from './components/UI/ThemeToggle';\nimport { showToast, initToastContainer } from './components/UI/Toast';\nimport { initMap, refreshMarkers, fitToMarkers, invalidateSize, toggleHeatmap, focusOnMarker } from './components/Map/Map';\nimport { openAdminPanel } from './components/Admin';\n\n// Import des styles\nimport './styles/main.css';\n\n// ============================================================================\n// Initialisation de l'application\n// ============================================================================\n\nasync function initApp(): Promise<void> {\n  console.log(' Initialisation de l\\'application...');\n\n  try {\n    // Initialiser le conteneur de toasts\n    initToastContainer();\n\n    // Initialiser le store avec l'tat persist\n    await initializeStore();\n\n    // Initialiser le thme\n    initTheme();\n\n    // Crer la structure de l'application\n    createAppLayout();\n\n    // Charger les donnes\n    await loadDataAndInitialize();\n\n    // Configurer les vnements globaux\n    setupGlobalEvents();\n\n    // Masquer l'overlay de chargement\n    hideLoadingOverlay();\n\n    console.log(' Application initialise avec succs');\n  } catch (error) {\n    console.error(' Erreur lors de l\\'initialisation:', error);\n    showToast({\n      message: 'Erreur lors du chargement de l\\'application',\n      type: 'error',\n      duration: 5000\n    });\n    hideLoadingOverlay();\n  }\n}\n\n/**\n * Cre la structure de l'application\n */\nfunction createAppLayout(): void {\n  const container = document.querySelector('.container');\n  if (!container) {\n    console.error('Container principal non trouv');\n    return;\n  }\n\n  // Nettoyer le container existant (legacy)\n  const existingSidebar = container.querySelector('.sidebar');\n  if (existingSidebar) {\n    // Garder la structure existante pour la compatibilit\n    // Le composant Sidebar moderne sera intgr progressivement\n  }\n\n  // Crer le toggle de thme dans le header\n  const headerRight = document.querySelector('.header-right');\n  if (headerRight) {\n    const themeContainer = document.createElement('div');\n    themeContainer.className = 'theme-toggle-container';\n    headerRight.prepend(themeContainer);\n    createThemeToggle(themeContainer);\n  }\n\n  // Initialiser la carte\n  const mapContainer = document.getElementById('map');\n  if (mapContainer) {\n    initMap(mapContainer);\n  }\n}\n\n/**\n * Charge les donnes et initialise les composants\n */\nasync function loadDataAndInitialize(): Promise<void> {\n  // Afficher l'tat de chargement\n  updateLoadingState('Chargement des donnes...');\n\n  // Charger les donnes\n  const locations = await loadData();\n  setLocations(locations);\n\n  // Mettre  jour le compteur\n  updateResultsCount();\n\n  // Rafrachir les marqueurs\n  refreshMarkers();\n\n  // Ajuster la vue\n  setTimeout(() => {\n    fitToMarkers();\n  }, 100);\n\n  showToast({\n    message: `${locations.length} lieux de stage chargs`,\n    type: 'success',\n    duration: 3000\n  });\n}\n\n/**\n * Configure les vnements globaux\n */\nfunction setupGlobalEvents(): void {\n  // couter les changements de filtre\n  on('FILTER_CHANGED', () => {\n    updateResultsCount();\n    renderResultsList();\n  });\n\n  // couter les changements de donnes\n  on('DATA_LOADED', () => {\n    updateResultsCount();\n    renderResultsList();\n  });\n\n  // couter le toggle de la sidebar\n  window.addEventListener('sidebar-toggle', () => {\n    invalidateSize();\n  });\n\n  // couter la demande de localisation sur la carte\n  window.addEventListener('locate-on-map', ((event: CustomEvent) => {\n    const { index } = event.detail;\n    if (index !== undefined) {\n      focusOnMarker(index, { zoom: 15, openPopup: true });\n    }\n  }) as EventListener);\n\n  // couter la slection d'un lieu\n  window.addEventListener('location-selected', ((event: CustomEvent) => {\n    const { index } = event.detail;\n    if (index !== undefined) {\n      highlightResult(index);\n    }\n  }) as EventListener);\n\n  // Grer le redimensionnement\n  window.addEventListener('resize', () => {\n    invalidateSize();\n  });\n\n  // Raccourcis clavier globaux\n  document.addEventListener('keydown', (e) => {\n    // Ctrl/Cmd + K pour focus sur la recherche\n    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {\n      e.preventDefault();\n      const searchInput = document.getElementById('searchInput') as HTMLInputElement;\n      searchInput?.focus();\n    }\n\n    // Escape pour fermer les modales\n    if (e.key === 'Escape') {\n      closeAllModals();\n    }\n\n    // H pour toggle heatmap\n    if (e.key === 'h' && !isInputFocused()) {\n      toggleHeatmap(!store.heatmapEnabled);\n    }\n  });\n\n  // Intgration avec les boutons existants (legacy)\n  setupLegacyIntegration();\n}\n\n/**\n * Intgre les fonctionnalits avec l'interface legacy\n */\nfunction setupLegacyIntegration(): void {\n  // Bouton admin\n  const adminBtn = document.getElementById('adminBtn');\n  if (adminBtn) {\n    adminBtn.addEventListener('click', () => {\n      openAdminPanel();\n    });\n  }\n\n  // Bouton de recherche existant\n  const searchInput = document.getElementById('searchInput') as HTMLInputElement;\n  if (searchInput) {\n    searchInput.addEventListener('input', debounce(() => {\n      updateFilters({ search: searchInput.value });\n    }, 300));\n  }\n\n  // Boutons d'export existants\n  const exportCSV = document.getElementById('exportCSV');\n  const exportJSON = document.getElementById('exportJSON');\n  const exportPDF = document.getElementById('exportPDF');\n\n  if (exportCSV) {\n    exportCSV.addEventListener('click', async () => {\n      const { exportAsCsv } = await import('./services/export.service');\n      await exportAsCsv(store.filteredIndices);\n      showToast({ message: 'Export CSV tlcharg', type: 'success' });\n    });\n  }\n\n  if (exportJSON) {\n    exportJSON.addEventListener('click', async () => {\n      const { exportAsJson } = await import('./services/export.service');\n      await exportAsJson(store.filteredIndices);\n      showToast({ message: 'Export JSON tlcharg', type: 'success' });\n    });\n  }\n\n  if (exportPDF) {\n    exportPDF.addEventListener('click', async () => {\n      const { exportAsPdf } = await import('./services/export.service');\n      await exportAsPdf(store.filteredIndices);\n      showToast({ message: 'Export PDF gnr', type: 'success' });\n    });\n  }\n\n  // Bouton reset\n  const resetBtn = document.getElementById('resetBtn');\n  if (resetBtn) {\n    resetBtn.addEventListener('click', () => {\n      // Reset des filtres dans l'UI\n      if (searchInput) searchInput.value = '';\n      const domaineFilter = document.getElementById('domaineFilter') as HTMLSelectElement;\n      const niveauFilter = document.getElementById('niveauFilter') as HTMLSelectElement;\n      if (domaineFilter) domaineFilter.value = '';\n      if (niveauFilter) niveauFilter.value = '';\n\n      // Reset dans le store\n      updateFilters({\n        search: '',\n        domains: [],\n        levelMin: 1,\n        levelMax: 5,\n        distanceKm: null,\n        referencePoint: null,\n        favoritesOnly: false\n      });\n    });\n  }\n\n  // Connecter le filtre de domaine legacy au store\n  const domaineFilter = document.getElementById('domaineFilter') as HTMLSelectElement;\n  if (domaineFilter) {\n    // Remplir le dropdown avec les types uniques\n    function populateDomainFilter() {\n      const types = store.uniqueTypes;\n      domaineFilter.innerHTML = '<option value=\"\">Tous</option>';\n      types.forEach(type => {\n        const option = document.createElement('option');\n        option.value = type;\n        option.textContent = type;\n        domaineFilter.appendChild(option);\n      });\n    }\n\n    // Mettre  jour le filtre quand la slection change\n    domaineFilter.addEventListener('change', () => {\n      const selectedDomain = domaineFilter.value;\n      updateFilters({\n        domains: selectedDomain ? [selectedDomain] : []\n      });\n    });\n\n    // Remplir initialement et couter les changements de donnes\n    populateDomainFilter();\n    on('DATA_LOADED', populateDomainFilter);\n  }\n\n  // Connecter le filtre de niveau legacy au store\n  const niveauFilter = document.getElementById('niveauFilter') as HTMLSelectElement;\n  if (niveauFilter) {\n    niveauFilter.addEventListener('change', () => {\n      const selectedNiveau = niveauFilter.value;\n      if (selectedNiveau) {\n        updateFilters({\n          levelMin: parseInt(selectedNiveau),\n          levelMax: parseInt(selectedNiveau)\n        });\n      } else {\n        updateFilters({\n          levelMin: 1,\n          levelMax: 5\n        });\n      }\n    });\n  }\n}\n\n/**\n * Met  jour le compteur de rsultats\n */\nfunction updateResultsCount(): void {\n  const countEl = document.getElementById('resultsCount');\n  if (!countEl) return;\n\n  const total = store.locations.length;\n  const filtered = store.filteredIndices.length;\n  const span = countEl.querySelector('span');\n\n  if (span) {\n    if (filtered === total) {\n      span.textContent = `${total} lieu${total > 1 ? 'x' : ''} de stage`;\n    } else {\n      span.textContent = `${filtered} / ${total} lieu${filtered > 1 ? 'x' : ''}`;\n    }\n  }\n}\n\n/**\n * Gnre la liste des rsultats de recherche\n */\nfunction renderResultsList(): void {\n  const listEl = document.getElementById('resultsList');\n  if (!listEl) return;\n\n  const indices = store.filteredIndices;\n\n  // Limiter  50 rsultats pour les performances\n  const maxResults = 50;\n  const displayIndices = indices.slice(0, maxResults);\n\n  if (displayIndices.length === 0) {\n    listEl.innerHTML = `\n      <div class=\"no-results\">\n        <i class=\"fas fa-search\"></i>\n        <p>Aucun rsultat trouv</p>\n      </div>\n    `;\n    return;\n  }\n\n  const html = displayIndices.map(index => {\n    const loc = store.locations[index];\n    const levelColor = getLevelColor(loc.niveau);\n\n    return `\n      <div class=\"result-item\" data-index=\"${index}\">\n        <div class=\"result-item-header\">\n          <span class=\"result-item-name\">${escapeHtml(loc.nom)}</span>\n          ${loc.niveau ? `<span class=\"result-item-niveau\" style=\"background: linear-gradient(135deg, ${levelColor} 0%, ${levelColor} 100%)\">Niv. ${loc.niveau}</span>` : ''}\n        </div>\n        <div class=\"result-item-ville\">\n          <i class=\"fas fa-map-marker-alt\"></i>\n          ${escapeHtml(loc.ville)} (${loc.codePostal})\n        </div>\n        <div class=\"result-item-type\">\n          <i class=\"fas fa-utensils\"></i>\n          ${escapeHtml(loc.type)}\n        </div>\n        <div class=\"result-item-actions\">\n          <button class=\"result-item-btn btn-locate\" title=\"Localiser sur la carte\">\n            <i class=\"fas fa-crosshairs\"></i> Localiser\n          </button>\n          ${loc.telephone ? `\n            <a href=\"tel:${loc.telephone}\" class=\"result-item-btn btn-call\" title=\"Appeler\">\n              <i class=\"fas fa-phone\"></i> Appeler\n            </a>\n          ` : ''}\n        </div>\n      </div>\n    `;\n  }).join('');\n\n  listEl.innerHTML = html;\n\n  // Ajouter un message si plus de rsultats\n  if (indices.length > maxResults) {\n    const moreEl = document.createElement('div');\n    moreEl.className = 'results-more';\n    moreEl.innerHTML = `<p>+ ${indices.length - maxResults} autres rsultats (affiner la recherche)</p>`;\n    listEl.appendChild(moreEl);\n  }\n\n  // Ajouter les vnements de clic\n  listEl.querySelectorAll('.result-item').forEach(item => {\n    const index = parseInt((item as HTMLElement).dataset.index || '-1', 10);\n\n    // Clic sur localiser\n    item.querySelector('.btn-locate')?.addEventListener('click', (e) => {\n      e.stopPropagation();\n      window.dispatchEvent(new CustomEvent('locate-on-map', { detail: { index } }));\n    });\n\n    // Clic sur l'item entier\n    item.addEventListener('click', () => {\n      // Retirer la classe active des autres items\n      listEl.querySelectorAll('.result-item.active').forEach(el => el.classList.remove('active'));\n      item.classList.add('active');\n      window.dispatchEvent(new CustomEvent('locate-on-map', { detail: { index } }));\n    });\n  });\n}\n\n/**\n * Retourne une couleur selon le niveau\n */\nfunction getLevelColor(niveau: string): string {\n  if (!niveau) return '#94a3b8';\n  const match = niveau.match(/(\\d)/);\n  if (!match) return '#94a3b8';\n  const level = parseInt(match[1], 10);\n  const colors = ['#22c55e', '#84cc16', '#eab308', '#f97316', '#8b5cf6'];\n  return colors[level - 1] || '#94a3b8';\n}\n\n/**\n * chappe le HTML pour viter les injections XSS\n */\nfunction escapeHtml(text: string): string {\n  if (!text) return '';\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n\n/**\n * Met en vidence un rsultat dans la liste\n */\nfunction highlightResult(index: number): void {\n  const resultsList = document.getElementById('resultsList');\n  if (!resultsList) return;\n\n  const item = resultsList.querySelector(`[data-index=\"${index}\"]`);\n  if (item) {\n    item.scrollIntoView({ behavior: 'smooth', block: 'center' });\n    item.classList.add('highlight');\n    setTimeout(() => item.classList.remove('highlight'), 2000);\n  }\n}\n\n/**\n * Met  jour le texte de chargement\n */\nfunction updateLoadingState(text: string): void {\n  const loadingText = document.querySelector('.loading-text');\n  if (loadingText) {\n    loadingText.textContent = text;\n  }\n}\n\n/**\n * Masque l'overlay de chargement\n */\nfunction hideLoadingOverlay(): void {\n  const overlay = document.getElementById('loadingOverlay');\n  if (overlay) {\n    overlay.style.opacity = '0';\n    setTimeout(() => {\n      overlay.style.display = 'none';\n    }, 300);\n  }\n}\n\n/**\n * Ferme toutes les modales\n */\nfunction closeAllModals(): void {\n  // Fermer les modales legacy\n  const modals = document.querySelectorAll('.modal-overlay');\n  modals.forEach(modal => {\n    (modal as HTMLElement).style.display = 'none';\n  });\n\n  // Fermer le modal admin si ouvert\n  const adminModal = document.querySelector('.admin-modal-overlay');\n  if (adminModal) {\n    adminModal.classList.add('closing');\n    setTimeout(() => adminModal.remove(), 300);\n  }\n\n  // Fermer le modal d'auth admin si ouvert\n  const authModal = document.querySelector('.admin-auth-modal');\n  if (authModal) {\n    authModal.remove();\n  }\n}\n\n/**\n * Vrifie si un input est actuellement focus\n */\nfunction isInputFocused(): boolean {\n  const active = document.activeElement;\n  return active instanceof HTMLInputElement ||\n         active instanceof HTMLTextAreaElement ||\n         active instanceof HTMLSelectElement;\n}\n\n/**\n * Debounce simple\n */\nfunction debounce<T extends (...args: any[]) => any>(\n  fn: T,\n  delay: number\n): (...args: Parameters<T>) => void {\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\n  return (...args: Parameters<T>) => {\n    if (timeoutId) clearTimeout(timeoutId);\n    timeoutId = setTimeout(() => fn(...args), delay);\n  };\n}\n\n// ============================================================================\n// Lancement de l'application\n// ============================================================================\n\n// Attendre que le DOM soit prt\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', initApp);\n} else {\n  initApp();\n}\n\n// Export pour debug en mode dveloppement\nif (import.meta.env.DEV) {\n  (window as any).__app = {\n    store,\n    refreshMarkers,\n    fitToMarkers,\n    showToast,\n    openAdminPanel\n  };\n}\n"],"file":"assets/main-BpLj65Hl.js"}